<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tashiro Ironworks - Professional OCR System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #007BFF;
            --primary-dark: #0056b3;
            --success-green: #28A745;
            --warning-orange: #FFC107;
            --danger-red: #DC3545;
            --purple: #6F42C1;
            --teal: #20C997;
            --light-gray: #F8F9FA;
            --medium-gray: #E9ECEF;
            --dark-gray: #6C757D;
            --text-dark: #343A40;
            --shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 30px rgba(0, 0, 0, 0.12);
            --border-radius: 12px;
            --gradient-primary: linear-gradient(135deg, #007BFF 0%, #0056b3 100%);
            --gradient-success: linear-gradient(135deg, #28A745 0%, #1e7e34 100%);
            --gradient-warning: linear-gradient(135deg, #FFC107 0%, #e0a800 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: var(--text-dark);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Welcome Modal */
        .welcome-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 480px;
            padding: 40px 32px;
            text-align: center;
            animation: modalSlideIn 0.5s ease-out;
            position: relative;
            overflow: hidden;
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .company-logo {
            display: flex;
            justify-content: center;
            margin-bottom: 24px;
        }

        .logo-circle {
            width: 80px;
            height: 80px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .modal-content h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-dark);
        }

        .modal-subtitle {
            font-size: 16px;
            color: var(--dark-gray);
            margin-bottom: 32px;
        }

        .registration-form {
            text-align: left;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-dark);
        }

        .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--medium-gray);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .required {
            color: var(--danger-red);
        }

        .primary-button {
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 16px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .primary-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 123, 255, 0.4);
        }

        .primary-button:active {
            transform: translateY(0);
        }

        /* Main App Layout */
        .app-container {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Enhanced Header */
        .app-header {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px 24px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .app-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .header-left h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .header-left p {
            color: var(--dark-gray);
            font-size: 14px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            font-size: 16px;
        }

        .user-email {
            font-size: 14px;
            color: var(--dark-gray);
        }

        .profile-actions {
            display: flex;
            gap: 12px;
        }

        .icon-button {
            background: var(--light-gray);
            border: none;
            border-radius: 8px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--dark-gray);
        }

        .icon-button:hover {
            background: var(--primary-blue);
            color: white;
            transform: translateY(-2px);
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        /* Enhanced Cards */
        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 24px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .card-description {
            font-size: 14px;
            color: var(--dark-gray);
        }

        .card-icon {
            font-size: 24px;
            color: var(--primary-blue);
            background: rgba(0, 123, 255, 0.1);
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Upload Section */
        .upload-options {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }

        .upload-button {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px 16px;
            border: 2px dashed var(--medium-gray);
            border-radius: 12px;
            background: var(--light-gray);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .upload-button:hover {
            border-color: var(--primary-blue);
            background: rgba(0, 123, 255, 0.05);
            transform: translateY(-2px);
        }

        .upload-icon {
            font-size: 32px;
            margin-bottom: 12px;
            color: var(--primary-blue);
        }

        .upload-text {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-dark);
        }

        .upload-subtext {
            font-size: 14px;
            color: var(--dark-gray);
            margin-top: 4px;
        }

        .dropzone {
            border: 2px dashed var(--medium-gray);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            background: var(--light-gray);
            transition: all 0.3s;
            margin-top: 16px;
        }

        .dropzone.active {
            border-color: var(--primary-blue);
            background: rgba(0, 123, 255, 0.05);
        }

        .dropzone-icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--dark-gray);
        }

        /* OCR Tips Section */
        .ocr-tips {
            background: var(--light-gray);
            border-radius: 12px;
            padding: 16px 20px;
            margin-top: 16px;
            border-left: 4px solid var(--primary-blue);
        }

        .ocr-tips h4 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ocr-tips h4 i {
            color: var(--primary-blue);
        }

        .ocr-tips ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .ocr-tips li {
            font-size: 14px;
            color: var(--dark-gray);
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }

        .ocr-tips li:before {
            content: "üì±";
            position: absolute;
            left: 0;
            top: 0;
        }

        .ocr-tips li:last-child {
            margin-bottom: 0;
        }

        /* OCR Preview Section */
        .ocr-preview-container {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .preview-image {
            flex: 1;
            min-width: 300px;
            background: var(--light-gray);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .preview-image img {
            width: 100%;
            height: auto;
            max-height: 400px;
            object-fit: contain;
            display: block;
        }

        .preview-placeholder {
            width: 100%;
            height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--dark-gray);
            background: var(--light-gray);
            border-radius: 12px;
        }

        .preview-placeholder i {
            font-size: 64px;
            margin-bottom: 16px;
            color: var(--medium-gray);
        }

        .ocr-results {
            flex: 2;
            min-width: 300px;
        }

        /* Field Mapping Section */
        .field-mapping-header {
            background: var(--gradient-primary);
            color: white;
            padding: 16px 20px;
            border-radius: 12px 12px 0 0;
            margin-bottom: 20px;
        }

        .field-mapping-header h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        /* Global loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1100;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-card {
            background: white;
            padding: 24px 32px;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            text-align: center;
            width: min(90%, 360px);
        }

        .loading-spinner {
            width: 64px;
            height: 64px;
            border: 6px solid var(--light-gray);
            border-top-color: var(--primary-blue);
            border-radius: 50%;
            margin: 0 auto 16px;
            animation: spin 1s linear infinite;
        }

        .loading-message {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .loading-subtext {
            font-size: 14px;
            color: var(--dark-gray);
        }

        .loading-steps {
            margin-top: 16px;
            text-align: left;
            font-size: 13px;
            color: var(--dark-gray);
        }

        .loading-steps li {
            margin-bottom: 6px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .field-mapping-header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .form-field {
            margin-bottom: 0;
        }

        .field-label {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .field-badge {
            display: inline-block;
            background: var(--primary-blue);
            color: white;
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            margin-right: 8px;
            min-width: 24px;
            text-align: center;
        }

        .ai-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: var(--primary-blue);
            background: rgba(0, 123, 255, 0.1);
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
            font-weight: 500;
        }

        .ai-indicator i {
            font-size: 10px;
        }

        .form-field input, .form-field select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--medium-gray);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s;
            background: white;
        }

        .form-field input:focus, .form-field select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        /* Verification Status */
        .verification-status {
            background: var(--gradient-success);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 24px 0;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .verification-status.warning {
            background: var(--gradient-warning);
        }

        .status-icon {
            font-size: 24px;
        }

        .status-content {
            flex: 1;
        }

        .status-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .confidence-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }

        /* Additional Information */
        .additional-info {
            background: var(--light-gray);
            border-radius: 12px;
            padding: 20px;
            margin-top: 24px;
        }

        .additional-info h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-dark);
        }

        .assignment-panel {
            background: var(--pure-white);
            border: 1px solid var(--light-gray);
            border-radius: 12px;
            padding: 20px;
            margin-top: 24px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.04);
        }

        .assignment-panel h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-dark);
        }

        .assignment-panel .panel-hint {
            margin-bottom: 16px;
            color: var(--dark-gray);
            font-size: 14px;
        }

        .save-result {
            margin-top: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            background: rgba(0, 123, 255, 0.08);
            color: var(--text-dark);
            font-size: 14px;
            display: none;
        }

        /* Form Actions */
        .form-actions {
            display: flex;
            gap: 16px;
            margin-top: 24px;
        }

        .secondary-button {
            background: white;
            color: var(--primary-blue);
            border: 2px solid var(--primary-blue);
            border-radius: 8px;
            padding: 14px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
        }

        .secondary-button:hover {
            background: rgba(0, 123, 255, 0.05);
            transform: translateY(-2px);
        }

        /* History Section */
        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--medium-gray);
            transition: background 0.2s;
            gap: 16px;
        }

        .history-item:hover {
            background: var(--light-gray);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }

        .history-details {
            flex: 1;
            min-width: 0;
        }

        .history-vendor {
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-meta {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: var(--dark-gray);
        }

        .history-amount {
            font-weight: 600;
            color: var(--text-dark);
        }

        .history-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-success {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success-green);
        }

        .status-pending {
            background: rgba(255, 193, 7, 0.1);
            color: var(--warning-orange);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--dark-gray);
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 16px;
            color: var(--medium-gray);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }

        .toast {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            animation: toastSlideIn 0.3s ease-out;
            border-left: 4px solid;
        }

        .toast-success { border-left-color: var(--success-green); }
        .toast-error { border-left-color: var(--danger-red); }
        .toast-warning { border-left-color: var(--warning-orange); }
        .toast-info { border-left-color: var(--primary-blue); }

        .toast-icon {
            margin-right: 12px;
            font-size: 20px;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            margin-left: 12px;
            color: var(--dark-gray);
        }

        @keyframes toastSlideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Profile Modal */
        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            padding: 20px;
        }

        /* Phase 5D: Mobile 3-Screen Layout */
        .mobile-screen {
            /* Don't hide on desktop - only manage on mobile */
        }
        
        .mobile-nav {
            display: none;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding-bottom: 70px;
            }
            
            /* Only on mobile: hide non-active screens */
            .mobile-screen {
                display: none;
            }
            
            .mobile-screen.active {
                display: block !important;
            }
            
            /* Mobile 3-Screen Navigation */
            .mobile-nav {
                display: flex;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                border-top: 1px solid #e2e8f0;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
                z-index: 1000;
                padding: 8px;
                padding-bottom: max(8px, env(safe-area-inset-bottom));
            }
            
            .nav-btn {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 4px;
                padding: 8px;
                background: none;
                border: none;
                color: #64748b;
                font-size: 11px;
                cursor: pointer;
                border-radius: 8px;
                transition: all 0.2s;
            }
            
            .nav-btn i {
                font-size: 20px;
            }
            
            .nav-btn.active {
                color: #3b82f6;
                background: #eff6ff;
            }
            
            .nav-btn:disabled {
                opacity: 0.4;
                cursor: not-allowed;
            }
            
            /* Hide desktop cards on mobile, show only active screen */
            .dashboard-grid {
                display: block;
            }
            
            .card {
                margin-bottom: 0;
            }
            
            .mobile-screen:not(.active) {
                display: none !important;
            }
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .upload-options {
                flex-direction: column;
            }
            
            .ocr-preview-container {
                flex-direction: column;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .app-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
            
            .user-profile {
                align-self: flex-end;
            }
            
            .toast-container {
                left: 10px;
                right: 10px;
                max-width: none;
            }
            
            /* Phase 5D: Mobile-first batch upload styles */
            #selectedFilesContainer {
                padding: 12px;
            }
            
            #uploadBatchBtn,
            .primary-button,
            .secondary-button {
                width: 100%;
                padding: 14px;
                font-size: 15px;
            }
            
            #batchReceiptTiles {
                padding: 12px;
            }
            
            /* Phase 5D: Draft modal mobile styles */
            #draftModal > div,
            #sendResultsModal > div {
                margin: 0;
                max-width: 100%;
                width: 100%;
                height: 100vh;
                border-radius: 0;
                max-height: none;
            }
            
            #draftModal,
            #sendResultsModal {
                z-index: 2000;
            }
            
            .draft-filter-btn {
                flex: 1;
                min-width: 70px;
                font-size: 12px;
                padding: 8px 12px;
            }
            
            /* Sticky header and footer in draft modal */
            #draftModal > div > div:first-child,
            #sendResultsModal > div > div:first-child {
                position: sticky;
                top: 0;
                background: white;
                z-index: 10;
            }
            
            #draftModal > div > div:last-child,
            #sendResultsModal > div > div:last-child {
                position: sticky;
                bottom: 0;
                background: #f8fafc;
                z-index: 10;
            }
        }

        /* Mobile-responsive styles for editable table */
        @media (max-width: 768px) {
            .table-container {
                padding: 10px !important;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            #editableTable {
                font-size: 14px;
                min-width: 600px; /* Ensure table doesn't get too cramped */
            }

            #editableTable th,
            #editableTable td {
                padding: 8px 6px !important;
                white-space: nowrap;
            }

            #editableTable th:nth-child(1),
            #editableTable td:nth-child(1) {
                min-width: 120px;
                max-width: 150px;
            }

            #editableTable th:nth-child(2),
            #editableTable td:nth-child(2) {
                min-width: 150px;
            }

            #editableTable th:nth-child(3),
            #editableTable td:nth-child(3) {
                min-width: 80px;
                text-align: center;
            }

            .editable-field {
                font-size: 14px !important;
                padding: 6px !important;
            }

            .table-header {
                flex-direction: column !important;
                gap: 10px !important;
                align-items: stretch !important;
            }

            .table-header h3 {
                font-size: 16px !important;
                margin: 0 !important;
            }

            #saveAccumulationBtn {
                align-self: flex-start !important;
                padding: 10px 16px !important;
                font-size: 14px !important;
            }
        }

        @media (max-width: 480px) {
            #editableTable {
                font-size: 12px;
                min-width: 500px;
            }

            #editableTable th,
            #editableTable td {
                padding: 6px 4px !important;
            }

            .editable-field {
                font-size: 12px !important;
                padding: 4px !important;
            }

            .table-header h3 {
                font-size: 14px !important;
            }

            #saveAccumulationBtn {
                width: 100% !important;
                padding: 12px !important;
                font-size: 14px !important;
            }
        }
    </style>
</head>
<body>
    <!-- Welcome Modal -->
    <div id="welcomeModal" class="welcome-modal">
        <div class="modal-content">
            <div class="company-logo">
                <div class="logo-circle">
                    <i class="fas fa-industry"></i>
                </div>
            </div>
            <h1>Tashiro Ironworks Co., Ltd.</h1>
            <p class="modal-subtitle">Professional Receipt OCR Automation System</p>
            
            <form id="registrationForm" class="registration-form">
                <div class="form-group">
                    <label for="userName">Full Name <span class="required">*</span></label>
                    <input type="text" id="userName" name="userName" placeholder="Enter your full name" required autocomplete="name">
                </div>
                
                <div class="form-group">
                    <label for="loginIdentifier">Login ID or Email <span class="required">*</span></label>
                    <input type="text" id="loginIdentifier" name="loginIdentifier" placeholder="TIW-##### or your.email@company.com" required autocomplete="username">
                    <p style="font-size: 12px; color: #64748b; margin-top: 4px;">Enter your Login ID (e.g., TIW-#####) or email address</p>
                </div>
                
                <div class="form-group">
                    <label for="password">Password <span class="required">*</span></label>
                    <input type="password" id="password" name="password" placeholder="Enter your password" required autocomplete="current-password">
                </div>
                
                <button type="submit" id="launchSystemBtn" name="launchSystemBtn" class="primary-button">
                    <i class="fas fa-rocket"></i> Launch OCR System
                </button>
            </form>
        </div>
    </div>

    <!-- Global Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" aria-live="polite">
        <div class="loading-card">
            <div class="loading-spinner" role="status" aria-label="Processing receipt"></div>
            <div class="loading-message" id="loadingMessage">Processing receipt‚Ä¶</div>
            <div class="loading-subtext" id="loadingSubtext">Running OCR engines‚Ä¶</div>
            <ul class="loading-steps">
                <li id="loadingStepUpload">1. Uploading image‚Ä¶</li>
                <li id="loadingStepQueue">2. Waiting for OCR engines‚Ä¶</li>
                <li id="loadingStepExtraction">3. Extracting fields‚Ä¶</li>
            </ul>
        </div>
    </div>

    <!-- Profile Update Modal -->
    <div id="profileModal" class="profile-modal">
        <div class="modal-content">
            <div class="company-logo">
                <div class="logo-circle">
                    <i class="fas fa-user-edit"></i>
                </div>
            </div>
            <h1>Update Profile</h1>
            <p class="modal-subtitle">Keep your information up to date</p>
            
            <form id="profileForm" class="registration-form">
                <div class="form-group">
                    <label for="updateUserName">Full Name <span class="required">*</span></label>
                    <input type="text" id="updateUserName" name="updateUserName" placeholder="Enter your full name" required autocomplete="name">
                </div>
                
                <div class="form-group">
                    <label for="updateUserEmail">Email Address (Optional)</label>
                    <input type="email" id="updateUserEmail" name="updateUserEmail" placeholder="your.email@company.com" autocomplete="email">
                </div>
                
                <div class="form-group">
                    <label for="updateEmployeeId">Login ID <span class="required">*</span></label>
                    <input type="text" id="updateEmployeeId" name="updateEmployeeId" placeholder="PY-V48XE" required autocomplete="off">
                </div>
                
                <div class="form-actions">
                    <button type="submit" id="updateProfileBtn" name="updateProfileBtn" class="primary-button">
                        <i class="fas fa-save"></i> Update Profile
                    </button>
                    <button type="button" class="secondary-button" id="cancelProfileUpdate">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="profile-modal">
        <div class="modal-content">
            <div class="company-logo">
                <div class="logo-circle">
                    <i class="fas fa-cog"></i>
                </div>
            </div>
            <h1>App Settings</h1>
            <p class="modal-subtitle">Customize your experience</p>
            
            <div class="registration-form">
                <div class="form-group">
                    <label for="themeToggle">Theme</label>
                    <select id="themeToggle" name="themeToggle">
                        <option value="light">Light Mode</option>
                        <option value="dark">Dark Mode</option>
                        <option value="auto">Auto (System)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="languageSelect">Language</label>
                    <select id="languageSelect" name="languageSelect">
                        <option value="en">English</option>
                        <option value="ja">Êó•Êú¨Ë™û (Japanese)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="ocrEngineSelect">OCR Engine</label>
                    <select id="ocrEngineSelect" name="ocrEngineSelect">
                        <option value="auto">Hybrid (Auto)</option>
                        <option value="standard">Standard Engines</option>
                        <option value="document_ai">Document AI Preview</option>
                    </select>
                    <p style="font-size: 12px; color: #64748b; margin-top: 4px;">Choose engine for this device. Default: Hybrid (Auto).</p>
                </div>
                
                <div class="form-group">
                    <label for="notificationToggle">Notifications</label>
                    <select id="notificationToggle" name="notificationToggle">
                        <option value="all">All Notifications</option>
                        <option value="important">Important Only</option>
                        <option value="none">Disabled</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="autoSaveToggle">Auto-save Forms</label>
                    <select id="autoSaveToggle" name="autoSaveToggle">
                        <option value="enabled">Enabled</option>
                        <option value="disabled">Disabled</option>
                    </select>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="primary-button" id="saveSettings">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                    <button type="button" class="secondary-button" id="cancelSettings">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="appContainer" class="app-container">
        <!-- Enhanced Header -->
        <header class="app-header">
            <div class="header-left">
                <h1>Receipt OCR Automation System</h1>
                <p>Tashiro Ironworks Co., Ltd.</p>
            </div>
            
            <div class="user-profile">
                <div class="user-info">
                    <div class="user-name" id="displayUserName">Guest User</div>
                    <div class="user-email" id="displayUserEmail">guest@example.com</div>
                </div>
                <div class="profile-actions">
                    <button class="icon-button" id="openDraftsBtn" title="Drafts">
                        <i class="fas fa-file-alt"></i>
                    </button>
                    <button class="icon-button" id="profileButton" title="Update Profile">
                        <i class="fas fa-user-edit"></i>
                    </button>
                    <button class="icon-button" id="settingsButton" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
                <div class="user-avatar" id="userAvatar">GU</div>
            </div>
        </header>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Capture Card -->
            <div class="card" id="captureCard">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">Capture Receipt</h2>
                        <p class="card-description">Take a photo or upload an existing receipt image</p>
                    </div>
                    <div class="card-icon">
                        <i class="fas fa-camera"></i>
                    </div>
                </div>
                <section id="screenCapture" class="mobile-screen active">
                
                <div class="upload-options">
                    <div class="upload-button" id="cameraButton">
                        <i class="fas fa-camera upload-icon"></i>
                        <div class="upload-text">Take Photo</div>
                        <div class="upload-subtext">Use device camera</div>
                    </div>
                    
                    <div class="upload-button" id="uploadButton">
                        <i class="fas fa-file-upload upload-icon"></i>
                        <div class="upload-text">Upload Files</div>
                        <div class="upload-subtext">Up to 4 receipts</div>
                    </div>
                </div>
                
                <!-- Phase 5D: Pending Files Preview Tiles -->
                <div id="pendingFilesContainer" style="display: none; margin-top: 16px; padding: 16px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="font-weight: 600; color: #1e293b;"><i class="fas fa-images"></i> Ready for OCR (<span id="pendingFileCount">0</span>/4)</span>
                        <button id="clearPendingBtn" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 14px; padding: 4px 8px;">
                            <i class="fas fa-times"></i> Clear All
                        </button>
                    </div>
                    <div id="pendingFilesTiles" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 16px;"></div>
                    <button id="startOcrBtn" class="primary-button" style="width: 100%; margin-top: 8px;">
                        <i class="fas fa-magic"></i> Start OCR Processing
                    </button>
                </div>
                
                <div class="dropzone" id="dropzone">
                    <i class="fas fa-cloud-upload-alt dropzone-icon"></i>
                    <p>Drag & drop receipt image here</p>
                    <p class="upload-subtext">or use the options above</p>
                </div>
                
                <!-- OCR Tips Section -->
                <div class="ocr-tips" id="ocrTips">
                    <h4><i class="fas fa-lightbulb"></i> üì∏ Quick Tips for Better OCR</h4>
                    <ul>
                        <li>Ensure good lighting and avoid shadows</li>
                        <li>Hold camera steady and keep receipt flat</li>
                        <li>Include all receipt edges in the photo</li>
                        <li>Avoid blurry or distorted images</li>
                        <li>Supported formats: JPG, PNG (max 5MB)</li>
                        <li><strong>Phase 5D: Upload up to 4 receipts at once</strong></li>
                    </ul>
                </div>
                
                <input type="file" id="fileInput" accept="image/*" multiple capture="environment" style="display: none;">
                </section>
            </div>

            <!-- OCR Review Card -->
            <div class="card" id="reviewCard">
                <section id="screenReview" class="mobile-screen">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">OCR Review & Verification</h2>
                        <p class="card-description">Verify extracted data and submit to HQ</p>
                    </div>
                    <div class="card-icon">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
                
                <!-- Phase 5D: Batch Receipt Tiles -->
                <div id="batchReceiptTiles" style="display: none; margin-bottom: 20px; padding: 16px; background: #f8fafc; border-radius: 8px;">
                    <h4 style="margin: 0 0 12px 0; color: #1e293b; font-size: 14px; font-weight: 600;">
                        <i class="fas fa-layer-group"></i> Receipt Batch (<span id="tileCount">0</span> receipts)
                    </h4>
                    <div id="receiptTilesContainer" style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; -webkit-overflow-scrolling: touch; scroll-snap-type: x mandatory;">
                        <!-- Tiles will be inserted here -->
                    </div>
                </div>
                
                <!-- OCR Preview Section -->
                <div class="ocr-preview-container">
                    <div class="preview-image">
                        <div class="preview-placeholder" id="imagePlaceholder">
                            <i class="fas fa-receipt"></i>
                            <p>No receipt image</p>
                            <p>Upload a receipt to see preview</p>
                        </div>
                        <img id="receiptImage" src="" style="display: none;">
                    </div>
                    
                    <div class="ocr-results">
                        <!-- Field Mapping Header -->
                        <div class="field-mapping-header">
                            <h3>üìã Receipt Field Mapping (A-F)</h3>
                            <p>Edit directly in the table below. Changes apply only to the selected receipt.</p>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-field">
                                <div class="field-label">
                                    <span class="field-badge">A</span>
                                    <span class="field-text">Date (Êó•‰ªò)</span>
                                </div>
                                <input type="text" id="fieldDate" name="fieldDate" placeholder="YYYY-MM-DD" autocomplete="off" style="background-color: white; cursor: text;" data-field="receipt_date">
                            </div>
                            
                            <div class="form-field">
                                <div class="field-label">
                                    <span class="field-badge">B</span>
                                    <span class="field-text">Store Name (Â∫óÂêç)</span>
                                </div>
                                <input type="text" id="fieldVendor" name="fieldVendor" placeholder="Store name" autocomplete="off" style="background-color: white; cursor: text;" data-field="vendor_name">
                            </div>
                            
                            <div class="form-field">
                                <div class="field-label">
                                    <span class="field-badge">C</span>
                                    <span class="field-text">Total Amount (ÈáëÈ°ç)</span>
                                </div>
                                <input type="text" id="fieldTotal" name="fieldTotal" placeholder="0.00" autocomplete="off" style="background-color: white; cursor: text;" data-field="total_amount">
                            </div>
                            
                            <div class="form-field">
                                <div class="field-label">
                                    <span class="field-badge">D</span>
                                    <span class="field-text">Invoice Number („Ç§„É≥„Éú„Ç§„ÇπÁï™Âè∑)</span>
                                </div>
                                <input type="text" id="fieldInvoiceNumber" name="fieldInvoiceNumber" placeholder="Invoice/Receipt No." style="background-color: white; cursor: text;" data-field="invoice_number">
                            </div>
                            
                            <div class="form-field">
                                <div class="field-label">
                                    <span class="field-badge">E</span>
                                    <span class="field-text">Tax Category (Á®éÂå∫ÂàÜ)</span>
                                </div>
                                <select id="fieldTaxCategory" name="fieldTaxCategory" style="background-color: white; cursor: text;" data-field="tax_category">
                                    <option value="">Select tax category</option>
                                    <option value="ËªΩÊ∏õÁ®éÁéá">ËªΩÊ∏õÁ®éÁéá (Reduced Tax Rate 8%)</option>
                                    <option value="Ê®ôÊ∫ñÁ®éÁéá">Ê®ôÊ∫ñÁ®éÁéá (Standard Tax Rate 10%)</option>
                                    <option value="ÈùûË™≤Á®é">ÈùûË™≤Á®é (Non-taxable)</option>
                                </select>
                            </div>
                            
                            <div class="form-field">
                                <div class="field-label">
                                    <span class="field-badge">F</span>
                                    <span class="field-text">Account Title (ÂãòÂÆöÁßëÁõÆ)</span>
                                    <span id="aiConfidenceIndicator" class="ai-indicator" style="display: none;">
                                        <i class="fas fa-robot"></i> AI Selected
                                    </span>
                                </div>
                                <select id="fieldAccountTitle" name="fieldAccountTitle" style="background-color: white; cursor: text;" data-field="account_title">
                                    <option value="">Select account title</option>
                                    <option value="È£üË≤ª">üçΩÔ∏è È£üË≤ª (Meals)</option>
                                    <option value="‰∫§ÈÄöË≤ª">üöó ‰∫§ÈÄöË≤ª (Transportation)</option>
                                    <option value="ÈÄö‰ø°Ë≤ª">üì± ÈÄö‰ø°Ë≤ª (Communication)</option>
                                    <option value="ÂÆøÊ≥äË≤ª">üè® ÂÆøÊ≥äË≤ª (Accommodation)</option>
                                    <option value="Êé•ÂæÖ‰∫§ÈöõË≤ª">üéâ Êé•ÂæÖ‰∫§ÈöõË≤ª (Entertainment)</option>
                                    <option value="Ê∂àËÄóÂìÅË≤ª">üìé Ê∂àËÄóÂìÅË≤ª (Office Supplies)</option>
                                    <option value="‰ºöË≠∞Ë≤ª">üè¢ ‰ºöË≠∞Ë≤ª (Meeting Expenses)</option>
                                    <option value="Á†î‰øÆË≤ª">üìö Á†î‰øÆË≤ª (Training)</option>
                                    <option value="Á¶èÂà©ÂéöÁîüË≤ª">üéÅ Á¶èÂà©ÂéöÁîüË≤ª (Welfare)</option>
                                    <option value="Â∫ÉÂëäÂÆ£‰ºùË≤ª">üì¢ Â∫ÉÂëäÂÆ£‰ºùË≤ª (Advertising)</option>
                                    <option value="Ëªä‰∏°Ë≤ª">üöõ Ëªä‰∏°Ë≤ª (Vehicle)</option>
                                    <option value="‰øùÈô∫Êñô">üõ°Ô∏è ‰øùÈô∫Êñô (Insurance)</option>
                                    <option value="ÁßüÁ®éÂÖ¨Ë™≤">üíº ÁßüÁ®éÂÖ¨Ë™≤ (Taxes & Dues)</option>
                                    <option value="„Åù„ÅÆ‰ªñ">üìã „Åù„ÅÆ‰ªñ (Other)</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Verification Status -->
                        <div class="verification-status" id="verificationStatus" style="display: none;">
                            <div class="status-icon">‚úÖ</div>
                            <div class="status-content">
                                <div class="status-title">All fields verified successfully!</div>
                                <div class="confidence-badge">High Confidence</div>
                            </div>
                        </div>
                        
                        <!-- Additional Information -->
                        <div class="additional-info">
                            <h4>Additional Information</h4>
                            <div class="form-grid">
                                <div class="form-field">
                                    <label for="fieldTax">Tax Amount (ÂèÇËÄÉ)</label>
                                    <input type="text" id="fieldTax" name="fieldTax" placeholder="0.00" autocomplete="off" data-field="tax_amount">
                                </div>
                                <div class="form-field">
                                    <label for="fieldCurrency">Currency</label>
                                    <input type="text" id="fieldCurrency" name="fieldCurrency" placeholder="JPY" value="JPY" autocomplete="off" data-field="currency">
                                </div>
                            </div>
                        </div>

                        <!-- Location & Staff Assignment -->
                        <div class="assignment-panel">
                            <h4>Location & Staff Assignment</h4>
                            <p class="panel-hint">Select the business office and staff member responsible for this receipt.</p>
                            <div class="form-grid">
                                <div class="form-field">
                                    <label for="businessLocationSelect">Business Location <span class="required">*</span></label>
                                    <select id="businessLocationSelect" name="businessLocationSelect" data-field="business_location_id">
                                        <option value="">Select location</option>
                                    </select>
                                </div>
                                <div class="form-field">
                                    <label for="staffMemberSelect">Staff Member <span class="required">*</span></label>
                                    <select id="staffMemberSelect" name="staffMemberSelect" disabled data-field="staff_id">
                                        <option value="">Select location first</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button class="secondary-button" id="saveDraftBtn" style="padding: 10px 24px; font-size: 15px; background: white; border: 2px solid var(--primary-blue); color: var(--primary-blue); font-weight: 500;">
                                <i class="fas fa-save"></i> Save
                            </button>
                            <button class="primary-button" id="saveAccumulationBtn" style="padding: 10px 24px; font-size: 15px; font-weight: 500;">
                                <i class="fas fa-paper-plane"></i> Send to HQ Ledger
                            </button>
                            <button class="secondary-button" id="resetButton">
                                <i class="fas fa-redo"></i> Start Over
                            </button>
                        </div>

                        <div class="additional-info" id="ocrDebugPanel" style="display: none; margin-top: 16px;">
                            <h4>Latest OCR Payload (Debug)</h4>
                            <pre id="ocrDebugContent" style="white-space: pre-wrap; background: white; padding: 12px; border-radius: 8px; border: 1px solid var(--medium-gray); max-height: 240px; overflow: auto;"></pre>
                        </div>


                        <div id="saveResultMessage" class="save-result"></div>
                    </div>
                </div>
                </section>
            </div>
        </div>

        <!-- Mobile Bottom Navigation -->
        <nav id="mobileNav" class="mobile-nav">
            <button class="nav-btn active" data-screen="screenCapture" id="navCaptureBtn">
                <i class="fas fa-camera"></i>
                <span>Capture</span>
            </button>
            <button class="nav-btn" data-screen="screenReview" disabled id="navReviewBtn">
                <i class="fas fa-search"></i>
                <span>Review</span>
            </button>
            <button class="nav-btn" data-screen="screenEdit" disabled id="navEditBtn">
                <i class="fas fa-edit"></i>
                <span>Edit</span>
            </button>
        </nav>

        <!-- History Card -->
        <div class="card">
            <div class="card-header">
                <div>
                    <h2 class="card-title">Submission History</h2>
                    <p class="card-description">Recent receipts and their status</p>
                </div>
                <div class="card-icon">
                    <i class="fas fa-history"></i>
                </div>
            </div>
            
            <div class="history-list" id="historyList">
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <p>No submissions yet</p>
                    <p>Start scanning receipts to see them here</p>
                </div>
            </div>
        </div>

        <!-- Developer Credit -->
        <div class="developer-credit" style="text-align: center; margin: 20px 0; padding: 10px; color: var(--dark-gray); font-size: 12px; border-top: 1px solid var(--light-gray);">
            by: Eshwar Potnuru ‚Äì Machine Learning Engineer, AIM Co. Pvt.
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <script>
        // Language translations
        const translations = {
            en: {
                uploadFiles: 'Upload Files',
                uploadUpTo4: 'Up to 4 receipts',
                // Welcome Modal
                welcomeTitle: "Tashiro Ironworks Co., Ltd.",
                welcomeSubtitle: "Professional Receipt OCR Automation System",
                fullName: "Full Name",
                emailAddress: "Email Address (Optional)",
                employeeId: "Login ID",
                launchSystem: "Launch OCR System",
                enterFullName: "Enter your full name",
                enterEmail: "your.email@company.com",
                enterEmployeeId: "PY-V48XE",

                // Profile Modal
                updateProfile: "Update Profile",
                keepInfoUpdated: "Keep your information up to date",
                updateProfileBtn: "Update Profile",
                cancel: "Cancel",

                // Settings Modal
                appSettings: "App Settings",
                customizeExperience: "Customize your experience",
                theme: "Theme",
                language: "Language",
                notifications: "Notifications",
                autoSave: "Auto-save Forms",
                lightMode: "Light Mode",
                darkMode: "Dark Mode",
                autoSystem: "Auto (System)",
                ocrEngine: "OCR Engine",
                ocrEngineAuto: "Hybrid (Auto)",
                ocrEngineStandard: "Standard Engines",
                ocrEngineDocumentAI: "Document AI (Preview)",
                english: "English",
                japanese: "Êó•Êú¨Ë™û (Japanese)",
                allNotifications: "All Notifications",
                importantOnly: "Important Only",
                disabled: "Disabled",
                enabled: "Enabled",
                saveSettings: "Save Settings",

                // Main App
                ocrSystem: "Receipt OCR Automation System",
                tashiroIronworks: "Tashiro Ironworks Co., Ltd.",
                guestUser: "Guest User",
                guestEmail: "guest@example.com",

                // Page title
                pageTitle: "Tashiro Ironworks - Professional OCR System",

                // Cards
                captureReceipt: "Capture Receipt",
                takePhotoOrUpload: "Take a photo or upload an existing receipt image",
                takePhoto: "Take Photo",
                useDeviceCamera: "Use device camera",
                uploadFile: "Upload File",
                jpgPngOrPdf: "JPG, PNG, or PDF",
                dragDropHere: "Drag & drop receipt image here",
                orUseOptionsAbove: "or use the options above",

                ocrReview: "OCR Review & Verification",
                verifyExtractedData: "Verify extracted data and submit to HQ",
                receiptFieldMapping: "Receipt Field Mapping (A-F)",
                verifyDataMatches: "Verify extracted data matches receipt content",

                // Field Labels
                dateLabel: "Date (Êó•‰ªò)",
                storeNameLabel: "Store Name (Â∫óÂêç)",
                totalAmountLabel: "Total Amount (ÈáëÈ°ç)",
                invoiceNumberLabel: "Invoice Number („Ç§„É≥„Éú„Ç§„ÇπÁï™Âè∑)",
                taxCategoryLabel: "Tax Category (Á®éÂå∫ÂàÜ)",
                accountTitleLabel: "Account Title (ÂãòÂÆöÁßëÁõÆ)",
                selectTaxCategory: "Select tax category",
                selectAccountTitle: "Select account title",

                // Account Titles
                meals: "È£üË≤ª (Meals)",
                transportation: "‰∫§ÈÄöË≤ª (Transportation)",
                communication: "ÈÄö‰ø°Ë≤ª (Communication)",
                accommodation: "ÂÆøÊ≥äË≤ª (Accommodation)",
                entertainment: "Êé•ÂæÖ‰∫§ÈöõË≤ª (Entertainment)",
                officeSupplies: "Ê∂àËÄóÂìÅË≤ª (Office Supplies)",
                meetingExpenses: "‰ºöË≠∞Ë≤ª (Meeting Expenses)",
                training: "Á†î‰øÆË≤ª (Training)",
                welfare: "Á¶èÂà©ÂéöÁîüË≤ª (Welfare)",
                advertising: "Â∫ÉÂëäÂÆ£‰ºùË≤ª (Advertising)",
                vehicle: "Ëªä‰∏°Ë≤ª (Vehicle)",
                insurance: "‰øùÈô∫Êñô (Insurance)",
                taxesDues: "ÁßüÁ®éÂÖ¨Ë™≤ (Taxes & Dues)",
                other: "„Åù„ÅÆ‰ªñ (Other)",

                // Additional Info
                additionalInformation: "Additional Information",
                subtotalRef: "Subtotal (ÂèÇËÄÉ)",
                taxAmountRef: "Tax Amount (ÂèÇËÄÉ)",
                currency: "Currency",
                locationStaffHeader: "Location & Staff Assignment",
                locationStaffDescription: "Select the business office and staff member responsible for this receipt.",
                staffMemberLabel: "Staff Member",
                selectStaff: "Select staff member",
                selectLocationFirst: "Select location first",
                loadingStaff: "Loading staff...",
                noStaffFound: "No staff configured",
                staffLoadError: "Unable to load staff",
                staffRequired: "Select a staff member before saving.",

                // Buttons
                submitToHq: "Submit to HQ",
                reviewData: "Review Data",
                startOver: "Start Over",

                // Verification
                allFieldsVerified: "All fields verified successfully!",
                highConfidence: "High Confidence",

                // History
                submissionHistory: "Submission History",
                recentReceipts: "Recent receipts and their status",
                noSubmissionsYet: "No submissions yet",
                startScanning: "Start scanning receipts to see them here",
                submitted: "Submitted",

                // Placeholders
                yyyyMmDd: "YYYY-MM-DD",
                storeName: "Store name",
                zeroZero: "0.00",
                invoiceReceiptNo: "Invoice/Receipt No.",
                jpy: "JPY",

                // Image placeholder
                noReceiptImage: "No receipt image",
                uploadReceiptToSeePreview: "Upload a receipt to see preview",

                // Developer credit
                developerCredit: "by: Eshwar Potnuru ‚Äì Machine Learning Engineer, AIM Co. Pvt.",

                // Toast Messages
                welcomeMessage: "Welcome, {name}! Ready to process receipts.",
                processingReceipt: "Processing receipt image...",
                receiptAnalyzed: "Receipt analyzed successfully! All fields extracted.",
                failedToAnalyze: "Failed to analyze receipt. Please try again.",
                formReset: "Form reset. Ready for new receipt.",
                noReceiptData: "No receipt data to submit. Please upload a receipt first.",
                receiptSubmitted: "Receipt submitted to HQ successfully!",
                failedToSubmit: "Failed to submit receipt. Please try again.",
                preparingDownload: "Preparing Excel download...",
                excelDownloaded: "Excel downloaded successfully!",
                failedDownload: "Failed to download Excel. Please try again.",
                settingsSaved: "Settings saved successfully!",
                profileUpdated: "Profile updated successfully!",
                aiDetected: "AI Detected {confidence}% confident",

                // OCR Tips
                ocrTipsTitle: "Quick Tips for Better OCR",
                ocrTipLighting: "Ensure good lighting and avoid shadows",
                ocrTipSteady: "Hold camera steady and keep receipt flat",
                ocrTipEdges: "Include all receipt edges in the photo",
                ocrTipBlur: "Avoid blurry or distorted images",
                ocrTipFormats: "Supported formats: JPG, PNG (max 5MB)",

                // AI Indicator
                aiSelected: "AI Selected",

                // Editable Table
                reviewEditExtractedData: "Review & Edit Extracted Data",
                saveChanges: "Save Changes",
                exportToExcel: "Send to Excel",
                field: "Field",
                value: "Value",
                status: "Status",
                ready: "‚úì Ready",
                changesSaved: "Changes saved locally.",
                saveToHQ: "Send to HQ Ledger",
                saveReceiptToLocation: "Send Receipt to {location}",
                businessLocationLabel: "Business Location",
                selectLocation: "Select location",
                readyForHqSave: "Ready to send",
                locationRequired: "Select a business location before sending.",
                operatorMissing: "Operator details missing. Please complete your profile.",
                savingReceipt: "Saving receipt to HQ...",
                duplicateWarning: "Potential duplicate detected.",
                forceSavePrompt: "Duplicate found. Force save anyway?",
                savedReceipt: "Receipt saved to HQ ledger!",
                downloadWorkbook: "Download workbook",
                savedToPath: "Saved to {path}."
            },
            ja: {
                uploadFiles: '„Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ',
                uploadUpTo4: 'ÊúÄÂ§ß4Êûö„Åæ„Åß',
                // Welcome Modal
                welcomeTitle: "Ê†™Âºè‰ºöÁ§æ„Çø„Ç∑„É≠ÈâÑÂ∑•ÊâÄ",
                welcomeSubtitle: "„Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´È†òÂèéÊõ∏OCRËá™ÂãïÂåñ„Ç∑„Çπ„ÉÜ„É†",
                fullName: "Ê∞èÂêç",
                emailAddress: "„É°„Éº„É´„Ç¢„Éâ„É¨„ÇπÔºà‰ªªÊÑèÔºâ",
                employeeId: "Á§æÂì°ID",
                launchSystem: "OCR„Ç∑„Çπ„ÉÜ„É†„ÇíËµ∑Âãï",
                enterFullName: "Ê∞èÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ",
                enterEmail: "your.email@company.com",
                enterEmployeeId: "PY-V48XE",

                // Profile Modal
                updateProfile: "„Éó„É≠„Éï„Ç£„Éº„É´„ÇíÊõ¥Êñ∞",
                keepInfoUpdated: "ÊÉÖÂ†±„ÇíÊúÄÊñ∞„Å´‰øù„Å§",
                updateProfileBtn: "„Éó„É≠„Éï„Ç£„Éº„É´„ÇíÊõ¥Êñ∞",
                cancel: "„Ç≠„É£„É≥„Çª„É´",

                // Settings Modal
                appSettings: "„Ç¢„Éó„É™Ë®≠ÂÆö",
                customizeExperience: "‰ΩìÈ®ì„Çí„Ç´„Çπ„Çø„Éû„Ç§„Ç∫",
                theme: "„ÉÜ„Éº„Éû",
                language: "Ë®ÄË™û",
                notifications: "ÈÄöÁü•",
                autoSave: "„Éï„Ç©„Éº„É†„ÅÆËá™Âãï‰øùÂ≠ò",
                lightMode: "„É©„Ç§„Éà„É¢„Éº„Éâ",
                darkMode: "„ÉÄ„Éº„ÇØ„É¢„Éº„Éâ",
                autoSystem: "Ëá™ÂãïÔºà„Ç∑„Çπ„ÉÜ„É†Ôºâ",
                ocrEngine: "OCR„Ç®„É≥„Ç∏„É≥",
                ocrEngineAuto: "„Éè„Ç§„Éñ„É™„ÉÉ„ÉâÔºàËá™ÂãïÔºâ",
                ocrEngineStandard: "ÈÄöÂ∏∏„Ç®„É≥„Ç∏„É≥",
                ocrEngineDocumentAI: "Document AIÔºà„Éó„É¨„Éì„É•„ÉºÔºâ",
                english: "English",
                japanese: "Êó•Êú¨Ë™û",
                allNotifications: "„Åô„Åπ„Å¶„ÅÆÈÄöÁü•",
                importantOnly: "ÈáçË¶Å„Å™„ÇÇ„ÅÆ„ÅÆ„Åø",
                disabled: "ÁÑ°Âäπ",
                enabled: "ÊúâÂäπ",
                saveSettings: "Ë®≠ÂÆö„Çí‰øùÂ≠ò",

                // Main App
                ocrSystem: "È†òÂèéÊõ∏OCRËá™ÂãïÂåñ„Ç∑„Çπ„ÉÜ„É†",
                tashiroIronworks: "Ê†™Âºè‰ºöÁ§æ„Çø„Ç∑„É≠ÈâÑÂ∑•ÊâÄ",
                guestUser: "„Ç≤„Çπ„Éà„É¶„Éº„Ç∂„Éº",
                guestEmail: "guest@example.com",

                // Page title
                pageTitle: "Ê†™Âºè‰ºöÁ§æ„Çø„Ç∑„É≠ÈâÑÂ∑•ÊâÄ - „Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´OCR„Ç∑„Çπ„ÉÜ„É†",

                // Cards
                captureReceipt: "È†òÂèéÊõ∏„Çí„Ç≠„É£„Éó„ÉÅ„É£",
                takePhotoOrUpload: "ÂÜôÁúü„ÇíÊíÆ„Çã„ÅãÊó¢Â≠ò„ÅÆÈ†òÂèéÊõ∏ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ",
                takePhoto: "ÂÜôÁúü„ÇíÊíÆ„Çã",
                useDeviceCamera: "„Éá„Éê„Ç§„Çπ„ÅÆ„Ç´„É°„É©„Çí‰ΩøÁî®",
                uploadFile: "„Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ",
                jpgPngOrPdf: "JPG„ÄÅPNG„ÄÅ„Åæ„Åü„ÅØPDF",
                dragDropHere: "È†òÂèéÊõ∏ÁîªÂÉè„Çí„Åì„Åì„Å´„Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó",
                orUseOptionsAbove: "„Åæ„Åü„ÅØ‰∏äË®ò„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥„Çí‰ΩøÁî®",

                ocrReview: "OCRÁ¢∫Ë™ç„Å®Ê§úË®º",
                verifyExtractedData: "ÊäΩÂá∫„Åï„Çå„Åü„Éá„Éº„Çø„ÇíÁ¢∫Ë™ç„ÅóÊú¨Á§æ„Å´ÊèêÂá∫",
                receiptFieldMapping: "È†òÂèéÊõ∏„Éï„Ç£„Éº„É´„Éâ„Éû„ÉÉ„Éî„É≥„Ç∞ÔºàA-FÔºâ",
                verifyDataMatches: "ÊäΩÂá∫„Åï„Çå„Åü„Éá„Éº„Çø„ÅåÈ†òÂèéÊõ∏„ÅÆÂÜÖÂÆπ„Å®‰∏ÄËá¥„Åô„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç",

                // Field Labels
                dateLabel: "Êó•‰ªò",
                storeNameLabel: "Â∫óÂêç",
                totalAmountLabel: "ÈáëÈ°ç",
                invoiceNumberLabel: "„Ç§„É≥„Éú„Ç§„ÇπÁï™Âè∑",
                taxCategoryLabel: "Á®éÂå∫ÂàÜ",
                accountTitleLabel: "ÂãòÂÆöÁßëÁõÆ",
                selectTaxCategory: "Á®éÂå∫ÂàÜ„ÇíÈÅ∏Êäû",
                selectAccountTitle: "ÂãòÂÆöÁßëÁõÆ„ÇíÈÅ∏Êäû",

                // Account Titles
                meals: "È£üË≤ª",
                transportation: "‰∫§ÈÄöË≤ª",
                communication: "ÈÄö‰ø°Ë≤ª",
                accommodation: "ÂÆøÊ≥äË≤ª",
                entertainment: "Êé•ÂæÖ‰∫§ÈöõË≤ª",
                officeSupplies: "Ê∂àËÄóÂìÅË≤ª",
                meetingExpenses: "‰ºöË≠∞Ë≤ª",
                training: "Á†î‰øÆË≤ª",
                welfare: "Á¶èÂà©ÂéöÁîüË≤ª",
                advertising: "Â∫ÉÂëäÂÆ£‰ºùË≤ª",
                vehicle: "Ëªä‰∏°Ë≤ª",
                insurance: "‰øùÈô∫Êñô",
                taxesDues: "ÁßüÁ®éÂÖ¨Ë™≤",
                other: "„Åù„ÅÆ‰ªñ",

                // Additional Info
                additionalInformation: "ËøΩÂä†ÊÉÖÂ†±",
                subtotalRef: "Â∞èË®àÔºàÂèÇËÄÉÔºâ",
                taxAmountRef: "Á®éÈ°çÔºàÂèÇËÄÉÔºâ",
                currency: "ÈÄöË≤®",
                locationStaffHeader: "‰∫ãÊ•≠ÊâÄ„Å®ÊãÖÂΩìËÄÖ„ÅÆÂâ≤„ÇäÂΩì„Å¶",
                locationStaffDescription: "„Åì„ÅÆÈ†òÂèéÊõ∏„ÇíÊãÖÂΩì„Åô„Çã‰∫ãÊ•≠ÊâÄ„Å®ÊãÖÂΩìËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                staffMemberLabel: "ÊãÖÂΩìËÄÖ",
                selectStaff: "ÊãÖÂΩìËÄÖ„ÇíÈÅ∏Êäû",
                selectLocationFirst: "ÂÖà„Å´‰∫ãÊ•≠ÊâÄ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ",
                loadingStaff: "ÊãÖÂΩìËÄÖ„ÇíË™≠„ÅøËæº„Åø‰∏≠...",
                noStaffFound: "ÊãÖÂΩìËÄÖ„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì",
                staffLoadError: "ÊãÖÂΩìËÄÖ„ÇíË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì„Åß„Åó„Åü",
                staffRequired: "‰øùÂ≠òÂâç„Å´ÊãÖÂΩìËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",

                // Buttons
                submitToHq: "Êú¨Á§æ„Å´ÊèêÂá∫",
                reviewData: "„Éá„Éº„Çø„ÇíÁ¢∫Ë™ç",
                startOver: "ÊúÄÂàù„Åã„Çâ„ÇÑ„ÇäÁõ¥„Åô",

                // Verification
                allFieldsVerified: "„Åô„Åπ„Å¶„ÅÆ„Éï„Ç£„Éº„É´„Éâ„ÅåÊ≠£Â∏∏„Å´Ê§úË®º„Åï„Çå„Åæ„Åó„ÅüÔºÅ",
                highConfidence: "È´ò‰ø°È†ºÊÄß",

                // History
                submissionHistory: "ÊèêÂá∫Â±•Ê≠¥",
                recentReceipts: "ÊúÄËøë„ÅÆÈ†òÂèéÊõ∏„Å®„Åù„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ",
                noSubmissionsYet: "„Åæ„Å†ÊèêÂá∫„Åå„ÅÇ„Çä„Åæ„Åõ„Çì",
                startScanning: "È†òÂèéÊõ∏„Çí„Çπ„Ç≠„É£„É≥„Åó„Å¶„Åì„Åì„Å´Ë°®Á§∫",
                submitted: "ÊèêÂá∫Ê∏à„Åø",

                // Placeholders
                yyyyMmDd: "YYYY-MM-DD",
                storeName: "Â∫óÂêç",
                zeroZero: "0.00",
                invoiceReceiptNo: "„Ç§„É≥„Éú„Ç§„Çπ/È†òÂèéÊõ∏Áï™Âè∑",
                jpy: "JPY",

                // Image placeholder
                noReceiptImage: "È†òÂèéÊõ∏ÁîªÂÉè„Åå„ÅÇ„Çä„Åæ„Åõ„Çì",
                uploadReceiptToSeePreview: "È†òÂèéÊõ∏„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Éó„É¨„Éì„É•„Éº„ÇíË°®Á§∫",

                // Developer credit
                developerCredit: "by: Eshwar Potnuru ‚Äì Ê©üÊ¢∞Â≠¶Áøí„Ç®„É≥„Ç∏„Éã„Ç¢„ÄÅAIM Co. Pvt.",

                // Toast Messages
                welcomeMessage: "{name}„Åï„Çì„ÄÅ„Çà„ÅÜ„Åì„ÅùÔºÅÈ†òÂèéÊõ∏„ÅÆÂá¶ÁêÜ„ÇíÈñãÂßã„Åß„Åç„Åæ„Åô„ÄÇ",
                processingReceipt: "È†òÂèéÊõ∏ÁîªÂÉè„ÇíÂá¶ÁêÜ‰∏≠...",
                receiptAnalyzed: "È†òÂèéÊõ∏„ÅÆÂàÜÊûê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ„Åô„Åπ„Å¶„ÅÆ„Éï„Ç£„Éº„É´„Éâ„ÅåÊäΩÂá∫„Åï„Çå„Åæ„Åó„Åü„ÄÇ",
                failedToAnalyze: "È†òÂèéÊõ∏„ÅÆÂàÜÊûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ",
                formReset: "„Éï„Ç©„Éº„É†„Åå„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åó„Åü„ÄÇÊñ∞Ë¶èÈ†òÂèéÊõ∏„ÅÆÊ∫ñÂÇô„Åå„Åß„Åç„Åæ„Åó„Åü„ÄÇ",
                noReceiptData: "ÊèêÂá∫„Åô„ÇãÈ†òÂèéÊõ∏„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Åæ„ÅöÈ†òÂèéÊõ∏„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                receiptSubmitted: "È†òÂèéÊõ∏„ÅåÊú¨Á§æ„Å´Ê≠£Â∏∏„Å´ÊèêÂá∫„Åï„Çå„Åæ„Åó„ÅüÔºÅ",
                failedToSubmit: "È†òÂèéÊõ∏„ÅÆÊèêÂá∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ",
                preparingDownload: "Excel„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„ÇíÊ∫ñÂÇô‰∏≠...",
                excelDownloaded: "Excel„ÅåÊ≠£Â∏∏„Å´„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åï„Çå„Åæ„Åó„ÅüÔºÅ",
                failedDownload: "Excel„ÅÆ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ",
                settingsSaved: "Ë®≠ÂÆö„ÅåÊ≠£Â∏∏„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åó„ÅüÔºÅ",
                profileUpdated: "„Éó„É≠„Éï„Ç£„Éº„É´„ÅåÊ≠£Â∏∏„Å´Êõ¥Êñ∞„Åï„Çå„Åæ„Åó„ÅüÔºÅ",
                aiDetected: "AIÊ§úÂá∫ {confidence}% ‰ø°È†ºÊÄß",

                // OCR Tips
                ocrTipsTitle: "OCRÁ≤æÂ∫¶Âêë‰∏ä„ÅÆ„Åü„ÇÅ„ÅÆ„ÇØ„Ç§„ÉÉ„ÇØTips",
                ocrTipLighting: "ÂçÅÂàÜ„Å™ÁÖßÊòé„ÇíÁ¢∫‰øù„Åó„ÄÅÂΩ±„ÇíÈÅø„Åë„Çã",
                ocrTipSteady: "„Ç´„É°„É©„ÇíÂÆâÂÆö„Åï„Åõ„ÄÅÈ†òÂèéÊõ∏„ÇíÂπ≥„Çâ„Å´‰øù„Å§",
                ocrTipEdges: "ÂÜôÁúü„Å´È†òÂèéÊõ∏„ÅÆ„Åô„Åπ„Å¶„ÅÆÁ´Ø„ÇíÂê´„ÇÅ„Çã",
                ocrTipBlur: "„Åº„ÇÑ„Åë„ÇÑÊ≠™„Åø„ÇíÈÅø„Åë„Çã",
                ocrTipFormats: "ÂØæÂøú„Éï„Ç©„Éº„Éû„ÉÉ„Éà: JPG, PNG (ÊúÄÂ§ß5MB)",

                // AI Indicator
                aiSelected: "AIÊ§úÂá∫",

                // Editable Table
                reviewEditExtractedData: "ÊäΩÂá∫„Éá„Éº„Çø„ÅÆÁ¢∫Ë™ç„Å®Á∑®ÈõÜ",
                saveChanges: "Â§âÊõ¥„Çí‰øùÂ≠ò",
                exportToExcel: "Excel„Å´„Ç®„ÇØ„Çπ„Éù„Éº„Éà",
                field: "„Éï„Ç£„Éº„É´„Éâ",
                value: "ÂÄ§",
                status: "„Çπ„ÉÜ„Éº„Çø„Çπ",
                ready: "‚úì Ê∫ñÂÇôÂÆå‰∫Ü",
                changesSaved: "Â§âÊõ¥„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ",
                saveToHQ: "HQÂè∞Â∏≥„Å´ÈÄÅ‰ø°",
                saveReceiptToLocation: "{location} „Å´ÈÄÅ‰ø°",
                businessLocationLabel: "‰∫ãÊ•≠ÊâÄ",
                selectLocation: "‰∫ãÊ•≠ÊâÄ„ÇíÈÅ∏Êäû",
                readyForHqSave: "ÈÄÅ‰ø°Ê∫ñÂÇôÂÆå‰∫Ü",
                locationRequired: "ÈÄÅ‰ø°Ââç„Å´‰∫ãÊ•≠ÊâÄ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                operatorMissing: "„Ç™„Éö„É¨„Éº„Çø„ÉºÊÉÖÂ†±„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Éó„É≠„Éï„Ç£„Éº„É´„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                savingReceipt: "HQ„Å∏‰øùÂ≠ò‰∏≠...",
                duplicateWarning: "ÈáçË§á„ÅÆÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ",
                forceSavePrompt: "ÈáçË§á„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åó„Åü„ÄÇÂº∑Âà∂‰øùÂ≠ò„Åó„Åæ„Åô„ÅãÔºü",
                savedReceipt: "HQÂè∞Â∏≥„Å´‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ",
                downloadWorkbook: "Âè∞Â∏≥„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ",
                savedToPath: "{path} „Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åó„Åü„ÄÇ"
            }
        };

        // Current language
        let currentLanguage = 'en';

        // Translation function
        function t(key, params = {}) {
            let text = translations[currentLanguage]?.[key] || translations['en']?.[key] || key;

            // Provide readable fallbacks for common untranslated keys
            if (text === key) {
                const fallbacks = {
                    'processingReceipt': 'Processing receipt...',
                    'receiptAnalyzed': 'Receipt analyzed successfully!',
                    'failedToAnalyze': 'Failed to analyze receipt',
                    'uploadingImage': 'Uploading image...',
                    'ocrInProgress': 'OCR in progress...',
                    'extractingFields': 'Extracting fields...',
                    'savingDraft': 'Saving draft...',
                    'sendToHq': 'Sending to HQ...',
                    'noReceiptData': 'No receipt data available',
                    'locationRequired': 'Business location is required',
                    'staffRequired': 'Staff member is required',
                    'changesSaved': 'Changes saved successfully',
                    'readyForHqSave': 'Ready for HQ submission'
                };
                text = fallbacks[key] || key;
            }

            // Replace parameters
            Object.keys(params).forEach(param => {
                text = text.replace(`{${param}}`, params[param]);
            });

            return text;
        }

// Update field labels based on extracted data
function updateFieldLabels() {
    const fieldTexts = document.querySelectorAll('.field-text');
    if (fieldTexts.length >= 6) {
        const dateValue = document.getElementById('fieldDate')?.value || '';
        const vendorValue = document.getElementById('fieldVendor')?.value || '';
        const totalValue = document.getElementById('fieldTotal')?.value || '';
        const invoiceValue = document.getElementById('fieldInvoiceNumber')?.value || '';
        const taxValue = document.getElementById('fieldTaxCategory')?.value || '';
        const accountValue = document.getElementById('fieldAccountTitle')?.value || '';
        
        fieldTexts[0].textContent = dateValue ? `${t('dateLabel')}: ${dateValue}` : t('dateLabel');
        fieldTexts[1].textContent = vendorValue ? `${t('storeNameLabel')}: ${vendorValue}` : t('storeNameLabel');
        fieldTexts[2].textContent = totalValue ? `${t('totalAmountLabel')}: ${totalValue}` : t('totalAmountLabel');
        fieldTexts[3].textContent = invoiceValue ? `${t('invoiceNumberLabel')}: ${invoiceValue}` : t('invoiceNumberLabel');
        fieldTexts[4].textContent = taxValue ? `${t('taxCategoryLabel')}: ${taxValue}` : t('taxCategoryLabel');
        fieldTexts[5].textContent = accountValue ? `${t('accountTitleLabel')}: ${accountValue}` : t('accountTitleLabel');
    }
}        // Apply translations to the page
        let languageUpdateScheduled = false;

        function applyLanguage(language) {
            currentLanguage = language;
            document.documentElement.lang = language;
            document.title = t('pageTitle');

            if (languageUpdateScheduled) {
                return;
            }

            languageUpdateScheduled = true;
            requestAnimationFrame(() => {
                languageUpdateScheduled = false;
                refreshLocalizedContent();
            });
        }

        function refreshLocalizedContent() {
            // Helper function to safely update element content
            const safeUpdate = (selector, property, value) => {
                const el = typeof selector === 'string' ? document.querySelector(selector) : selector;
                if (el) el[property] = value;
            };

            // Welcome Modal (if exists)
            safeUpdate('#welcomeModal h1', 'textContent', t('welcomeTitle'));
            safeUpdate('#welcomeModal .modal-subtitle', 'textContent', t('welcomeSubtitle'));
            safeUpdate('label[for="userName"]', 'innerHTML', `${t('fullName')} <span class="required">*</span>`);
            safeUpdate('label[for="userEmail"]', 'textContent', t('emailAddress'));
            safeUpdate('label[for="employeeId"]', 'innerHTML', `${t('employeeId')} <span class="required">*</span>`);
            safeUpdate('#registrationForm button[type="submit"]', 'innerHTML', `<i class="fas fa-rocket"></i> ${t('launchSystem')}`);
            const userName = document.getElementById('userName');
            if (userName) userName.placeholder = t('enterFullName');
            const userEmail = document.getElementById('userEmail');
            if (userEmail) userEmail.placeholder = t('enterEmail');
            const employeeId = document.getElementById('employeeId');
            if (employeeId) employeeId.placeholder = t('enterEmployeeId');

            // Profile Modal (if exists)
            safeUpdate('#profileModal h1', 'textContent', t('updateProfile'));
            safeUpdate('#profileModal .modal-subtitle', 'textContent', t('keepInfoUpdated'));
            safeUpdate('label[for="updateUserName"]', 'innerHTML', `${t('fullName')} <span class="required">*</span>`);
            safeUpdate('label[for="updateUserEmail"]', 'textContent', t('emailAddress'));
            safeUpdate('label[for="updateEmployeeId"]', 'innerHTML', `${t('employeeId')} <span class="required">*</span>`);
            safeUpdate('#profileForm button[type="submit"]', 'innerHTML', `<i class="fas fa-save"></i> ${t('updateProfileBtn')}`);
            const cancelProfileBtn = document.getElementById('cancelProfileUpdate');
            if (cancelProfileBtn) cancelProfileBtn.textContent = t('cancel');
            const updateUserName = document.getElementById('updateUserName');
            if (updateUserName) updateUserName.placeholder = t('enterFullName');
            const updateUserEmail = document.getElementById('updateUserEmail');
            if (updateUserEmail) updateUserEmail.placeholder = t('enterEmail');
            const updateEmployeeId = document.getElementById('updateEmployeeId');
            if (updateEmployeeId) updateEmployeeId.placeholder = t('enterEmployeeId');

            // Settings Modal
            safeUpdate('#settingsModal h1', 'textContent', t('appSettings'));
            safeUpdate('#settingsModal .modal-subtitle', 'textContent', t('customizeExperience'));
            safeUpdate('label[for="themeToggle"]', 'textContent', t('theme'));
            safeUpdate('label[for="languageSelect"]', 'textContent', t('language'));
            safeUpdate('label[for="ocrEngineSelect"]', 'textContent', t('ocrEngine'));
            safeUpdate('label[for="notificationToggle"]', 'textContent', t('notifications'));
            safeUpdate('label[for="autoSaveToggle"]', 'textContent', t('autoSave'));
            const saveSettingsBtn = document.getElementById('saveSettings');
            if (saveSettingsBtn) saveSettingsBtn.innerHTML = `<i class="fas fa-save"></i> ${t('saveSettings')}`;
            const cancelSettingsBtn = document.getElementById('cancelSettings');
            if (cancelSettingsBtn) cancelSettingsBtn.textContent = t('cancel');

            // Update select options
            const themeSelect = document.getElementById('themeToggle');
            themeSelect.querySelector('option[value="light"]').textContent = t('lightMode');
            themeSelect.querySelector('option[value="dark"]').textContent = t('darkMode');
            themeSelect.querySelector('option[value="auto"]').textContent = t('autoSystem');

            const languageSelect = document.getElementById('languageSelect');
            languageSelect.querySelector('option[value="en"]').textContent = t('english');
            languageSelect.querySelector('option[value="ja"]').textContent = t('japanese');

            const engineSelect = document.getElementById('ocrEngineSelect');
            engineSelect.querySelector('option[value="auto"]').textContent = t('ocrEngineAuto');
            engineSelect.querySelector('option[value="standard"]').textContent = t('ocrEngineStandard');
            engineSelect.querySelector('option[value="document_ai"]').textContent = t('ocrEngineDocumentAI');

            const notificationSelect = document.getElementById('notificationToggle');
            notificationSelect.querySelector('option[value="all"]').textContent = t('allNotifications');
            notificationSelect.querySelector('option[value="important"]').textContent = t('importantOnly');
            notificationSelect.querySelector('option[value="none"]').textContent = t('disabled');

            const autoSaveSelect = document.getElementById('autoSaveToggle');
            autoSaveSelect.querySelector('option[value="enabled"]').textContent = t('enabled');
            autoSaveSelect.querySelector('option[value="disabled"]').textContent = t('disabled');

            // Main App Header
            document.querySelector('.header-left h1').textContent = t('ocrSystem');
            document.querySelector('.header-left p').textContent = t('tashiroIronworks');

            // Cards - Update each card specifically
            const cards = document.querySelectorAll('.card');
            if (cards.length >= 3) {
                // First card: Capture Receipt
                const captureCard = cards[0];
                captureCard.querySelector('.card-title').textContent = t('captureReceipt');
                captureCard.querySelector('.card-description').textContent = t('takePhotoOrUpload');

                // Second card: OCR Review & Verification
                const ocrCard = cards[1];
                ocrCard.querySelector('.card-title').textContent = t('ocrReview');
                ocrCard.querySelector('.card-description').textContent = t('verifyExtractedData');

                // Third card: Submission History
                const historyCard = cards[2];
                historyCard.querySelector('.card-title').textContent = t('submissionHistory');
                historyCard.querySelector('.card-description').textContent = t('recentReceipts');
            }

            // Upload buttons and text
            const uploadButtons = document.querySelectorAll('.upload-button');
            if (uploadButtons.length >= 2) {
                uploadButtons[0].querySelector('.upload-text').textContent = t('takePhoto');
                uploadButtons[0].querySelector('.upload-subtext').textContent = t('useDeviceCamera');
                uploadButtons[1].querySelector('.upload-text').textContent = t('uploadFile');
                uploadButtons[1].querySelector('.upload-subtext').textContent = t('jpgPngOrPdf');
            }

            // Dropzone text
            const dropzone = document.getElementById('dropzone');
            if (dropzone) {
                const dropzoneParagraphs = dropzone.querySelectorAll('p');
                if (dropzoneParagraphs.length >= 2) {
                    dropzoneParagraphs[0].textContent = t('dragDropHere');
                    dropzoneParagraphs[1].textContent = t('orUseOptionsAbove');
                }
            }

            // Field placeholders
            document.getElementById('fieldDate').placeholder = t('yyyyMmDd');
            document.getElementById('fieldVendor').placeholder = t('storeName');
            document.getElementById('fieldTotal').placeholder = t('zeroZero');
            document.getElementById('fieldInvoiceNumber').placeholder = t('invoiceReceiptNo');
            document.getElementById('fieldCurrency').placeholder = t('jpy');

            // Image placeholder text
            const imagePlaceholder = document.getElementById('imagePlaceholder');
            if (imagePlaceholder) {
                const placeholderTexts = imagePlaceholder.querySelectorAll('p');
                if (placeholderTexts.length >= 2) {
                    placeholderTexts[0].textContent = t('noReceiptImage');
                    placeholderTexts[1].textContent = t('uploadReceiptToSeePreview');
                }
            }

            // Field mapping header and labels
            const fieldMappingHeader = document.querySelector('.field-mapping-header');
            if (fieldMappingHeader) {
                const headerElements = fieldMappingHeader.querySelectorAll('h3, p');
                if (headerElements.length >= 2) {
                    headerElements[0].textContent = t('receiptFieldMapping');
                    headerElements[1].textContent = t('verifyDataMatches');
                }
            }

            // Field labels
            const fieldLabels = document.querySelectorAll('.field-label');
            if (fieldLabels.length >= 6) {
                fieldLabels[0].querySelector('span:not(.field-badge)').textContent = t('dateLabel');
                fieldLabels[1].querySelector('span:not(.field-badge)').textContent = t('storeNameLabel');
                fieldLabels[2].querySelector('span:not(.field-badge)').textContent = t('totalAmountLabel');
                fieldLabels[3].querySelector('span:not(.field-badge)').textContent = t('invoiceNumberLabel');
                fieldLabels[4].querySelector('span:not(.field-badge)').textContent = t('taxCategoryLabel');
                fieldLabels[5].querySelector('span:not(.field-badge)').textContent = t('accountTitleLabel');
            }

            // Select options
            const taxCategorySelect = document.getElementById('fieldTaxCategory');
            if (taxCategorySelect) {
                const taxOptions = taxCategorySelect.querySelectorAll('option');
                if (taxOptions.length >= 4) {
                    taxOptions[0].textContent = t('selectTaxCategory');
                    // Keep the actual tax category values as they are in Japanese
                }
            }

            const accountTitleSelect = document.getElementById('fieldAccountTitle');
            if (accountTitleSelect) {
                const accountOptions = accountTitleSelect.querySelectorAll('option');
                if (accountOptions.length >= 15) {
                    accountOptions[0].textContent = t('selectAccountTitle');
                    accountOptions[1].textContent = t('meals');
                    accountOptions[2].textContent = t('transportation');
                    accountOptions[3].textContent = t('communication');
                    accountOptions[4].textContent = t('accommodation');
                    accountOptions[5].textContent = t('entertainment');
                    accountOptions[6].textContent = t('officeSupplies');
                    accountOptions[7].textContent = t('meetingExpenses');
                    accountOptions[8].textContent = t('training');
                    accountOptions[9].textContent = t('welfare');
                    accountOptions[10].textContent = t('advertising');
                    accountOptions[11].textContent = t('vehicle');
                    accountOptions[12].textContent = t('insurance');
                    accountOptions[13].textContent = t('taxesDues');
                    accountOptions[14].textContent = t('other');
                }
            }

            // Additional information header
            const additionalInfo = document.querySelector('.additional-info h4');
            if (additionalInfo) {
                additionalInfo.textContent = t('additionalInformation');
            }

            // Additional info field labels
            const additionalLabels = document.querySelectorAll('.additional-info label');
            console.log('Additional labels found (regular update):', additionalLabels.length);
            if (additionalLabels.length >= 2) {
                additionalLabels[0].textContent = t('taxAmountRef');
                additionalLabels[1].textContent = t('currency');
                console.log('Additional labels updated (regular):', additionalLabels[1].textContent);
            }

            const assignmentHeader = document.querySelector('.assignment-panel h4');
            if (assignmentHeader) {
                assignmentHeader.textContent = t('locationStaffHeader');
            }

            const assignmentHint = document.querySelector('.assignment-panel .panel-hint');
            if (assignmentHint) {
                assignmentHint.textContent = t('locationStaffDescription');
            }

            if (businessLocationLabel) {
                businessLocationLabel.innerHTML = `${t('businessLocationLabel')} <span class="required">*</span>`;
            }
            const staffMemberLabel = document.querySelector('label[for="staffMemberSelect"]');
            if (staffMemberLabel) {
                staffMemberLabel.innerHTML = `${t('staffMemberLabel')} <span class="required">*</span>`;
            }
            if (businessLocationSelect) {
                populateLocationSelect();
            }

            // Form action buttons
            const submitBtn = document.getElementById('submitButton');
            const reviewBtn = document.getElementById('reviewDataBtn');
            const resetBtn = document.getElementById('resetButton');
            console.log('Updating buttons (regular):', submitBtn, reviewBtn, resetBtn);
            if (submitBtn) {
                submitBtn.innerHTML = `<i class="fas fa-paper-plane"></i> ${t('submitToHq')}`;
                console.log('Submit button updated to (regular):', submitBtn.innerHTML);
            }
            if (reviewBtn) {
                reviewBtn.innerHTML = `<i class="fas fa-edit"></i> ${t('reviewData')}`;
                console.log('Review button updated to (regular):', reviewBtn.innerHTML);
            }
            if (resetBtn) {
                resetBtn.innerHTML = `<i class="fas fa-redo"></i> ${t('startOver')}`;
                console.log('Reset button updated to (regular):', resetBtn.innerHTML);
            }

            // Verification status
            const verificationStatusElement = document.getElementById('verificationStatus');
            if (verificationStatusElement) {
                const statusElements = verificationStatusElement.querySelectorAll('.status-title, .confidence-badge');
                if (statusElements.length >= 2) {
                    statusElements[0].textContent = t('allFieldsVerified');
                    statusElements[1].textContent = t('highConfidence');
                }
            }

            // Developer credit
            const developerCredit = document.querySelector('.developer-credit');
            console.log('Developer credit element (regular):', developerCredit);
            if (developerCredit) {
                developerCredit.textContent = t('developerCredit');
                console.log('Developer credit updated to (regular):', developerCredit.textContent);
            }

            // Update history display if it exists
            console.log('Calling updateHistoryDisplay');
            updateHistoryDisplay();

            // Update OCR tips
            const ocrTipsElement = document.getElementById('ocrTips');
            if (ocrTipsElement) {
                const ocrTipsTitle = ocrTipsElement.querySelector('h4');
                const ocrTipsList = ocrTipsElement.querySelectorAll('li');
                
                if (ocrTipsTitle) {
                    ocrTipsTitle.innerHTML = `<i class="fas fa-lightbulb"></i> ${t('ocrTipsTitle')}`;
                }
                
                if (ocrTipsList.length >= 5) {
                    ocrTipsList[0].textContent = t('ocrTipLighting');
                    ocrTipsList[1].textContent = t('ocrTipSteady');
                    ocrTipsList[2].textContent = t('ocrTipEdges');
                    ocrTipsList[3].textContent = t('ocrTipBlur');
                    ocrTipsList[4].textContent = t('ocrTipFormats');
                }
            }

            // Update AI indicator text if visible
            const aiIndicator = document.getElementById('aiConfidenceIndicator');
            if (aiIndicator) {
                aiIndicator.innerHTML = '<i class="fas fa-robot"></i> ' + t('aiSelected');
            }

            // Update editable table elements
            const tableHeader = document.querySelector('.table-header h3');
            if (tableHeader) {
                tableHeader.textContent = t('reviewEditExtractedData');
            }

            const saveChangesBtn = document.getElementById('saveChangesBtn');
            if (saveChangesBtn) {
                saveChangesBtn.innerHTML = `<i class="fas fa-save"></i> ${t('saveChanges')}`;
            }

            const saveAccumulationBtn = document.getElementById('saveAccumulationBtn');
            if (saveAccumulationBtn) {
                updateSendButtonLabel();
            }

            // Update table headers
            const tableHeaders = document.querySelectorAll('#editableTable th');
            if (tableHeaders.length >= 3) {
                tableHeaders[0].textContent = t('field');
                tableHeaders[1].textContent = t('value');
                tableHeaders[2].textContent = t('status');
            }

            // Update existing table rows if table is visible
            const dataTableContainer = document.getElementById('dataTableContainer');
            if (dataTableContainer && dataTableContainer.style.display !== 'none') {
                // Table removed in Phase 5D-5 - no longer needed
                // populateEditableTable();
            }

            // Update field labels based on current form values
            updateFieldLabels();

        }

        // DOM Elements
        const welcomeModal = document.getElementById('welcomeModal');
        const profileModal = document.getElementById('profileModal');
        const appContainer = document.getElementById('appContainer');
        const registrationForm = document.getElementById('registrationForm');
        const profileForm = document.getElementById('profileForm');
        const userNameInput = document.getElementById('userName');
        const loginIdentifierInput = document.getElementById('loginIdentifier');
        const passwordInput = document.getElementById('password');
        const updateUserNameInput = document.getElementById('updateUserName');

        // Parse URL parameters for auto-fill
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('userName')) {
            userNameInput.value = urlParams.get('userName');
        }
        if (urlParams.has('userEmail')) {
            userEmailInput.value = urlParams.get('userEmail');
        }
        if (urlParams.has('employeeId')) {
            employeeIdInput.value = urlParams.get('employeeId');
        }

        const updateUserEmailInput = document.getElementById('updateUserEmail');
        const updateEmployeeIdInput = document.getElementById('updateEmployeeId');
        const displayUserName = document.getElementById('displayUserName');
        const displayUserEmail = document.getElementById('displayUserEmail');
        const userAvatar = document.getElementById('userAvatar');
        const profileButton = document.getElementById('profileButton');
        const cancelProfileUpdate = document.getElementById('cancelProfileUpdate');
        const cameraButton = document.getElementById('cameraButton');
        const uploadButton = document.getElementById('uploadButton');
        const fileInput = document.getElementById('fileInput');
        const dropzone = document.getElementById('dropzone');
        const imagePlaceholder = document.getElementById('imagePlaceholder');
        const receiptImage = document.getElementById('receiptImage');
        const verificationStatus = document.getElementById('verificationStatus');
        const reviewDataBtn = document.getElementById('reviewDataBtn');
        const resetButton = document.getElementById('resetButton');
        const historyList = document.getElementById('historyList');
        const toastContainer = document.getElementById('toastContainer');
        const settingsButton = document.getElementById('settingsButton');
        const settingsModal = document.getElementById('settingsModal');
        const saveSettings = document.getElementById('saveSettings');
        const cancelSettings = document.getElementById('cancelSettings');
        const ocrDebugPanel = document.getElementById('ocrDebugPanel');
        const ocrDebugContent = document.getElementById('ocrDebugContent');
        const businessLocationSelect = document.getElementById('businessLocationSelect');
        const staffMemberSelect = document.getElementById('staffMemberSelect');
        const businessLocationLabel = document.querySelector('label[for="businessLocationSelect"]');
        const saveAccumulationBtn = document.getElementById('saveAccumulationBtn');
        const saveResultMessage = document.getElementById('saveResultMessage');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingMessage = document.getElementById('loadingMessage');
        const loadingSubtext = document.getElementById('loadingSubtext');
        const loadingStepUpload = document.getElementById('loadingStepUpload');
        const loadingStepQueue = document.getElementById('loadingStepQueue');
        const loadingStepExtraction = document.getElementById('loadingStepExtraction');

        if (staffMemberSelect) {
            staffMemberSelect.disabled = true;
            staffMemberSelect.innerHTML = `<option value="">${t('selectLocationFirst')}</option>`;
        }

        if (businessLocationSelect) {
            businessLocationSelect.addEventListener('change', () => {
                userLocationOverride = true;
                updateSendButtonLabel();
                handleLocationChange();
                
                // Capture the location change to current draft
                if (window.currentDraftId) {
                    captureTableEditsToCurrentDraft();
                }
            });
        }

        // Also add for staff select:
        if (staffMemberSelect) {
            staffMemberSelect.addEventListener('change', () => {
                // Capture staff change to current draft
                if (window.currentDraftId) {
                    captureTableEditsToCurrentDraft();
                }
            });
        }

        // Global variables
        let currentQueueId = null;
        let currentImageData = null; // Store base64 image data for Railway deployment
        let accountClassifications = []; // Store loaded account classifications
        const LATEST_ANALYSIS_KEY = 'tashiro_latest_analysis_v1';
        
        // Phase 5D: Global state variables
        window.batchDraftsById = {};
        window.batchOrder = [];
        window.draftEditsById = {};
        window.currentDraftId = null;
        window.previewByDraftId = {};
        window.allDrafts = [];

        // Other global state
        let pendingFiles = [];
        let userLocationOverride = false;
        let pendingStaffSelection = null;
        
        // JWT Authentication Helper
        function apiFetch(url, options = {}) {
            const token = localStorage.getItem('auth_token');
            if (token && !url.includes('/auth/')) {
                options.headers = {
                    ...options.headers,
                    'Authorization': `Bearer ${token}`
                };
            }
            return fetch(url, options);
        }

        // Translation fallback helper (Phase 5D-0)
        function tSafe(key, fallback) {
            const value = t(key);
            return (!value || value === key) ? fallback : value;
        }
        
        // Phase 5D-1: Centralized engine status text
        function getEngineStatusText(engine) {
            const engineLower = (engine || 'auto').toLowerCase();
            
            if (engineLower === 'document_ai') {
                return tSafe('engineDocumentAI', 'Document AI engine is processing your receipts.');
            } else if (engineLower === 'standard') {
                return tSafe('engineStandard', 'Google Vision and OpenAI engines are processing your receipts.');
            } else {
                return tSafe('engineHybrid', 'Hybrid mode: Document AI + standard engines are processing your receipts.');
            }
        }
        
        let pollTimeoutHandle = null;
        const POLL_INTERVAL_MS = 3000;
        const MAX_POLL_ATTEMPTS = 40;
        const MAX_BATCH = 4; // Backend enforces max 4 receipts
        let availableLocations = [];
        let locationSynonymMap = {};

        // Check if user is already registered
        function checkUserRegistration() {
            const userData = localStorage.getItem('tashiro_user');
            if (userData) {
                const user = JSON.parse(userData);
                displayUserInfo(user);
                welcomeModal.style.display = 'none';
                appContainer.style.display = 'block';
                return true;
            }
            return false;
        }

        // Display user information in the header
        function displayUserInfo(user) {
            displayUserName.textContent = user.name;
            displayUserEmail.textContent = user.email;
            userAvatar.textContent = user.name.substring(0, 2).toUpperCase();
            
            // Set values in profile update form
            updateUserNameInput.value = user.name;
            updateUserEmailInput.value = user.email;
            updateEmployeeIdInput.value = user.employeeId || '';
        }

        // Handle registration form submission
        registrationForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const identifier = loginIdentifierInput.value.trim();
            const password = passwordInput.value;
            
            if (!identifier) {
                showToast('Please enter your Login ID or Email', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: identifier, password })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Invalid Login ID/Email or Password');
                }
                
                const data = await response.json();
                localStorage.setItem('auth_token', data.access_token);
                
                // Store user data from server response
                const userData = {
                    name: data.user?.name || userNameInput.value,
                    email: data.user?.email || (identifier.includes('@') ? identifier : null),
                    employeeId: data.user?.login_id || identifier,
                    role: data.user?.role || 'WORKER'
                };
                
                localStorage.setItem('tashiro_user', JSON.stringify(userData));
                
                // Phase 5E: Role-based redirect
                if (userData.role === 'ADMIN' || userData.role === 'HQ') {
                    // Redirect to office view for admins
                    window.location = '/office';
                    return;
                }
                
                // Phase 5D-2.1: Refresh AuthState after login
                if (window.refreshAuthState) {
                    window.refreshAuthState();
                }
                
                // Update UI with user info (workers only)
                displayUserInfo(userData);
                
                // Hide modal and show app
                welcomeModal.style.display = 'none';
                appContainer.style.display = 'block';
                
                // Show welcome toast
                showToast(t('welcomeMessage', {name: userData.name}), 'success');
            } catch (error) {
                showToast('Login failed: ' + error.message, 'error');
            }
        });

        function saveLatestAnalysis(queueId, fields) {
            try {
                const fieldWhitelist = ['date','vendor','total','invoice_number','tax_category','account_title','tax','currency','staff_member'];
                const sanitized = {};
                fieldWhitelist.forEach(key => sanitized[key] = fields[key] || '');
                localStorage.setItem(LATEST_ANALYSIS_KEY, JSON.stringify({
                    queue_id: queueId,
                    fields: sanitized,
                    timestamp: new Date().toISOString()
                }));
            } catch (err) {
                console.warn('Failed to persist latest analysis', err);
            }
        }

        function restoreLatestAnalysis() {
            try {
                const cached = localStorage.getItem(LATEST_ANALYSIS_KEY);
                if (!cached) {
                    return;
                }
                const parsed = JSON.parse(cached);
                if (!parsed.fields) {
                    return;
                }
                currentQueueId = parsed.queue_id || null;
                applyOcrResultsToForm(parsed.fields);
                if (reviewDataBtn) reviewDataBtn.disabled = false;
                renderOcrDebugPanel(parsed.fields, parsed.queue_id);
                showToast('Restored latest analysis', 'info');
            } catch (err) {
                console.warn('Failed to restore cached analysis', err);
            }
        }

        function loadLocationsFromServer() {
            apiFetch('/api/locations')
                .then(resp => resp.json())
                .then(data => {
                    availableLocations = data.locations || [];
                    locationSynonymMap = data.synonyms || {};
                    populateLocationSelect();
                })
                .catch(err => {
                    console.warn('Failed to load locations', err);
                    resetStaffSelect('staffLoadError');
                });
        }

        function populateLocationSelect(locations = availableLocations, selectedValue = null) {
            if (!businessLocationSelect) {
                return;
            }
            const normalizedLocations = Array.isArray(locations) ? locations : [];
            const desiredValue = selectedValue ?? businessLocationSelect.value;
            businessLocationSelect.innerHTML = `<option value="">${t('selectLocation')}</option>`;
            normalizedLocations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                businessLocationSelect.appendChild(option);
            });
            if (desiredValue && normalizedLocations.includes(desiredValue)) {
                businessLocationSelect.value = desiredValue;
            }
            updateSendButtonLabel();
            handleLocationChange();
        }

        function resetStaffSelect(messageKey = 'selectLocationFirst') {
            if (!staffMemberSelect) {
                return;
            }
            staffMemberSelect.disabled = true;
            staffMemberSelect.innerHTML = `<option value="">${t(messageKey)}</option>`;
            staffMemberSelect.dataset.location = '';
        }

        function handleLocationChange() {
            if (!businessLocationSelect || !staffMemberSelect) {
                return;
            }
            const selectedLocation = businessLocationSelect.value;
            const previousLocation = staffMemberSelect.dataset.location || '';
            if (previousLocation === selectedLocation && staffMemberSelect.options.length > 1) {
                return; // Already loaded for this location
            }
            if (!selectedLocation) {
                pendingStaffSelection = null;
                resetStaffSelect('selectLocationFirst');
                return;
            }

            staffMemberSelect.disabled = true;
            staffMemberSelect.innerHTML = `<option value="">${t('loadingStaff')}</option>`;

            apiFetch(`/api/staff?location=${encodeURIComponent(selectedLocation)}`)
                .then(resp => {
                    if (!resp.ok) {
                        throw new Error('staff-fetch-failed');
                    }
                    return resp.json();
                })
                .then(data => {
                    const staffList = Array.isArray(data.staff) ? data.staff : [];
                    if (!staffList.length) {
                        resetStaffSelect('noStaffFound');
                        return;
                    }
                    staffMemberSelect.disabled = false;
                    staffMemberSelect.innerHTML = `<option value="">${t('selectStaff')}</option>`;
                    staffList.forEach(member => {
                        const option = document.createElement('option');
                        // Use member.id as value (staff_id), display member.name
                        option.value = member.id;
                        option.textContent = member.name;
                        staffMemberSelect.appendChild(option);
                    });
                    staffMemberSelect.dataset.location = selectedLocation;

                    if (pendingStaffSelection && staffList.some(member => member.id === pendingStaffSelection)) {
                        staffMemberSelect.value = pendingStaffSelection;
                    }
                    pendingStaffSelection = null;
                })
                .catch(err => {
                    console.warn('Staff fetch failed', err);
                    resetStaffSelect('staffLoadError');
                });
        }

        function updateSendButtonLabel() {
            if (!saveAccumulationBtn) {
                return;
            }
            let label = t('saveToHQ');
            if (businessLocationSelect && businessLocationSelect.value) {
                const index = businessLocationSelect.selectedIndex;
                const readable = businessLocationSelect.options[index]?.textContent || businessLocationSelect.value;
                label = t('saveReceiptToLocation', { location: readable });
            }
            saveAccumulationBtn.innerHTML = `<i class="fas fa-paper-plane"></i> ${label}`;
        }

        function guessLocationFromFields(fields) {
            if (!fields) {
                return null;
            }
            const possibleSources = [fields.business_office, fields.location, fields.vendor, fields.store_name];
            const candidates = possibleSources.filter(Boolean).map(text => text.toString().toLowerCase());
            if (!candidates.length) {
                return null;
            }
            for (const candidate of candidates) {
                for (const loc of availableLocations) {
                    if (candidate.includes(loc.toLowerCase())) {
                        return loc;
                    }
                }
                for (const [synonym, canonical] of Object.entries(locationSynonymMap)) {
                    if (candidate.includes(synonym.toLowerCase())) {
                        return canonical;
                    }
                }
            }
            return null;
        }

        // Handle profile update
        profileButton.addEventListener('click', function() {
            profileModal.style.display = 'flex';
        });

        cancelProfileUpdate.addEventListener('click', function() {
            profileModal.style.display = 'none';
        });

        // Handle settings
        settingsButton.addEventListener('click', function() {
            loadSettings();
            settingsModal.style.display = 'flex';
        });

        cancelSettings.addEventListener('click', function() {
            settingsModal.style.display = 'none';
        });

        saveSettings.addEventListener('click', function() {
            // Close modal immediately
            settingsModal.style.display = 'none';
            
            // Save settings and apply them
            saveSettingsToStorage();
            
            // Show success toast
            showToast(t('settingsSaved'), 'success');
        });

        function updateLoadingSteps(activeStep) {
            const steps = [loadingStepUpload, loadingStepQueue, loadingStepExtraction];
            steps.forEach((step, index) => {
                if (!step) return;
                if (index <= activeStep) {
                    step.style.fontWeight = '700';
                    step.style.color = 'var(--primary-blue)';
                } else {
                    step.style.fontWeight = '400';
                    step.style.color = 'var(--dark-gray)';
                }
            });
        }

        function showLoadingOverlay({ message, subtext, stepIndex }) {
            if (!loadingOverlay) {
                return;
            }
            loadingOverlay.classList.add('active');
            if (loadingMessage && message) {
                loadingMessage.textContent = message;
            }
            if (loadingSubtext && subtext) {
                loadingSubtext.textContent = subtext;
            }
            updateLoadingSteps(stepIndex ?? 0);
        }

        function hideLoadingOverlay() {
            if (loadingOverlay) {
                loadingOverlay.classList.remove('active');
            }
        }

        profileForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const userData = {
                name: updateUserNameInput.value,
                email: updateUserEmailInput.value,
                employeeId: updateEmployeeIdInput.value || null
            };
            
            // Save updated user data
            localStorage.setItem('tashiro_user', JSON.stringify(userData));
            
            // Update UI with new user info
            displayUserInfo(userData);
            
            // Hide modal
            profileModal.style.display = 'none';
            
            // Show success toast
            showToast(t('profileUpdated'), 'success');
        });

        // Handle camera button click
        cameraButton.addEventListener('click', function() {
            // Trigger the file input with camera capture
            fileInput.setAttribute('capture', 'environment');
            fileInput.click();
        });

        // Handle upload button click
        uploadButton.addEventListener('click', function() {
            // Remove camera capture attribute for file upload
            fileInput.removeAttribute('capture');
            fileInput.click();
        });

        // Handle file selection
        fileInput.addEventListener('change', function(e) {
            console.log('üìÅ File input changed, files selected:', e.target.files.length);
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            console.log('üìÇ Processing selected files...');
            // Phase 5D: Append files to pending queue up to max 4
            files.forEach(file => {
                if (pendingFiles.length >= MAX_BATCH) {
                    console.log('‚ö†Ô∏è Maximum batch size reached');
                    showToast(`Maximum ${MAX_BATCH} receipts allowed`, 'warning');
                    return;
                }

                console.log(`  ‚ûï Adding file: ${file.name} (${file.size} bytes)`);
                // Create file entry with preview
                const fileEntry = {
                    file: file,
                    previewUrl: null,
                    filename: file.name,
                    status: 'pending'
                };

                // Generate preview blob URL and store by index
                const previewUrl = URL.createObjectURL(file);
                window.previewByIndex[pendingFiles.length] = previewUrl;
                fileEntry.previewUrl = previewUrl;

                pendingFiles.push(fileEntry);
            });

            console.log('üìä Total pending files:', pendingFiles.length);
            updatePendingFilesUI();
            e.target.value = ''; // Reset input
        });

        // Handle drag and drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropzone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropzone.classList.add('active');
        }

        function unhighlight() {
            dropzone.classList.remove('active');
        }

        dropzone.addEventListener('drop', function(e) {
            const dt = e.dataTransfer;
            const files = Array.from(dt.files);
            
            if (files.length === 0) return;
            
            // Phase 5D: Append files to pending queue up to max 4
            files.forEach(file => {
                if (pendingFiles.length >= MAX_BATCH) {
                    showToast(`Maximum ${MAX_BATCH} receipts allowed`, 'warning');
                    return;
                }
                
                const fileEntry = {
                    file: file,
                    previewUrl: null,
                    filename: file.name,
                    status: 'pending'
                };
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    fileEntry.previewUrl = event.target.result;
                    updatePendingFilesUI();
                };
                reader.readAsDataURL(file);
                
                pendingFiles.push(fileEntry);
            });
            
            updatePendingFilesUI();
        });

        // Phase 5D: Mobile Screen Navigation
        function setActiveScreen(screenId) {
            // Only run on mobile
            if (window.innerWidth > 768) return;
            
            // Hide all screens
            document.querySelectorAll('.mobile-screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            // Show selected screen
            const screen = document.getElementById(screenId);
            if (screen) screen.classList.add('active');
            
            const btn = document.querySelector(`[data-screen="${screenId}"]`);
            if (btn) btn.classList.add('active');
        }
        
        // Mobile nav button listeners
        setTimeout(() => {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (!this.disabled) {
                        setActiveScreen(this.dataset.screen);
                    }
                });
            });
        }, 500);
        
        // Phase 5D: Pending Files UI - Preview Tiles
        function updatePendingFilesUI() {
            const container = document.getElementById('pendingFilesContainer');
            const tilesContainer = document.getElementById('pendingFilesTiles');
            const fileCount = document.getElementById('pendingFileCount');
            const startBtn = document.getElementById('startOcrBtn');
            
            if (pendingFiles.length === 0) {
                if (container) container.style.display = 'none';
                if (startBtn) startBtn.disabled = true;
                return;
            }
            
            if (container) container.style.display = 'block';
            if (fileCount) fileCount.textContent = pendingFiles.length;
            if (startBtn) startBtn.disabled = false;
            
            if (tilesContainer) {
                tilesContainer.innerHTML = pendingFiles.map((entry, index) => {
                    return `
                        <div style="position: relative; padding: 8px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; text-align: center; cursor: default;">
                            ${entry.previewUrl ? 
                                `<img src="${entry.previewUrl}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 6px; margin-bottom: 6px;">` :
                                `<div style="width: 80px; height: 80px; background: #e2e8f0; border-radius: 6px; display: flex; align-items: center; justify-content: center; margin-bottom: 6px;"><i class="fas fa-file-image" style="color: #94a3b8; font-size: 24px;"></i></div>`
                            }
                            <div style="font-size: 11px; color: #64748b; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${entry.filename}</div>
                            <div style="font-size: 10px; color: #94a3b8; margin-top: 2px;">${(entry.file.size / 1024).toFixed(0)}KB</div>
                            <button onclick="removePendingFile(${index})" style="position: absolute; top: -6px; right: -6px; width: 20px; height: 20px; border-radius: 50%; background: #ef4444; color: white; border: none; cursor: pointer; font-size: 10px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function removePendingFile(index) {
            pendingFiles.splice(index, 1);
            updatePendingFilesUI();
        }
        
        // Clear all pending files
        document.getElementById('clearPendingBtn')?.addEventListener('click', function() {
            pendingFiles = [];
            updatePendingFilesUI();
        });
        
        // Start OCR button handler
        document.getElementById('startOcrBtn')?.addEventListener('click', function() {
            console.log('üîò Start OCR button clicked');
            console.log('üìÅ Pending files:', pendingFiles.length);
            pendingFiles.forEach((file, i) => {
                console.log(`  ${i+1}. ${file.filename} (${file.file.size} bytes)`);
            });

            if (pendingFiles.length === 0) {
                showToast('No files selected', 'warning');
                return;
            }
            startOcrProcessing();
        });
        
        async function startOcrProcessing() {
            console.log('üöÄ Starting OCR processing...');
            console.log('üìä Pending files count:', pendingFiles.length);

            if (pendingFiles.length === 0) {
                console.log('‚ùå No files to process');
                showToast('No files selected', 'warning');
                return;
            }

            console.log('‚è≥ Showing loading overlay...');
            const settings = JSON.parse(localStorage.getItem('tashiro_settings') || '{}');
            const engine = (settings.ocrEngine || 'auto').toLowerCase();
            const engineSubtext = getEngineStatusText(engine);
            showLoadingOverlay({
                message: tSafe('ocrInProgress', 'OCR in progress‚Ä¶'),
                subtext: engineSubtext,
                stepIndex: 0
            });

            console.log('ÔøΩ Step 1: Waiting for OCR engines...');
            console.log(`üîß OCR Engine: ${engine}`);
            console.log(`üìä Processing ${pendingFiles.length} file(s)`);
            updateLoadingSteps(1);
            if (loadingSubtext) loadingSubtext.textContent = engineSubtext.replace('processing your receipts', 'uploading files...');

            // Get OCR engine from settings
            const selectedEngine = settings.ocrEngine || 'auto';

            // Create FormData with files and OCR engine
            const formData = new FormData();
            pendingFiles.forEach((entry, index) => {
                formData.append('files', entry.file);
            });
            formData.append('ocr_engine', selectedEngine);  // ‚úÖ ADDED: Send OCR engine to backend

            try {
            // Create abort controller for timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 120000); // 2 minutes

            console.log('üåê Making API call to /api/drafts/batch-upload...');
            const response = await apiFetch('/api/drafts/batch-upload', {
                method: 'POST',
                body: formData,
                signal: controller.signal
            });

            clearTimeout(timeoutId);
            console.log('üì° API response received, status:', response.status);

            if (!response.ok) {
                const errorData = await response.json();
                console.error('‚ùå API error:', errorData);
                throw new Error(errorData.detail || 'Batch upload failed');
            }

            console.log('üì° Step 2: Extracting fields...');
            updateLoadingSteps(2);
            if (loadingSubtext) loadingSubtext.textContent = engineSubtext.replace('processing your receipts', 'extracting receipt fields...');

            const result = await response.json();
            console.log('üìã API result:', result);
            console.log('üìä Batch processing summary:');
            console.log(`   Total: ${result.total || 0}`);
            console.log(`   Succeeded: ${result.succeeded || 0}`);
            console.log(`   Failed: ${result.failed || 0}`);
            
            const apiResults = result.results || [];
            
            // Log detailed information for each receipt
            apiResults.forEach((apiResult, index) => {
                console.log(`\nüìÑ Receipt ${index + 1}: ${apiResult.filename}`);
                console.log(`   Status: ${apiResult.status}`);
                
                if (apiResult.status === 'success') {
                    const data = apiResult.extracted_data || {};
                    console.log(`   Draft ID: ${apiResult.draft_id}`);
                    console.log(`   Vendor: ${data.vendor_name || 'N/A'}`);
                    console.log(`   Date: ${data.receipt_date || 'N/A'}`);
                    console.log(`   Total: ${data.total_amount || 0}`);
                    console.log(`   Invoice: ${data.invoice_number || 'N/A'}`);
                    console.log(`   Tax Category: ${data.tax_category || 'N/A'}`);
                    console.log(`   Account Title: ${data.account_title || 'N/A'}`);
                    console.log(`   Currency: ${data.currency || 'N/A'}`);
                    console.log(`   OCR Engine: ${data.ocr_engine || 'N/A'}`);
                    console.log(`   OCR Confidence: ${data.ocr_confidence || 0}%`);
                } else {
                    console.log(`   Error: ${apiResult.error || 'Unknown error'}`);
                    console.log(`   Error Code: ${apiResult.error_code || 'N/A'}`);
                }
            });

            // Store OCR analysis for debugging
            if (apiResults.length > 0 && apiResults[0].status === 'success') {
                // Store only a small, sanitized summary to avoid exceeding localStorage quotas
                const fieldWhitelist = ['date','vendor','total','invoice_number','tax_category','account_title','tax','currency','staff_member'];
                const sanitizedFields = {};
                const srcFields = apiResults[0].extracted_data || {};
                fieldWhitelist.forEach(k => sanitizedFields[k] = srcFields[k] || '');

                const latestAnalysis = {
                    timestamp: new Date().toISOString(),
                    queue_id: apiResults[0].draft_id,
                    fields: sanitizedFields,
                    batch_summary: {
                        total: result.total,
                        succeeded: result.succeeded,
                        failed: result.failed
                    }
                };

                try {
                    const candidate = JSON.stringify(latestAnalysis);
                    const sizeLimit = 100 * 1024; // 100 KB soft limit
                    if (candidate.length > sizeLimit) {
                        console.warn('Sanitized analysis exceeds size limit; skipping persistence to avoid quota issues', {size: candidate.length});
                    } else {
                        localStorage.setItem(LATEST_ANALYSIS_KEY, candidate);
                        console.log('üíæ Stored sanitized OCR analysis for debugging:', latestAnalysis);
                    }
                } catch (err) {
                    console.warn('Failed to persist latest analysis (quota/exceeded). Clearing old cache and retrying...', err);
                    try {
                        localStorage.removeItem(LATEST_ANALYSIS_KEY);
                        const candidate = JSON.stringify(latestAnalysis);
                        if (candidate.length <= 100 * 1024) {
                            localStorage.setItem(LATEST_ANALYSIS_KEY, candidate);
                            console.log('üíæ Re-saved sanitized OCR analysis after clearing cache');
                        } else {
                            console.warn('Re-save skipped: sanitized analysis still exceeds size limit', {size: candidate.length});
                        }
                    } catch (err2) {
                        console.warn('Re-save failed; skipping storing latest analysis to avoid repeated quota errors', err2);
                    }
                }
            }

                // Phase 5D-5: Convert API results to new state model
                window.batchDraftsById = {};
                window.batchOrder = [];
                apiResults.forEach((apiResult, index) => {
                    if (apiResult.status === 'success') {
                        // Phase 5D-1: Store preview URL for this draft
                        if (window.previewByIndex[index] && apiResult.draft_id) {
                            window.previewByDraftId[apiResult.draft_id] = window.previewByIndex[index];
                            console.log(`üì∑ Stored preview for draft ${apiResult.draft_id} from index ${index}`);
                        }
                        
                        // Create a draft object from the API result
                        const draft = {
                            draft_id: apiResult.draft_id,
                            index: index,
                            filename: pendingFiles[index]?.filename || `receipt_${index + 1}`,
                            receipt: apiResult.extracted_data || {},
                            ocr_payload: apiResult,
                            status: 'DRAFT',
                            created_at: new Date().toISOString(),
                            image_ref: apiResult.image_ref,  // ‚úÖ FIXED: Use consistent image_ref from backend
                            image_url: null
                        };
                        
                        window.batchDraftsById[apiResult.draft_id] = draft;
                        window.batchOrder.push(apiResult.draft_id);
                    } else {
                        // Handle error case - create draft with error status
                        const errorId = `error_${Date.now()}_${Math.random()}`;
                        const draft = {
                            draft_id: errorId,
                            index: index,
                            filename: pendingFiles[index]?.filename || `receipt_${index + 1}`,
                            receipt: { vendor_name: 'Processing Failed', receipt_date: '', total_amount: 0 },
                            ocr_payload: apiResult,
                            status: 'ERROR',
                            created_at: new Date().toISOString(),
                            error: apiResult.error || 'Processing failed',
                            image_url: null
                        };
                        
                        window.batchDraftsById[errorId] = draft;
                        window.batchOrder.push(errorId);
                    }
                });

                hideLoadingOverlay();

                const successCount = window.batchOrder.filter(id => window.batchDraftsById[id].status === 'DRAFT').length;
                if (successCount > 0) {
                    console.log('‚úÖ Batch processing successful, showing results...');
                    showToast(`Successfully processed ${successCount}/${pendingFiles.length} receipt(s)`, 'success');

                    // Clear pending files and hide the container
                    pendingFiles = [];
                    updatePendingFilesUI();

                    // Show batch tiles and auto-select first draft
                    console.log('üéØ Rendering batch tiles...');
                    renderBatchTiles();
                    console.log('üìù Auto-selecting first draft...');
                    if (window.batchOrder.length > 0) {
                        selectDraftTile(window.batchOrder[0]);
                    }
                    console.log('üìä Batch processing complete - tiles rendered and first draft selected');

                    // Show OCR debug panel with the first result
                    if (window.batchOrder.length > 0 && window.batchDraftsById[window.batchOrder[0]]) {
                        renderDebugPayload(window.batchOrder[0]);
                    }

                    // Enable Review nav and switch on mobile
                    const reviewBtn = document.getElementById('navReviewBtn');
                    if (reviewBtn) {
                        reviewBtn.disabled = false;
                        if (window.innerWidth <= 768) {
                            setActiveScreen('screenReview');
                        }
                    }
                } else {
                    showToast('All receipts failed to process', 'error');
                }

            } catch (error) {
                hideLoadingOverlay();
                showToast(error.message || 'OCR processing failed', 'error');
                console.error('OCR processing error:', error);
            }
        }
        
        function renderBatchTiles() {
            const tilesSection = document.getElementById('batchReceiptTiles');
            const tilesContainer = document.getElementById('receiptTilesContainer');
            const tileCount = document.getElementById('tileCount');
            
            if (window.batchOrder.length === 0) {
                tilesSection.style.display = 'none';
                return;
            }
            
            tilesSection.style.display = 'block';
            tileCount.textContent = window.batchOrder.length;
            
            // Add editing indicator
            const editIndicator = document.getElementById('editingIndicator');
            if (editIndicator && window.batchOrder.length > 0 && window.currentDraftId) {
                const current = window.batchDraftsById[window.currentDraftId];
                const receipt = current?.receipt || {};
                const currentIndex = window.batchOrder.indexOf(window.currentDraftId) + 1;
                editIndicator.innerHTML = `
                    <div style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: #eff6ff; border-radius: 20px; font-size: 13px; color: #1e40af; margin-bottom: 12px;">
                        <i class="fas fa-edit"></i>
                        <span>Editing: Receipt ${currentIndex} of ${window.batchOrder.length}</span>
                        <span style="font-weight: 600;">‚Ä¢ ${receipt.vendor_name || 'Unknown'}</span>
                    </div>
                `;
                editIndicator.style.display = 'block';
            } else if (editIndicator) {
                editIndicator.style.display = 'none';
            }
            
            tilesContainer.innerHTML = window.batchOrder.map(draft_id => {
                const draft = window.batchDraftsById[draft_id];
                const receipt = draft.receipt || {};
                const isActive = draft_id === window.currentDraftId;
                const status = draft.status || 'DRAFT';
                const statusColors = {
                    'DRAFT': '#f59e0b',
                    'SENT': '#10b981',
                    'VALIDATION_FAILED': '#ef4444',
                    'ERROR': '#ef4444'
                };
                const statusColor = statusColors[status] || '#6b7280';
                const imageUrl = window.previewByDraftId[draft_id] || draft.image_url;
                
                return `
                    <div onclick="selectDraftTile('${draft_id}')" style="
                        min-width: 100px;
                        padding: 12px;
                        background: ${isActive ? '#eff6ff' : 'white'};
                        border: 2px solid ${isActive ? '#3b82f6' : '#e2e8f0'};
                        border-radius: 8px;
                        cursor: pointer;
                        transition: all 0.2s;
                        text-align: center;
                        scroll-snap-align: start;
                    ">
                        ${imageUrl ? `
                            <img src="${imageUrl}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px; margin-bottom: 6px;">
                        ` : `<div style="font-size: 24px; margin-bottom: 4px;">üßæ</div>`}
                        <div style="font-size: 12px; font-weight: 600; color: #1e293b; margin-bottom: 4px;">Receipt ${draft.index + 1}</div>
                        <div style="font-size: 11px; color: #64748b; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${receipt.vendor_name || 'No vendor'}</div>
                        <div style="margin-top: 6px; padding: 2px 6px; background: ${statusColor}; color: white; border-radius: 4px; font-size: 10px; font-weight: 600;">${status}</div>
                        ${draft.is_valid === false ? '<div style="margin-top: 4px; color: #ef4444; font-size: 10px;">‚ö†Ô∏è</div>' : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Phase 5D-5: New state management functions
        function captureTableEditsToCurrentDraft() {
            if (!window.currentDraftId) return;
            
            // FIXED: Use the same field names as the backend/render expects
            const edits = {
                receipt_date: document.getElementById('fieldDate')?.value || '',
                vendor_name: document.getElementById('fieldVendor')?.value || '',
                total_amount: document.getElementById('fieldTotal')?.value || '',
                invoice_number: document.getElementById('fieldInvoiceNumber')?.value || '',
                tax_category: document.getElementById('fieldTaxCategory')?.value || '',
                account_title: document.getElementById('fieldAccountTitle')?.value || '',
                tax_amount: document.getElementById('fieldTax')?.value || '',
                currency: document.getElementById('fieldCurrency')?.value || 'JPY',
                business_location_id: document.getElementById('businessLocationSelect')?.value || null,
                staff_id: document.getElementById('staffMemberSelect')?.value || null
            };
            
            window.draftEditsById[window.currentDraftId] = edits;
            console.log(`üìù Captured edits for draft ${window.currentDraftId}:`, edits);
        }
        
        function getMergedDraftReceipt(draft_id) {
            const base = window.batchDraftsById[draft_id]?.receipt || {};
            const overlay = window.draftEditsById[draft_id] || {};
            return { ...base, ...overlay };
        }
        
        // Phase 5D-5.1: Safe tax calculation function (non-crashing)
        function updateTaxCalculations() {
            // If fields exist, compute derived values; otherwise do nothing.
            const taxAmountEl = document.querySelector('[name="tax_amount"], #tax_amount, #taxAmount, #fieldTax');
            const totalEl = document.querySelector('[name="total_amount"], #total_amount, #totalAmount, #fieldTotal');
            // If nothing exists, safely return
            if (!taxAmountEl && !totalEl) return;
            // Do not over-engineer; just keep it non-crashing.
        }
        
        function renderReceiptToTable(draft_id) {
            const merged = getMergedDraftReceipt(draft_id);
            
            // Populate form fields
            const fieldMappings = {
                'fieldDate': merged.receipt_date || '',
                'fieldVendor': merged.vendor_name || '',
                'fieldTotal': merged.total_amount || '',
                'fieldInvoiceNumber': (merged.invoice_number || '').split('\n')[0].trim(), // First line only
                'fieldTax': merged.tax_amount || merged.tax_10_amount || '',
                'fieldCurrency': merged.currency || 'JPY',
                'fieldTaxCategory': merged.tax_category || '',
                'fieldAccountTitle': merged.account_title || '',
                'businessLocationSelect': merged.business_location_id || '',
                'staffMemberSelect': merged.staff_id || ''
            };
            
            Object.entries(fieldMappings).forEach(([fieldId, value]) => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.value = value;
                    
                    // Enable disabled fields if they have values
                    if ((fieldId === 'fieldTaxCategory' || fieldId === 'fieldAccountTitle') && value) {
                        element.disabled = false;
                        element.style.backgroundColor = 'white';
                        element.style.cursor = 'text';
                    }
                }
            });
            
            // Update derived fields if needed (safe call)
            if (typeof updateTaxCalculations === "function") {
                updateTaxCalculations();
            }
        }
        
        function renderDebugPayload(draft_id) {
            const draft = window.batchDraftsById[draft_id];
            if (!draft) {
                console.warn('Cannot render debug: draft not found', draft_id);
                return;
            }
            
            // Get merged data (base + edits)
            const merged = getMergedDraftReceipt(draft_id);
            
            // Call the OCR debug panel renderer
            renderOcrDebugPanel(merged, draft_id);
        }
        
        function selectDraftTile(draft_id) {
            if (!window.batchDraftsById[draft_id]) return;
            
            // Capture current edits
            captureTableEditsToCurrentDraft();
            
            // Update selection
            window.currentDraftId = draft_id;
            
            // Update UI
            renderBatchTiles();
            renderReceiptToTable(draft_id);
            renderDebugPayload(draft_id);
            
            // Set the receipt image
            setReceiptImageForDraft(draft_id);
        }
        
        function setReceiptImageForDraft(draft_id) {
            const draft = window.batchDraftsById[draft_id];
            if (!draft) return;
            
            const receipt = draft.receipt || {};
            const imagePlaceholder = document.getElementById('imagePlaceholder');
            const receiptImage = document.getElementById('receiptImage');
            
            // Try preview from memory first (for current session)
            const previewUrl = window.previewByDraftId && window.previewByDraftId[draft.draft_id];
            
            if (previewUrl) {
                // Use in-memory preview URL
                if (imagePlaceholder) imagePlaceholder.style.display = 'none';
                if (receiptImage) {
                    receiptImage.style.display = 'block';
                    receiptImage.src = previewUrl;
                }
                console.log('üì∑ Showing preview from memory for draft', draft.draft_id);
            } else if (receipt.image_url && imagePlaceholder && receiptImage) {
                if (imagePlaceholder) imagePlaceholder.style.display = 'none';
                if (receiptImage) {
                    receiptImage.style.display = 'block';
                    receiptImage.src = receipt.image_url;
                }
            } else if (draft.image_data && imagePlaceholder && receiptImage) {
                // Handle base64 image data from backend
                if (imagePlaceholder) imagePlaceholder.style.display = 'none';
                if (receiptImage) {
                    receiptImage.style.display = 'block';
                    receiptImage.src = `data:image/jpeg;base64,${draft.image_data}`;
                }
            } else {
                // Fallback: Show placeholder
                if (imagePlaceholder) imagePlaceholder.style.display = 'flex';
                if (receiptImage) receiptImage.style.display = 'none';
            }
        }
        
        function renderDraftInModal(draftId) {
            const draft = window.batchDraftsById[draftId];
            if (!draft) return;
            
            // Get elements
            const imageSection = document.getElementById('draftImagePreviewSection');
            const draftImage = document.getElementById('draftModalImage');
            const imagePlaceholder = document.getElementById('draftModalImagePlaceholder');
            const emptyState = document.getElementById('draftEmptyState');
            const detailsContent = document.getElementById('draftDetailsContent');
            
            // Hide empty state, show content
            if (emptyState) emptyState.style.display = 'none';
            if (imageSection) imageSection.style.display = 'block';
            if (detailsContent) detailsContent.style.display = 'block';
            
            // Handle image display
            const previewUrl = window.previewByDraftId?.[draft.draft_id];
            const imageUrl = draft.receipt?.image_url || draft.image_url;
            const imageData = draft.image_data;
            
            if (previewUrl) {
                // Use in-memory preview
                if (draftImage) {
                    draftImage.src = previewUrl;
                    draftImage.style.display = 'block';
                }
                if (imagePlaceholder) imagePlaceholder.style.display = 'none';
            } else if (imageUrl) {
                // Use server image URL
                if (draftImage) {
                    draftImage.src = imageUrl;
                    draftImage.style.display = 'block';
                }
                if (imagePlaceholder) imagePlaceholder.style.display = 'none';
            } else if (imageData) {
                // Use base64 data
                if (draftImage) {
                    draftImage.src = `data:image/jpeg;base64,${imageData}`;
                    draftImage.style.display = 'block';
                }
                if (imagePlaceholder) imagePlaceholder.style.display = 'none';
            } else {
                // No image available
                if (draftImage) draftImage.style.display = 'none';
                if (imagePlaceholder) imagePlaceholder.style.display = 'flex';
            }
            
            // Render draft details
            if (detailsContent) {
                const merged = getMergedDraftReceipt(draftId);
                detailsContent.innerHTML = `
                    <h4 style="margin-bottom: 12px; color: #374151;">Receipt Details</h4>
                    <div style="display: grid; gap: 8px; font-size: 14px;">
                        <div><strong>Date:</strong> ${merged.receipt_date || 'Not set'}</div>
                        <div><strong>Vendor:</strong> ${merged.vendor_name || 'Not set'}</div>
                        <div><strong>Total:</strong> ${merged.total_amount || 'Not set'}</div>
                        <div><strong>Invoice:</strong> ${merged.invoice_number || 'Not set'}</div>
                        <div><strong>Tax Category:</strong> ${merged.tax_category || 'Not set'}</div>
                        <div><strong>Account Title:</strong> ${merged.account_title || 'Not set'}</div>
                        <div><strong>Status:</strong> ${draft.status || 'Draft'}</div>
                    </div>
                `;
            }
        }
        
        // Legacy function for backward compatibility (deprecated)
        function persistCurrentEditsToState() {
            captureTableEditsToCurrentDraft();
        }
        
        // Legacy function for backward compatibility
        function selectBatchReceipt(index) {
            if (!window.batchOrder || index < 0 || index >= window.batchOrder.length) {
                console.warn('Invalid batch receipt index:', index, 'Available:', window.batchOrder?.length || 0);
                return;
            }
            const draft_id = window.batchOrder[index];
            selectDraftTile(draft_id);
        }
        
        function loadDraftIntoForm(draft) {
            if (!draft) return;
            
            // Load from saved edits if available, otherwise from draft
            const edits = draftEditsById[draft.draft_id];
            const receipt = edits || draft.receipt || {};
            
            // Update current queue ID for compatibility
            currentQueueId = draft.draft_id;
            
            // Populate form fields (with null checks)
            const fieldDate = document.getElementById('fieldDate');
            const fieldVendor = document.getElementById('fieldVendor');
            const fieldTotal = document.getElementById('fieldTotal');
            const fieldInvoice = document.getElementById('fieldInvoiceNumber');
            const fieldTaxCategory = document.getElementById('fieldTaxCategory');
            const fieldAccountTitle = document.getElementById('fieldAccountTitle');
            const fieldTax = document.getElementById('fieldTax');
            const fieldCurrency = document.getElementById('fieldCurrency');
            
            if (fieldDate) fieldDate.value = receipt.receipt_date || '';
            if (fieldVendor) fieldVendor.value = receipt.vendor_name || '';
            if (fieldTotal) fieldTotal.value = receipt.total_amount || '';
            if (fieldInvoice) fieldInvoice.value = receipt.invoice_number || '';
            if (fieldTaxCategory) fieldTaxCategory.value = receipt.tax_category || '';
            if (fieldAccountTitle) fieldAccountTitle.value = receipt.account_title || '';
            
            // Enable tax category and account title fields if they have values
            if (fieldTaxCategory && receipt.tax_category) {
                fieldTaxCategory.disabled = false;
                fieldTaxCategory.style.backgroundColor = 'white';
                fieldTaxCategory.style.cursor = 'text';
            }
            if (fieldAccountTitle && receipt.account_title) {
                fieldAccountTitle.disabled = false;
                fieldAccountTitle.style.backgroundColor = 'white';
                fieldAccountTitle.style.cursor = 'text';
            }
            if (fieldTax) fieldTax.value = receipt.tax_amount || receipt.tax_10_amount || '';
            if (fieldCurrency) fieldCurrency.value = receipt.currency || 'JPY';
            
            // Phase 5D-1: Show image with preview rehydration
            const imagePlaceholder = document.getElementById('imagePlaceholder');
            const receiptImage = document.getElementById('receiptImage');
            const imageUrl = receipt.image_url || draft.image_url;
            const imageData = draft.image_data;
            
            // Try preview from memory first (for current session)
            const previewUrl = window.previewByDraftId && window.previewByDraftId[draft.draft_id];
            
            if (previewUrl) {
                // Use in-memory preview URL
                imagePlaceholder.style.display = 'none';
                receiptImage.style.display = 'block';
                receiptImage.src = previewUrl;
                console.log('üì∑ Showing preview from memory for draft', draft.draft_id);
            } else if (imageUrl && imagePlaceholder && receiptImage) {
                imagePlaceholder.style.display = 'none';
                receiptImage.style.display = 'block';
                receiptImage.src = imageUrl;
            } else if (imageData && imagePlaceholder && receiptImage) {
                // Handle base64 image data from backend
                imagePlaceholder.style.display = 'none';
                receiptImage.style.display = 'block';
                receiptImage.src = `data:image/jpeg;base64,${imageData}`;
            } else {
                // Fallback: Show placeholder
                if (imagePlaceholder) imagePlaceholder.style.display = 'flex';
                if (receiptImage) receiptImage.style.display = 'none';
            }
            
            // Update location and staff
            if (businessLocationSelect && receipt.business_location_id) {
                businessLocationSelect.value = receipt.business_location_id;
                handleLocationChange();
                if (staffMemberSelect && receipt.staff_id) {
                    setTimeout(() => {
                        staffMemberSelect.value = receipt.staff_id;
                    }, 500);
                }
            }
            
            // Show verification status
            if (verificationStatus) verificationStatus.style.display = 'flex';
            
            // Update field labels
            updateFieldLabels();
            
            // Enable review button
            if (reviewDataBtn) reviewDataBtn.disabled = false;
            
            showToast(`Viewing receipt ${currentDraftIndex + 1} of ${batchDrafts.length}`, 'info');
        }

        function resetPollingTimer() {
            if (pollTimeoutHandle) {
                clearTimeout(pollTimeoutHandle);
                pollTimeoutHandle = null;
            }
        }

        // Legacy OCR functions removed - using Phase 5 batch upload system only

        function applyOcrResultsToForm(fields) {
            const fieldDate = document.getElementById('fieldDate');
            const fieldVendor = document.getElementById('fieldVendor');
            const fieldTotal = document.getElementById('fieldTotal');
            const fieldInvoice = document.getElementById('fieldInvoiceNumber');
            const fieldTaxCategory = document.getElementById('fieldTaxCategory');
            const fieldAccountTitle = document.getElementById('fieldAccountTitle');
            const fieldTax = document.getElementById('fieldTax');
            const fieldCurrency = document.getElementById('fieldCurrency');
            
            if (fieldDate) fieldDate.value = fields.date || '';
            if (fieldVendor) fieldVendor.value = fields.vendor || '';
            if (fieldTotal) fieldTotal.value = fields.total || '';
            if (fieldInvoice) fieldInvoice.value = fields.invoice_number || '';

            let taxCategoryValue = fields.tax_category || '';
            if (taxCategoryValue === 'Ë™≤Á®é') {
                taxCategoryValue = 'Ê®ôÊ∫ñÁ®éÁéá';
            }
            if (fieldTaxCategory) fieldTaxCategory.value = taxCategoryValue;

            if (fieldAccountTitle) fieldAccountTitle.value = fields.account_title || '';

            const aiIndicator = document.getElementById('aiConfidenceIndicator');
            if (aiIndicator) {
                if (fields.account_title) {
                    aiIndicator.innerHTML = '<i class="fas fa-robot"></i> ' + t('aiSelected');
                    aiIndicator.style.display = 'inline-flex';
                } else {
                    aiIndicator.style.display = 'none';
                }
            }

            if (fieldTax) fieldTax.value = fields.tax || '';
            if (fieldCurrency) fieldCurrency.value = fields.currency || 'JPY';

            updateFieldLabels();
            if (verificationStatus) verificationStatus.style.display = 'flex';
            renderOcrDebugPanel(fields, currentQueueId);
            saveLatestAnalysis(currentQueueId, fields);
            
            // Enable Review nav on single upload
            const reviewBtn = document.getElementById('navReviewBtn');
            if (reviewBtn) {
                reviewBtn.disabled = false;
                if (window.innerWidth <= 768) {
                    setActiveScreen('screenReview');
                }
            }

            if (businessLocationSelect) {
                const inferredLocation = guessLocationFromFields(fields);
                const hasSelection = Boolean(businessLocationSelect.value);
                if (inferredLocation && (!userLocationOverride || !hasSelection)) {
                    if (businessLocationSelect.value !== inferredLocation) {
                        businessLocationSelect.value = inferredLocation;
                        updateSendButtonLabel();
                    }
                    userLocationOverride = false;
                    pendingStaffSelection = fields.staff_member || null;
                    handleLocationChange();
                } else if (!hasSelection) {
                    pendingStaffSelection = null;
                    resetStaffSelect('selectLocationFirst');
                }
            }
        }

        function renderOcrDebugPanel(fields, queueId) {
            const panel = document.getElementById('ocrDebugPanel');
            const content = document.getElementById('ocrDebugContent');
            if (!panel || !content) {
                console.warn('OCR Debug Panel elements not found');
                return;
            }
            
            // Get OCR engine settings
            const settings = JSON.parse(localStorage.getItem('tashiro_settings') || '{}');
            const configuredEngine = settings.ocrEngine || 'auto';
            
            // Determine actual mode based on configured engine
            let mode = 'Unknown';
            let engines = [];
            if (configuredEngine === 'document_ai') {
                mode = 'Document AI Only';
                engines = ['Google Document AI'];
            } else if (configuredEngine === 'standard') {
                mode = 'Standard (Multi-Engine)';
                engines = ['Google Vision AI', 'OpenAI GPT-4 Vision'];
            } else {
                mode = 'Hybrid (All Engines)';
                engines = ['Google Document AI', 'Google Vision AI', 'OpenAI GPT-4 Vision'];
            }
            
            // Enhanced payload with OCR metadata
            const payload = {
                // OCR Engine Information
                ocr_metadata: {
                    configured_mode: configuredEngine,
                    execution_mode: mode,
                    engines_used: engines,
                    engine_from_response: fields.ocr_engine || fields.engine || 'N/A',
                    confidence_score: fields.ocr_confidence || fields.confidence || 'N/A',
                    processing_time_ms: fields.processing_time || 'N/A'
                },
                
                // Queue Information
                queue_id: queueId || currentQueueId,
                timestamp: new Date().toISOString(),
                
                // Extracted Fields
                extracted_data: {
                    receipt_date: fields.date || fields.receipt_date || '',
                    vendor_name: fields.vendor || fields.vendor_name || '',
                    total_amount: fields.total || fields.total_amount || '',
                    invoice_number: fields.invoice_number || '',
                    tax_category: fields.tax_category || '',
                    account_title: fields.account_title || '',
                    tax_amount: fields.tax || fields.tax_amount || fields.tax_10_amount || '',
                    currency: fields.currency || 'JPY'
                },
                
                // Raw Fields (for debugging)
                raw_fields: fields
            };
            
            content.textContent = JSON.stringify(payload, null, 2);
            panel.style.display = 'block';
        }

        function showResultsTable() {
            populateEditableTable();
            const tableContainer = document.getElementById('dataTableContainer');
            if (tableContainer) tableContainer.style.display = 'block';
            if (reviewDataBtn) reviewDataBtn.style.display = 'none';
            if (saveAccumulationBtn) {
                saveAccumulationBtn.disabled = false;
            }
        }

        // Handle review data button - removed showResultsTable call (2nd table removed)
        // if (reviewDataBtn) {
        //     reviewDataBtn.addEventListener('click', showResultsTable);
        // }

        // Populate editable table with OCR data
        function populateEditableTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            // Get current form values
            const fields = {
                date: { value: document.getElementById('fieldDate')?.value || '', label: t('dateLabel'), type: 'text' },
                vendor: { value: document.getElementById('fieldVendor')?.value || '', label: t('storeNameLabel'), type: 'text' },
                total: { value: document.getElementById('fieldTotal')?.value || '', label: t('totalAmountLabel'), type: 'number' },
                invoice_number: { value: document.getElementById('fieldInvoiceNumber')?.value || '', label: t('invoiceNumberLabel'), type: 'text' },
                tax_category: { value: document.getElementById('fieldTaxCategory')?.value || '', label: t('taxCategoryLabel'), type: 'select' },
                account_title: { value: document.getElementById('fieldAccountTitle')?.value || '', label: t('accountTitleLabel'), type: 'select' },
                tax: { value: document.getElementById('fieldTax')?.value || '', label: t('taxAmountRef'), type: 'number' },
                currency: { value: document.getElementById('fieldCurrency')?.value || '', label: t('currency'), type: 'text' }
            };

            // Create table rows
            Object.keys(fields).forEach(fieldKey => {
                const field = fields[fieldKey];
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid var(--medium-gray)';

                // Field name cell
                const fieldCell = document.createElement('td');
                fieldCell.style.padding = '12px';
                fieldCell.style.fontWeight = '600';
                fieldCell.style.color = 'var(--text-dark)';
                fieldCell.textContent = field.label;
                row.appendChild(fieldCell);

                // Value cell
                const valueCell = document.createElement('td');
                valueCell.style.padding = '12px';

                if (field.type === 'select' && fieldKey === 'tax_category') {
                    // Tax category dropdown
                    const select = document.createElement('select');
                    select.className = 'editable-field';
                    select.dataset.field = fieldKey;
                    select.style.width = '100%';
                    select.style.padding = '8px';
                    select.style.border = '1px solid var(--medium-gray)';
                    select.style.borderRadius = '4px';
                    select.style.background = 'white';

                    const taxOptions = [
                        { value: '', text: t('selectTaxCategory') },
                        { value: 'Ê®ôÊ∫ñÁ®éÁéá', text: 'Ê®ôÊ∫ñÁ®éÁéá (Standard Rate)' },
                        { value: 'ËªΩÊ∏õÁ®éÁéá', text: 'ËªΩÊ∏õÁ®éÁéá (Reduced Rate)' },
                        { value: 'ÈùûË™≤Á®é', text: 'ÈùûË™≤Á®é (Tax Exempt)' }
                    ];

                    taxOptions.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option.value;
                        optionElement.textContent = option.text;
                        if (option.value === field.value) {
                            optionElement.selected = true;
                        }
                        select.appendChild(optionElement);
                    });

                    valueCell.appendChild(select);
                } else if (field.type === 'select' && fieldKey === 'account_title') {
                    // Account title dropdown using official classifications
                    const select = document.createElement('select');
                    select.className = 'editable-field';
                    select.dataset.field = fieldKey;
                    select.style.width = '100%';
                    select.style.padding = '8px';
                    select.style.border = '1px solid var(--medium-gray)';
                    select.style.borderRadius = '4px';
                    select.style.background = 'white';

                    // Add default option
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = t('selectAccountTitle');
                    select.appendChild(defaultOption);

                    // Add options from loaded classifications
                    if (accountClassifications.length > 0) {
                        // Add each category as a direct option
                        accountClassifications.forEach(item => {
                            const optionElement = document.createElement('option');
                            optionElement.value = item.category;
                            optionElement.textContent = `${item.category} (${item.description})`;
                            if (item.category === field.value) {
                                optionElement.selected = true;
                            }
                            select.appendChild(optionElement);
                        });
                    } else {
                        // Fallback to basic options if classifications not loaded
                        const accountOptions = [
                            { value: 'ÊóÖË≤ª‰∫§ÈÄöË≤ª', text: 'ÊóÖË≤ª‰∫§ÈÄöË≤ª (Travel & Transportation)' },
                            { value: '‰ªïÂÖ•ÊùêÊñô', text: '‰ªïÂÖ•ÊùêÊñô (Purchased Materials)' },
                            { value: 'ÁèæÂ†¥Èñ¢‰øÇË≤ª', text: 'ÁèæÂ†¥Èñ¢‰øÇË≤ª (Site Related Expenses)' },
                            { value: '‰∫§ÈöõË≤ª', text: '‰∫§ÈöõË≤ª (Entertainment)' },
                            { value: 'ÂéöÁîüË≤ª', text: 'ÂéöÁîüË≤ª (Welfare)' },
                            { value: 'Ê∞¥ÈÅìÂÖâÁÜ±Ë≤ª', text: 'Ê∞¥ÈÅìÂÖâÁÜ±Ë≤ª (Utilities)' },
                            { value: 'ÈÄö‰ø°Ë≤ª', text: 'ÈÄö‰ø°Ë≤ª (Communication)' },
                            { value: 'ÁßüÁ®éÂÖ¨Ë™≤', text: 'ÁßüÁ®éÂÖ¨Ë™≤ (Taxes & Dues)' },
                            { value: '‰∫ãÂãôÊ∂àËÄóÂìÅË≤ª', text: '‰∫ãÂãôÊ∂àËÄóÂìÅË≤ª (Office Supplies)' },
                            { value: 'ÈÅãË≥É', text: 'ÈÅãË≥É (Freight)' },
                            { value: 'Ê∂àËÄóÂìÅ', text: 'Ê∂àËÄóÂìÅ (Consumables)' },
                            { value: 'Ë´∏‰ºöË≤ª', text: 'Ë´∏‰ºöË≤ª (Membership Fees)' },
                            { value: 'Ë´∏ÈõëË≤ª', text: 'Ë´∏ÈõëË≤ª (Miscellaneous)' }
                        ];

                        accountOptions.forEach(option => {
                            const optionElement = document.createElement('option');
                            optionElement.value = option.value;
                            optionElement.textContent = option.text;
                            if (option.value === field.value) {
                                optionElement.selected = true;
                            }
                            select.appendChild(optionElement);
                        });
                    }

                    valueCell.appendChild(select);
                } else {
                    // Regular text input
                    const input = document.createElement('input');
                    input.type = field.type;
                    input.className = 'editable-field';
                    input.dataset.field = fieldKey;
                    input.value = field.value;
                    input.style.width = '100%';
                    input.style.padding = '8px';
                    input.style.border = '1px solid var(--medium-gray)';
                    input.style.borderRadius = '4px';
                    input.style.background = 'white';
                    valueCell.appendChild(input);
                }

                row.appendChild(valueCell);

                // Status cell
                const statusCell = document.createElement('td');
                statusCell.style.padding = '12px';
                statusCell.innerHTML = `<span style="color: var(--primary-blue); font-weight: 500;">${t('ready')}</span>`;
                row.appendChild(statusCell);

                tableBody.appendChild(row);
            });
        }

        // Handle save to HQ button
        document.getElementById('saveAccumulationBtn').addEventListener('click', function() {
            saveToHeadquarters();
        });

        // Handle save button (merged Save Changes + Save as Draft)
        document.getElementById('saveDraftBtn').addEventListener('click', function() {
            saveDraft();
        });

        // Handle reset button
        resetButton.addEventListener('click', function() {
            resetForm();
        });

        // ============================================================
        // Phase 5D: Draft Modal Event Listeners
        // ============================================================

        // Open Draft Modal
        const openDraftsBtn = document.getElementById('openDraftsBtn');
        if (openDraftsBtn) {
            openDraftsBtn.addEventListener('click', function() {
                console.log('Opening draft modal...');
                const draftModal = document.getElementById('draftModal');
                if (draftModal) {
                    draftModal.style.display = 'block';
                    // Load drafts from backend
                    loadDraftsFromServer();
                }
            });
        }

        // Close Draft Modal
        const closeDraftModalBtn = document.getElementById('closeDraftModalBtn');
        if (closeDraftModalBtn) {
            closeDraftModalBtn.addEventListener('click', function() {
                console.log('Closing draft modal...');
                const draftModal = document.getElementById('draftModal');
                if (draftModal) {
                    draftModal.style.display = 'none';
                }
            });
        }

        // Refresh Drafts Button
        const refreshDraftsBtn = document.getElementById('refreshDraftsBtn');
        if (refreshDraftsBtn) {
            refreshDraftsBtn.addEventListener('click', function() {
                console.log('Refreshing drafts...');
                loadDraftsFromServer();
            });
        }

        // Send Selected Drafts Button
        const sendSelectedDraftsBtn = document.getElementById('sendSelectedDraftsBtn');
        if (sendSelectedDraftsBtn) {
            sendSelectedDraftsBtn.addEventListener('click', async function() {
                console.log('Sending selected drafts...');

                // Get all selected draft checkboxes
                const selectedCheckboxes = document.querySelectorAll('.draft-checkbox:checked');
                const selectedDraftIds = Array.from(selectedCheckboxes).map(cb => cb.value);

                if (selectedDraftIds.length === 0) {
                    showToast('No drafts selected', 'warning');
                    return;
                }

                // Confirm before sending
                if (!confirm(`Send ${selectedDraftIds.length} draft(s) to Excel?`)) {
                    return;
                }

                // Send to backend
                try {
                    const response = await apiFetch('/api/drafts/send', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ draft_ids: selectedDraftIds })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.detail || data.error || 'Failed to send drafts');
                    }

                    // Check if any failed with validation errors
                    const validationFailures = data.results?.filter(r => r.status === 'validation_failed') || [];
                    if (validationFailures.length > 0) {
                        let errorDetails = 'Some receipts failed validation:\n\n';
                        validationFailures.forEach(failure => {
                            errorDetails += `Receipt ${failure.draft_id}:\n`;
                            if (failure.validation_errors) {
                                failure.validation_errors.forEach(err => {
                                    errorDetails += `  ‚Ä¢ ${err}\n`;
                                });
                            }
                            errorDetails += '\n';
                        });
                        alert(errorDetails);
                    }

                    showToast(`Sent: ${data.sent}, Failed: ${data.failed}`, data.failed > 0 ? 'warning' : 'success');

                    // Show results modal
                    displaySendResults(data.results);

                    // Refresh draft list
                    loadDraftsFromServer();

                } catch (error) {
                    console.error('Error sending drafts:', error);
                    showToast(`Error: ${error.message}`, 'error');
                }
            });
        }

        // Draft Filter Buttons
        const filterButtons = document.querySelectorAll('.draft-filter-btn');
        filterButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const filter = this.dataset.filter;

                // Update button states
                filterButtons.forEach(b => {
                    b.style.background = '#e2e8f0';
                    b.style.color = '#475569';
                });
                this.style.background = '#3b82f6';
                this.style.color = 'white';

                // Apply filter to draft list
                filterDrafts(filter);
            });
        });

        // Select All Drafts Checkbox
        const selectAllCheckbox = document.getElementById('selectAllDrafts');
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.draft-checkbox');
                checkboxes.forEach(cb => {
                    cb.checked = this.checked;
                });
                updateDraftSelectionCount();
                updateSendButtonState();
            });
        }

        // Helper: Update selection count display
        function updateDraftSelectionCount() {
            const selectedCount = document.querySelectorAll('.draft-checkbox:checked').length;
            const countElement = document.getElementById('draftSelectionCount');
            if (countElement) {
                countElement.textContent = `${selectedCount} draft${selectedCount !== 1 ? 's' : ''} selected`;
            }
        }

        // Helper: Enable/disable send button based on selection
        function updateSendButtonState() {
            const selectedCount = document.querySelectorAll('.draft-checkbox:checked').length;
            const sendBtn = document.getElementById('sendSelectedDraftsBtn');
            if (sendBtn) {
                if (selectedCount > 0) {
                    sendBtn.disabled = false;
                    sendBtn.style.cursor = 'pointer';
                    sendBtn.style.opacity = '1';
                } else {
                    sendBtn.disabled = true;
                    sendBtn.style.cursor = 'not-allowed';
                    sendBtn.style.opacity = '0.5';
                }
            }
        }

        // Helper: Filter drafts by status
        function filterDrafts(filter) {
            // Implementation depends on how drafts are rendered
            // This is a placeholder that needs to be connected to your draft rendering logic
            console.log('Filtering drafts by:', filter);

            // Re-render draft list with filter
            const currentDrafts = window.allDrafts || [];
            let filteredDrafts = currentDrafts;

            if (filter !== 'all') {
                filteredDrafts = currentDrafts.filter(draft => {
                    if (filter === 'DRAFT') return draft.status === 'DRAFT' || !draft.status;
                    if (filter === 'SENT') return draft.status === 'SENT';
                    if (filter === 'ERROR') return draft.status === 'ERROR';
                    return true;
                });
            }

            renderDraftList(filteredDrafts);
        }

        // Helper: Load drafts from server
        async function loadDraftsFromServer() {
            const container = document.getElementById('draftListContainer');
            if (!container) return;

            // Show loading state
            container.innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: #64748b;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 8px;"></i>
                    <div>Loading drafts...</div>
                </div>
            `;

            try {
                const response = await apiFetch('/api/drafts');

                if (!response.ok) {
                    throw new Error('Failed to load drafts');
                }

                const data = await response.json();
                window.allDrafts = data.drafts || [];

                // Show user indicator if available
                const userIndicator = document.getElementById('draftUserIndicator');
                if (userIndicator && data.user_info) {
                    userIndicator.textContent = `Logged in as: ${data.user_info.name} (${data.user_info.role})`;
                    userIndicator.style.display = 'block';
                }

                // Render drafts
                renderDraftList(window.allDrafts);

            } catch (error) {
                console.error('Error loading drafts:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 8px;"></i>
                        <div>Failed to load drafts</div>
                        <div style="font-size: 12px; margin-top: 8px;">${error.message}</div>
                    </div>
                `;
            }
        }

        // Helper: Render draft list
        function renderDraftList(drafts) {
            const container = document.getElementById('draftListContainer');
            if (!container) return;

            if (!drafts || drafts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #64748b;">
                        <i class="fas fa-inbox" style="font-size: 24px; margin-bottom: 8px;"></i>
                        <div>No drafts found</div>
                    </div>
                `;
                return;
            }

            // Render draft cards
            const html = drafts.map(draft => {
                const statusColor = draft.status === 'SENT' ? '#10b981' :
                                   draft.status === 'ERROR' ? '#ef4444' : '#64748b';

                return `
                    <div class="draft-card" style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;"
                         onclick="selectDraftForPreview('${draft.draft_id}')"
                         onmouseover="this.style.background='#f8fafc'"
                         onmouseout="this.style.background='white'">
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <input type="checkbox" class="draft-checkbox" value="${draft.draft_id}"
                                   onclick="event.stopPropagation(); updateDraftSelectionCount(); updateSendButtonState();"
                                   style="margin-top: 4px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                                    ${draft.receipt?.vendor_name || 'Unknown Vendor'}
                                </div>
                                <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">
                                    ${draft.receipt?.receipt_date || 'No date'} ‚Ä¢ ¬•${draft.receipt?.total_amount || '0'}
                                </div>
                                <div style="font-size: 11px; color: ${statusColor}; font-weight: 500;">
                                    ${draft.status || 'DRAFT'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // Helper: Select draft for preview in detail panel
        function selectDraftForPreview(draft_id) {
            const draft = window.allDrafts?.find(d => d.draft_id === draft_id);
            if (!draft) return;

            const detailContainer = document.getElementById('draftDetailContainer');
            if (!detailContainer) return;

            // Show image if available
            const imageSection = document.getElementById('draftImagePreviewSection');
            const draftImage = document.getElementById('draftModalImage');
            const imagePlaceholder = document.getElementById('draftModalImagePlaceholder');

            // Handle image display (if preview section exists)
            if (imageSection && draftImage && imagePlaceholder) {
                imageSection.style.display = 'block';

                const previewUrl = window.previewByDraftId?.[draft.draft_id];
                const imageUrl = draft.receipt?.image_url || draft.image_url;
                const imageData = draft.image_data;

                if (previewUrl) {
                    draftImage.src = previewUrl;
                    draftImage.style.display = 'block';
                    imagePlaceholder.style.display = 'none';
                } else if (imageUrl) {
                    draftImage.src = imageUrl;
                    draftImage.style.display = 'block';
                    imagePlaceholder.style.display = 'none';
                } else if (imageData) {
                    draftImage.src = `data:image/jpeg;base64,${imageData}`;
                    draftImage.style.display = 'block';
                    imagePlaceholder.style.display = 'none';
                } else {
                    draftImage.style.display = 'none';
                    imagePlaceholder.style.display = 'flex';
                }
            }

            // Hide empty state, show details
            const emptyState = document.getElementById('draftEmptyState');
            if (emptyState) emptyState.style.display = 'none';

            const detailsContent = document.getElementById('draftDetailsContent');
            if (detailsContent) {
                detailsContent.style.display = 'block';
                detailsContent.innerHTML = `
                    <div style="background: #f8fafc; border-radius: 8px; padding: 16px; margin-top: 16px;">
                        <div style="font-size: 13px; color: #475569; margin-bottom: 12px;">
                            <strong>Draft Details</strong>
                        </div>
                        <div style="display: grid; gap: 8px; font-size: 13px;">
                            <div><strong>Vendor:</strong> ${draft.receipt?.vendor_name || 'N/A'}</div>
                            <div><strong>Date:</strong> ${draft.receipt?.receipt_date || 'N/A'}</div>
                            <div><strong>Amount:</strong> ¬•${draft.receipt?.total_amount || '0'}</div>
                            <div><strong>Invoice:</strong> ${draft.receipt?.invoice_number || 'N/A'}</div>
                            <div><strong>Location:</strong> ${draft.receipt?.business_location_id || 'N/A'}</div>
                            <div><strong>Staff:</strong> ${draft.receipt?.staff_id || 'N/A'}</div>
                            <div><strong>Status:</strong> <span style="color: ${draft.status === 'SENT' ? '#10b981' : '#64748b'}">${draft.status || 'DRAFT'}</span></div>
                        </div>
                    </div>
                `;
            }
        }

        // Helper: Display send results
        function displaySendResults(results) {
            const modal = document.getElementById('sendResultsModal');
            const container = document.getElementById('sendResultsContainer');

            if (!modal || !container) return;

            const html = results.map(result => {
                const icon = result.success ?
                    '<i class="fas fa-check-circle" style="color: #10b981;"></i>' :
                    '<i class="fas fa-times-circle" style="color: #ef4444;"></i>';

                return `
                    <div style="padding: 12px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 12px;">
                        ${icon}
                        <div style="flex: 1;">
                            <div style="font-weight: 500;">${result.vendor_name || 'Unknown'}</div>
                            <div style="font-size: 12px; color: #64748b;">${result.message || (result.success ? 'Sent successfully' : 'Failed to send')}</div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
            modal.style.display = 'block';
        }

        // Close send results modal
        const closeSendResultsBtn = document.getElementById('closeSendResultsBtn');
        if (closeSendResultsBtn) {
            closeSendResultsBtn.addEventListener('click', function() {
                const modal = document.getElementById('sendResultsModal');
                if (modal) modal.style.display = 'none';
            });
        }

        function collectEditableFields() {
            const editableFields = document.querySelectorAll('.editable-field');
            const correctedData = {};
            editableFields.forEach(field => {
                const fieldName = field.dataset.field;
                correctedData[fieldName] = field.value;
            });
            return correctedData;
        }

        // Phase 5D: Send to HQ - PUT draft first, then POST to /send
        async function saveToHeadquarters(forceSave = false) {
            if (!currentQueueId) {
                showToast(t('noReceiptData'), 'error');
                return;
            }
            if (!businessLocationSelect || !businessLocationSelect.value) {
                showToast(t('locationRequired'), 'warning');
                businessLocationSelect.focus();
                return;
            }
            if (!staffMemberSelect || !staffMemberSelect.value) {
                showToast(t('staffRequired'), 'warning');
                if (staffMemberSelect) {
                    staffMemberSelect.focus();
                }
                return;
            }

            // Persist any in-table edits back to the form fields before saving/sending.
            const correctedData = collectEditableFields();
            Object.keys(correctedData).forEach(fieldName => {
                const elementId = 'field' + fieldName.charAt(0).toUpperCase() + fieldName.slice(1);
                const element = document.getElementById(elementId);
                if (element) {
                    element.value = correctedData[fieldName];
                }
            });

            const locationValue = businessLocationSelect.value;
            const staffValue = staffMemberSelect.value;
            const taxValue = parseFloat(document.getElementById('fieldTax').value) || 0;

            // ‚úÖ VALIDATION: Ensure location and staff are selected BEFORE sending
            if (!locationValue) {
                alert('‚ùå Please select a Business Location before sending to Excel!');
                return;
            }
            
            if (!staffValue) {
                alert('‚ùå Please select a Staff Member before sending to Excel!');
                return;
            }

            // Phase 5D Step 1: Update draft with current edits + assignment
            const receiptData = {
                vendor_name: document.getElementById('fieldVendor').value,
                receipt_date: document.getElementById('fieldDate').value,
                total_amount: parseFloat(document.getElementById('fieldTotal').value) || 0,
                invoice_number: document.getElementById('fieldInvoiceNumber').value,
                tax_10_amount: taxValue,
                tax_8_amount: 0,
                business_location_id: locationValue,
                staff_id: staffValue
            };

            const draftPayload = {
                receipt: receiptData,
                image_ref: currentQueueId
            };

            showToast('Saving and sending...', 'info');
            
            try {
                // Phase 5D Step 1: PUT /api/drafts/{id} to persist edits
                const existingDraft = batchDrafts.find(d => d.draft_id === currentQueueId);
                if (existingDraft) {
                    const updateResponse = await apiFetch(`/api/drafts/${currentQueueId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(draftPayload)
                    });
                    
                    if (!updateResponse.ok) {
                        throw new Error('Failed to update draft');
                    }
                }
                
                // Phase 5D Step 2: POST /api/drafts/send with draft_id
                const sendResponse = await apiFetch('/api/drafts/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ draft_ids: [currentQueueId] })
                });
                
                if (!sendResponse.ok) {
                    const errorData = await sendResponse.json();
                    throw new Error(errorData.detail || 'Send failed');
                }
                
                const result = await sendResponse.json();
                const draftResult = result.results?.[0];
                
                if (draftResult?.status === 'sent') {
                    showToast('‚úÖ Receipt sent to HQ successfully', 'success');
                    
                    // Update batch draft status
                    const index = batchDrafts.findIndex(d => d.draft_id === currentQueueId);
                    if (index !== -1) {
                        batchDrafts[index].status = 'SENT';
                        renderBatchTiles();
                    }
                    
                    // Show download link if available
                    if (draftResult.download_url && saveResultMessage) {
                        saveResultMessage.style.display = 'block';
                        saveResultMessage.innerHTML = `
                            <div style="padding: 12px; background: #d1fae5; border-radius: 8px; margin-top: 12px;">
                                <strong>‚úÖ Success!</strong> Excel file created.<br>
                                <a href="${draftResult.download_url}" target="_blank" style="color: #3b82f6; text-decoration: none;">
                                    <i class="fas fa-download"></i> Download Excel
                                </a>
                            </div>
                        `;
                    }
                    
                    // Save to history
                    saveToHistory({
                        vendor_name: receiptData.vendor_name,
                        id: currentQueueId,
                        timestamp: new Date().toISOString(),
                        business_location: locationValue,
                        staff_member: staffValue,
                        excel_url: draftResult.download_url
                    });

                    // Reset the form for single receipt flow (non-batch).
                    if (!batchDrafts || batchDrafts.length === 0) {
                        resetForm();
                        currentQueueId = null;
                    }

                } else {
                    // Show error with retry metadata
                    let errorMsg = draftResult?.error || 'Send failed';
                    const attemptCount = draftResult?.attempt_count || 0;
                    
                    // Handle validation failures specially - show all validation errors
                    if (draftResult?.status === 'validation_failed' && draftResult?.validation_errors) {
                        errorMsg = '‚ùå Validation Failed:\n' + draftResult.validation_errors.join('\n');
                        showToast(errorMsg, 'error');
                        
                        // Also show in a more prominent alert
                        alert(`Receipt cannot be sent. Please fix these errors:\n\n${draftResult.validation_errors.join('\n\n')}`);
                    } else {
                        showToast(`‚ùå ${errorMsg} (Attempt: ${attemptCount})`, 'error');
                    }
                    
                    // Update batch draft with error
                    const index = batchDrafts.findIndex(d => d.draft_id === currentQueueId);
                    if (index !== -1) {
                        batchDrafts[index].status = 'ERROR';
                        batchDrafts[index].last_send_error = errorMsg;
                        batchDrafts[index].send_attempt_count = attemptCount;
                        renderBatchTiles();
                    }
                }
                
            } catch (error) {
                console.error('Send error:', error);
                showToast(error.message || 'Failed to send', 'error');
            }
        }

        function handleDuplicateResponse(duplicatePayload) {
            showToast(t('duplicateWarning'), 'warning');
            const userConfirmed = confirm(t('forceSavePrompt'));
            if (userConfirmed) {
                saveToHeadquarters(true);
            }
        }

        function handleSuccessfulSave(apiResult, correctedData) {
            showToast(t('savedReceipt'), 'success');
            if (saveResultMessage) {
                const workbookPath = apiResult.file_path || apiResult.filepath || '';
                const inferredDownload = apiResult.download_url || apiResult.artifact_url || (businessLocationSelect && businessLocationSelect.value ? `/api/accumulation/file?location=${encodeURIComponent(businessLocationSelect.value)}` : '');
                const linkPart = inferredDownload ? `<a href="${inferredDownload}" target="_blank">${t('downloadWorkbook')}</a>` : '';
                saveResultMessage.innerHTML = `Saved to: ${workbookPath}. ${linkPart}`;
                saveResultMessage.style.display = 'block';
            }

            saveToHistory({
                ...correctedData,
                id: currentQueueId,
                timestamp: new Date().toISOString(),
                business_location: businessLocationSelect ? businessLocationSelect.value : '',
                staff_member: staffMemberSelect ? staffMemberSelect.value : '',
                excel_url: apiResult.download_url || apiResult.artifact_url
            });

            // Reset the form after successful save
            resetForm();
        }

        // Save changes from editable table back to form fields
        function saveChanges() {
            const correctedData = collectEditableFields();

            // Update the original form fields with corrected data
            Object.keys(correctedData).forEach(fieldName => {
                const elementId = 'field' + fieldName.charAt(0).toUpperCase() + fieldName.slice(1);
                const element = document.getElementById(elementId);
                if (element) {
                    element.value = correctedData[fieldName];
                }
            });

            // Show success message
            showToast(t('changesSaved'), 'success');

            // Update verification status to show changes were saved
            const verificationStatus = document.getElementById('verificationStatus');
            if (verificationStatus) {
                verificationStatus.innerHTML = `
                    <div class="status-icon">üíæ</div>
                    <div class="status-content">
                        <div class="status-title">${t('changesSaved')}</div>
                        <div class="confidence-badge">${t('readyForHqSave')}</div>
                    </div>
                `;
            }
        }

        // Phase 5D: Save Draft - PUT if exists (from batch), POST if new
        function saveDraft() {
            // Phase 5D-5.3: Save all drafts in batch order
            if (!window.batchOrder || window.batchOrder.length === 0) {
                showToast('No drafts to save', 'error');
                return;
            }

            // Capture current edits before saving
            captureTableEditsToCurrentDraft();

            showToast('Saving drafts...', 'info');

            // Save all drafts in upload order
            const savePromises = window.batchOrder.map(async (draftId) => {
                const merged = getMergedDraftReceipt(draftId);
                const draft = window.batchDraftsById[draftId];

                if (!draft) {
                    console.warn(`Draft ${draftId} not found, skipping`);
                    return Promise.resolve();
                }

                // Prepare payload for this draft
                const payload = {
                    receipt: {
                        vendor_name: merged.vendor_name || '',
                        receipt_date: merged.receipt_date || '',
                        total_amount: parseFloat(merged.total_amount) || 0,
                        invoice_number: merged.invoice_number || '',
                        tax_10_amount: parseFloat(merged.tax_amount || merged.tax_10_amount) || 0,
                        tax_8_amount: 0,
                        tax_category: merged.tax_category || '',
                        account_title: merged.account_title || '',
                        business_location_id: merged.business_location_id || null,
                        staff_id: merged.staff_id || null
                    },
                    image_ref: draft.image_ref,  // Use the original image_ref
                    image_data: null
                };

                // ‚úÖ ALWAYS UPDATE - drafts already exist from batch upload
                return apiFetch(`/api/drafts/${draftId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(async response => {
                    if (response.status === 401) {
                        throw new Error('Authentication required. Please log in and try again.');
                    }

                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.detail || data.error || `Failed to save draft ${draftId}`);
                    }
                    return { draftId, success: true, data };
                })
                .catch(error => {
                    console.error(`Error saving draft ${draftId}:`, error);
                    return { draftId, success: false, error: error.message };
                });
            });

            // Wait for all saves to complete
            Promise.all(savePromises)
                .then(results => {
                    const successes = results.filter(r => r.success).length;
                    const failures = results.filter(r => !r.success).length;

                    // Update local drafts with saved data (including image_url if provided)
                    results.forEach(result => {
                        if (result.success && result.data && window.batchDraftsById[result.draftId]) {
                            // Update the draft with server response data
                            Object.assign(window.batchDraftsById[result.draftId], result.data);
                            // Mark as saved - keep as DRAFT status (backend saves as DRAFT)
                            window.batchDraftsById[result.draftId].status = 'DRAFT';  // ‚úÖ FIXED: Keep as DRAFT
                            window.batchDraftsById[result.draftId].saved_at = new Date().toISOString();
                        }
                    });

                    if (successes > 0) {
                        showToast(`Successfully saved ${successes} draft(s)`, 'success');
                        // Phase 5D-5: Reset intake UI state after successful batch save
                        resetIntakeUIState("batch-save-success");
                        // Refresh the batch tiles to show updated status
                        renderBatchTiles();
                    }

                    if (failures > 0) {
                        showToast(`Failed to save ${failures} draft(s)`, 'error');
                    }
                })
                .catch(error => {
                    console.error('Batch save error:', error);
                    showToast('Failed to save drafts', 'error');
                });
        }

        // Reset the form
        function resetForm() {
            document.getElementById('fieldDate').value = '';
            document.getElementById('fieldVendor').value = '';
            document.getElementById('fieldTotal').value = '';
            document.getElementById('fieldInvoiceNumber').value = '';
            document.getElementById('fieldTaxCategory').value = '';
            document.getElementById('fieldAccountTitle').value = '';
            document.getElementById('fieldTaxCategory').disabled = true;
            document.getElementById('fieldAccountTitle').disabled = true;
            document.getElementById('fieldTaxCategory').style.backgroundColor = '#f8f9fa';
            document.getElementById('fieldAccountTitle').style.backgroundColor = '#f8f9fa';
            document.getElementById('fieldTaxCategory').style.cursor = 'not-allowed';
            document.getElementById('fieldAccountTitle').style.cursor = 'not-allowed';
            document.getElementById('fieldTax').value = '';
            document.getElementById('fieldCurrency').value = 'JPY';
            
            imagePlaceholder.style.display = 'flex';
            receiptImage.style.display = 'none';
            verificationStatus.style.display = 'none';
            if (ocrDebugPanel) {
                ocrDebugPanel.style.display = 'none';
            }
            if (ocrDebugContent) {
                ocrDebugContent.textContent = '';
            }
            localStorage.removeItem(LATEST_ANALYSIS_KEY);
            
            // Hide AI confidence indicator
            const aiIndicator = document.getElementById('aiConfidenceIndicator');
            if (aiIndicator) {
                aiIndicator.style.display = 'none';
            }
            
            // Disable review data button
            reviewDataBtn.disabled = true;
            
            // Hide table and show review button
            document.getElementById('dataTableContainer').style.display = 'none';
            reviewDataBtn.style.display = 'inline-block';
            if (businessLocationSelect) {
                businessLocationSelect.value = '';
            }
            userLocationOverride = false;
            pendingStaffSelection = null;
            resetStaffSelect('selectLocationFirst');
            // Keep saveResultMessage visible after reset so user can download
            // if (saveResultMessage) {
            //     saveResultMessage.style.display = 'none';
            //     saveResultMessage.textContent = '';
            // }
            if (saveAccumulationBtn) {
                saveAccumulationBtn.disabled = true;
            }
            updateSendButtonLabel();
            
            // Phase 5D-1: Clear ALL batch processing state
            batchDrafts = [];
            pendingFiles = [];
            currentDraftIndex = 0;
            draftEditsById = {};
            
            // Reset file input
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.value = '';
            }
            
            // Update UI for pending files
            updatePendingFilesUI();
            
            // Hide batch tiles
            const batchTiles = document.getElementById('batchReceiptTiles');
            if (batchTiles) {
                batchTiles.style.display = 'none';
            }
            
            // Clear batch tile container
            const tileContainer = document.getElementById('receiptTilesContainer');
            if (tileContainer) {
                tileContainer.innerHTML = '';
            }
            
            // Update tile count
            const tileCount = document.getElementById('tileCount');
            if (tileCount) {
                tileCount.textContent = '0';
            }
            
            // Clear editable table fields
            const dataTableContainer = document.getElementById('dataTableContainer');
            if (dataTableContainer) {
                dataTableContainer.style.display = 'none';
            }
            
            // Phase 5D-0: Clear image data
            currentImageData = null;
            currentQueueId = null;
        }

        // Save receipt to history
        function saveToHistory(receiptData) {
            // Get existing history or initialize empty array
            let history = JSON.parse(localStorage.getItem('tashiro_history') || '[]');
            
            // Add new receipt with ID and status
            const receipt = {
                id: receiptData.id || Date.now(),
                ...receiptData,
                status: 'submitted'
            };
            
            // Add to beginning of array
            history.unshift(receipt);
            
            // Keep only last 10 items
            if (history.length > 10) {
                history = history.slice(0, 10);
            }
            
            // Save back to localStorage
            localStorage.setItem('tashiro_history', JSON.stringify(history));
            
            // Update history display
            updateHistoryDisplay();
        }

        // Update history display
        function updateHistoryDisplay() {
            const history = JSON.parse(localStorage.getItem('tashiro_history') || '[]');
            console.log('History items:', history.length, 'Language:', currentLanguage);
            
            if (history.length === 0) {
                const noSubmissionsText = t('noSubmissionsYet');
                const startScanningText = t('startScanning');
                console.log('Empty history texts:', noSubmissionsText, startScanningText);
                historyList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>${noSubmissionsText}</p>
                        <p>${startScanningText}</p>
                    </div>
                `;
                return;
            }
            
            let historyHTML = '';
            
            history.forEach(item => {
                historyHTML += `
                    <div class="history-item">
                        <div class="history-icon">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <div class="history-details">
                            <div class="history-vendor">${item.vendor}</div>
                            <div class="history-meta">
                                <span class="history-date">${formatDate(item.date || item.timestamp)}</span>
                                <span class="history-amount">${item.currency || 'JPY'} ${item.total}</span>
                            </div>
                        </div>
                        <div class="history-actions">
                            <button class="icon-button history-download" onclick="downloadExcel('${item.id}')" title="Download Excel">
                                <i class="fas fa-download"></i>
                            </button>
                            <div class="history-status status-success">${t('submitted')}</div>
                        </div>
                    </div>
                `;
            });
            
            historyList.innerHTML = historyHTML;
        }

        // Format date for display
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('en-US', options);
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            toast.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        // Download Excel function
        function downloadExcel(queueId) {
            showToast(t('preparingDownload'), 'info');
            
            // Find the history item with this queue ID
            const history = JSON.parse(localStorage.getItem('tashiro_history') || '[]');
            const item = history.find(h => h.id == queueId);
            
            if (item && item.excel_url) {
                // Create a temporary link to download the file
                const link = document.createElement('a');
                link.href = item.excel_url;
                link.download = `receipt_${queueId}.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast(t('excelDownloaded'), 'success');
            } else {
                // Fallback: try to regenerate Excel
                fetch('/api/mobile/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        queue_id: queueId,
                        fields: item || {},
                        user: JSON.parse(localStorage.getItem('tashiro_user') || '{}')
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.excel_url) {
                        const link = document.createElement('a');
                        link.href = data.excel_url;
                        link.download = `receipt_${queueId}.xlsx`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        showToast(t('excelDownloaded'), 'success');
                    } else {
                        throw new Error('No Excel URL received');
                    }
                })
                .catch(error => {
                    console.error('Download Error:', error);
                    showToast(t('failedDownload'), 'error');
                });
            }
        }

        // Load settings from localStorage
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('tashiro_settings') || '{}');
            document.getElementById('themeToggle').value = settings.theme || 'light';
            document.getElementById('languageSelect').value = settings.language || 'en';
            document.getElementById('ocrEngineSelect').value = settings.ocrEngine || 'auto';
            document.getElementById('notificationToggle').value = settings.notifications || 'all';
            document.getElementById('autoSaveToggle').value = settings.autoSave || 'enabled';
        }

        // Save settings to localStorage
        function saveSettingsToStorage() {
            const settings = {
                theme: document.getElementById('themeToggle').value,
                language: document.getElementById('languageSelect').value,
                ocrEngine: document.getElementById('ocrEngineSelect').value,
                notifications: document.getElementById('notificationToggle').value,
                autoSave: document.getElementById('autoSaveToggle').value
            };
            
            localStorage.setItem('tashiro_settings', JSON.stringify(settings));
            
            // Apply theme and language immediately
            applyTheme(settings.theme);
            applyLanguage(settings.language);
        }

        // Apply theme
        function applyTheme(theme) {
            const root = document.documentElement;
            if (theme === 'dark') {
                root.style.setProperty('--primary-blue', '#4A90E2');
                root.style.setProperty('--text-dark', '#E0E0E0');
                root.style.setProperty('--light-gray', '#2A2A2A');
                root.style.setProperty('--medium-gray', '#404040');
                root.style.setProperty('--dark-gray', '#B0B0B0');
                document.body.style.background = 'linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%)';
            } else {
                // Reset to light theme
                root.style.setProperty('--primary-blue', '#007BFF');
                root.style.setProperty('--text-dark', '#343A40');
                root.style.setProperty('--light-gray', '#F8F9FA');
                root.style.setProperty('--medium-gray', '#E9ECEF');
                root.style.setProperty('--dark-gray', '#6C757D');
                document.body.style.background = 'linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%)';
            }
        }

        // Load account classifications from CSV
        function loadAccountClassifications() {
            fetch('/static/classification_list.csv')
                .then(response => response.text())
                .then(csvText => {
                    const lines = csvText.trim().split('\n');
                    
                    // Skip header lines (first 3 lines are headers)
                    const dataLines = lines.slice(3);
                    
                    accountClassifications = dataLines.map(line => {
                        const parts = line.split(',');
                        if (parts.length >= 2) {
                            return {
                                category: parts[0]?.trim(),
                                subcategory: parts[0]?.trim(), // Use category as subcategory for dropdown
                                description: parts[1]?.trim()
                            };
                        }
                        return null;
                    }).filter(item => item && item.category); // Remove null entries
                    
                    console.log('Loaded', accountClassifications.length, 'account classifications from actual data');
                    console.log('Sample classifications:', accountClassifications.slice(0, 3));
                })
                .catch(error => {
                    console.error('Failed to load account classifications:', error);
                    // Fallback to default classifications if CSV fails to load
                    accountClassifications = [
                        { category: 'ÊóÖË≤ª‰∫§ÈÄöË≤ª', subcategory: 'ÊóÖË≤ª‰∫§ÈÄöË≤ª', description: '„Ç¨„ÇΩ„É™„É≥‰ª£„ÄÅETC‰ª£„ÄÅ‰∫§ÈÄöË≤ª„ÄÅÈßêËªäÊñôÈáë„ÄÅÈ£ü‰∫ã‰ª£ÔºàÂá∫ÂºµÊôÇÔºâ„ÄÅÂÆøÊ≥äË≤ª' },
                        { category: '‰ªïÂÖ•ÊùêÊñô', subcategory: '‰ªïÂÖ•ÊùêÊñô', description: 'Â∑•‰∫ãÂéüÊùêÊñô' },
                        { category: 'ÁèæÂ†¥Èñ¢‰øÇË≤ª', subcategory: 'ÁèæÂ†¥Èñ¢‰øÇË≤ª', description: 'Â∑•ÂÖ∑„ÄÅÁèæÂ†¥ÊïôËÇ≤Á≠â„Å´Èñ¢„Åô„ÇãÁ†î‰øÆ‰ª£„Éª„Éù„Çπ„Çø„ÉºÁ≠â' },
                        { category: '‰∫§ÈöõË≤ª', subcategory: '‰∫§ÈöõË≤ª', description: 'ÂÆ¢ÂÖà„Å®„ÅÆÈ£≤„Åø‰ºö„ÉªÊé•ÂæÖ„Éª„Ç¥„É´„ÉïÁ≠â' },
                        { category: 'ÂéöÁîüË≤ª', subcategory: 'ÂéöÁîüË≤ª', description: 'ÂÅ•Â∫∑Ë®∫Êñ≠Êñô„ÄÅ„Ç§„É≥„Éï„É´„Ç®„É≥„Ç∂„ÉØ„ÇØ„ÉÅ„É≥Êé•Á®Æ„ÄÅÂåªËñ¨ÂìÅË≥ºÂÖ•„ÄÅPCRÊ§úÊüª' },
                        { category: 'Ê∞¥ÈÅìÂÖâÁÜ±Ë≤ª', subcategory: 'Ê∞¥ÈÅìÂÖâÁÜ±Ë≤ª', description: 'ÈõªÊ∞ó‰ª£„ÄÅÊ∞¥ÈÅì‰ª£„ÄÅ„Ç¨„Çπ‰ª£„ÄÅ„Éó„É≠„Éë„É≥‰ª£' },
                        { category: 'ÈÄö‰ø°Ë≤ª', subcategory: 'ÈÄö‰ø°Ë≤ª', description: 'ÈÉµÈÄÅÊñô„ÄÅÂàáÊâã‰ª£' },
                        { category: 'ÁßüÁ®éÂÖ¨Ë™≤', subcategory: 'ÁßüÁ®éÂÖ¨Ë™≤', description: 'Á®éÈáë„ÄÅÂç∞Á¥ô„ÄÅË®ºÁ¥ô' },
                        { category: '‰∫ãÂãôÊ∂àËÄóÂìÅË≤ª', subcategory: '‰∫ãÂãôÊ∂àËÄóÂìÅË≤ª', description: 'ÊñáÊàøÂÖ∑„ÄÅ„Ç≥„Éî„ÉºÁî®Á¥ô„ÄÅPCÈÉ®ÂìÅ„ÉªÂë®Ëæ∫Ê©üÂô®Á≠â' },
                        { category: 'ÈÅãË≥É', subcategory: 'ÈÅãË≥É', description: 'ÂÆÖÈÖç‰æøÁ≠âÈÅãÈÄÅÊñô' },
                        { category: 'Ê∂àËÄóÂìÅ', subcategory: 'Ê∂àËÄóÂìÅ', description: '‰ªïÂÖ•ÊùêÊñô‰ª•Â§ñ„ÅÆÊ∂àËÄóÂìÅ' },
                        { category: 'Ë´∏‰ºöË≤ª', subcategory: 'Ë´∏‰ºöË≤ª', description: '‰ºöË≤ª' },
                        { category: 'Ë´∏ÈõëË≤ª', subcategory: 'Ë´∏ÈõëË≤ª', description: '‰∏äË®ò‰ª•Â§ñÊîØÂá∫„ÄÅÈ£ü‰∫ã‰ª£ÔºàÂá∫Âºµ‰ª•Â§ñÔºâ„ÄÅ„ÅäÊ¶ä‰ª£„ÄÅÊñ∞ËÅû‰ª£' }
                    ];
                });
        }

        // Phase 5D-5: Intake UI reset function
        function resetIntakeUIState(reason) {
            console.log(`Resetting intake UI state: ${reason}`);
            
            // Clear global state
            window.batchDraftsById = {};
            window.batchOrder = [];
            window.draftEditsById = {};
            window.currentDraftId = null;
            
            // ‚úÖ ADDED: Clear preview URLs
            if (window.previewByDraftId) {
                // Revoke all blob URLs to free memory
                Object.values(window.previewByDraftId).forEach(url => {
                    if (url && url.startsWith('blob:')) {
                        URL.revokeObjectURL(url);
                    }
                });
                window.previewByDraftId = {};
            }
            window.previewByIndex = {};
            
            // Clear pending files
            pendingFiles = [];
            
            // Clear receipt tiles container
            const tilesContainer = document.getElementById('receiptTilesContainer');
            if (tilesContainer) {
                tilesContainer.innerHTML = '';
            }
            
            // ‚úÖ ADDED: Hide batch tiles section
            const batchSection = document.getElementById('batchReceiptTiles');
            if (batchSection) {
                batchSection.style.display = 'none';
            }
            
            // Clear mapping table inputs
            const fieldIds = ['fieldDate', 'fieldVendor', 'fieldTotal', 'fieldInvoiceNumber', 
                              'fieldTaxCategory', 'fieldAccountTitle', 'fieldTax', 'fieldCurrency'];
            fieldIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = '';
            });
            
            // ‚úÖ ADDED: Clear receipt image
            const receiptImage = document.getElementById('receiptImage');
            const imagePlaceholder = document.getElementById('imagePlaceholder');
            if (receiptImage) {
                receiptImage.style.display = 'none';
                receiptImage.src = '';
            }
            if (imagePlaceholder) {
                imagePlaceholder.style.display = 'flex';
            }
            
            // Clear debug panel
            const debugPanel = document.getElementById('ocrDebugPanel');
            const debugContent = document.getElementById('ocrDebugContent');
            if (debugPanel) debugPanel.style.display = 'none';
            if (debugContent) debugContent.textContent = '';
            
            // Reset file input
            const fileInput = document.getElementById('fileInput');
            if (fileInput) fileInput.value = '';
            
            // Reset progress labels
            const progressLabel = document.getElementById('progressLabel');
            if (progressLabel) progressLabel.textContent = '';
            
            // Hide data table container
            const dataTableContainer = document.getElementById('dataTableContainer');
            if (dataTableContainer) dataTableContainer.style.display = 'none';
            
            // ‚úÖ ADDED: Reset location and staff
            const businessLocationSelect = document.getElementById('businessLocationSelect');
            if (businessLocationSelect) businessLocationSelect.value = '';
            if (staffMemberSelect) {
                staffMemberSelect.value = '';
                staffMemberSelect.disabled = true;
            }
            
            // Update UI indicators
            renderBatchTiles();
            
            console.log('‚úÖ Full reset complete');
        }

        // Initialize the application
        function init() {
            // Phase 5D-5: Reset UI state on page load
            resetIntakeUIState("page-load");
            
            if (!checkUserRegistration()) {
                welcomeModal.style.display = 'flex';
            } else {
                appContainer.style.display = 'block';
            }
            
            // Load account classifications
            loadAccountClassifications();
            loadLocationsFromServer();
            
            // Load and apply saved settings
            loadSettings();
            const settings = JSON.parse(localStorage.getItem('tashiro_settings') || '{}');
            applyTheme(settings.theme || 'light');
            applyLanguage(settings.language || 'en');
            
            updateHistoryDisplay();
            restoreLatestAnalysis();

            // Force reapply language after DOM is fully loaded
            setTimeout(() => {
                const currentSettings = JSON.parse(localStorage.getItem('tashiro_settings') || '{}');
                applyLanguage(currentSettings.language || 'en');
            }, 500);

            // Additional delayed update for OCR tips and dynamic elements
            setTimeout(() => {
                const currentSettings = JSON.parse(localStorage.getItem('tashiro_settings') || '{}');
                applyLanguage(currentSettings.language || 'en');
                console.log('Final language update applied for language:', currentSettings.language || 'en');
            }, 1500);
        }

        // Start the application
        init();
    </script>

    <!-- Phase 5D: Enhanced Draft Management Modal -->
    <div id="draftModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; overflow-y: auto;">
        <div style="background: white; margin: 20px auto; max-width: 1200px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <!-- Modal Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid #e2e8f0;">
                <div>
                    <h2 style="font-size: 20px; font-weight: 600; color: #1e293b; margin: 0;">Receipt Drafts</h2>
                    <p style="font-size: 13px; color: #64748b; margin: 4px 0 0 0;">Manage and send receipt drafts</p>
                    <p id="draftUserIndicator" style="font-size: 12px; color: #3b82f6; margin: 4px 0 0 0; display: none;"></p>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <!-- Phase 5D-2: Logout button -->
                    <button onclick="logout()" style="padding: 6px 16px; background: #e2e8f0; color: #475569; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#cbd5e1'" onmouseout="this.style.background='#e2e8f0'">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                    <button id="closeDraftModalBtn" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #64748b; padding: 0; width: 32px; height: 32px;">√ó</button>
                </div>
            </div>
            
            <!-- Filters Section -->
            <div style="padding: 16px 24px; border-bottom: 1px solid #e2e8f0; background: #f8fafc;">
                <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                    <span style="font-size: 14px; color: #475569; font-weight: 500;">Filter:</span>
                    <button id="filterAll" class="draft-filter-btn" data-filter="all" style="padding: 6px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer;">All</button>
                    <button id="filterDraft" class="draft-filter-btn" data-filter="DRAFT" style="padding: 6px 16px; background: #e2e8f0; color: #475569; border: none; border-radius: 6px; font-size: 13px; cursor: pointer;">Draft</button>
                    <button id="filterSent" class="draft-filter-btn" data-filter="SENT" style="padding: 6px 16px; background: #e2e8f0; color: #475569; border: none; border-radius: 6px; font-size: 13px; cursor: pointer;">Sent</button>
                    <button id="filterError" class="draft-filter-btn" data-filter="ERROR" style="padding: 6px 16px; background: #e2e8f0; color: #475569; border: none; border-radius: 6px; font-size: 13px; cursor: pointer;">Errors</button>
                    <div style="margin-left: auto; display: flex; align-items: center; gap: 12px;">
                        <label for="selectAllDrafts" style="display: flex; align-items: center; gap: 6px; font-size: 13px; color: #475569; cursor: pointer;">
                            <input type="checkbox" id="selectAllDrafts" name="selectAllDrafts" style="width: 16px; height: 16px; cursor: pointer;">
                            Select All
                        </label>
                        <button id="refreshDraftsBtn" style="padding: 6px 12px; background: none; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer; color: #475569;">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Modal Body -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 24px; min-height: 400px; max-height: 500px; overflow-y: auto;">
                <!-- Left: Draft List -->
                <div id="draftListContainer" style="border-right: 1px solid #e2e8f0; padding-right: 20px;">
                    <div style="text-align: center; padding: 40px 20px; color: #64748b;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 8px;"></i>
                        <div>Loading drafts...</div>
                    </div>
                </div>
                
                <!-- Right: Draft Details -->
                <div id="draftDetailContainer" style="padding-left: 20px;">
                    <!-- Image Preview Section -->
                    <div id="draftImagePreviewSection" style="display: none; margin-bottom: 16px;">
                        <div style="border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; background: #f8fafc;">
                            <img id="draftModalImage" style="max-width: 100%; display: none;">
                            <div id="draftModalImagePlaceholder" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; color: #94a3b8;">
                                <i class="fas fa-receipt" style="font-size: 32px; margin-bottom: 8px;"></i>
                                <p style="margin: 0;">No image available</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Empty State -->
                    <div id="draftEmptyState" style="text-align: center; padding: 40px 20px; color: #64748b;">
                        Select a draft to view details
                    </div>
                    
                    <!-- Draft Details (will be populated dynamically) -->
                    <div id="draftDetailsContent" style="display: none;">
                        <!-- Details will be rendered here -->
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer with Bulk Actions -->
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; border-top: 1px solid #e2e8f0; background: #f8fafc;">
                <span id="draftSelectionCount" style="color: #64748b; font-size: 14px;">0 drafts selected</span>
                <button id="sendSelectedDraftsBtn" disabled style="padding: 10px 24px; background: #1e40af; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: not-allowed; transition: all 0.2s; opacity: 0.5;">
                    <i class="fas fa-paper-plane"></i> Send
                </button>
            </div>
        </div>
    </div>
    
    <!-- Phase 5D: Send Results Modal -->
    <div id="sendResultsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 2100; overflow-y: auto;">
        <div style="background: white; margin: 40px auto; max-width: 700px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div style="padding: 20px 24px; border-bottom: 1px solid #e2e8f0;">
                <h2 style="font-size: 18px; font-weight: 600; color: #1e293b; margin: 0;">Send Results</h2>
            </div>
            <div id="sendResultsContainer" style="padding: 24px; max-height: 400px; overflow-y: auto;"></div>
            <div style="padding: 16px 24px; border-top: 1px solid #e2e8f0; text-align: right;">
                <button id="closeSendResultsBtn" style="padding: 8px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- Phase 4D.1: Draft Management Script -->
    <script src="/static/js/drafts.js"></script>
</body>
</html>
