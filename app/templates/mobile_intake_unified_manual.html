<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tashiro Ironworks - Professional OCR System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #007BFF;
            --primary-dark: #0056b3;
            --success-green: #28A745;
            --warning-orange: #FFC107;
            --danger-red: #DC3545;
            --purple: #6F42C1;
            --teal: #20C997;
            --light-gray: #F8F9FA;
            --medium-gray: #E9ECEF;
            --dark-gray: #6C757D;
            --text-dark: #343A40;
            --shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 30px rgba(0, 0, 0, 0.12);
            --border-radius: 12px;
            --gradient-primary: linear-gradient(135deg, #007BFF 0%, #0056b3 100%);
            --gradient-success: linear-gradient(135deg, #28A745 0%, #1e7e34 100%);
            --gradient-warning: linear-gradient(135deg, #FFC107 0%, #e0a800 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: var(--text-dark);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Welcome Modal */
        .welcome-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 480px;
            padding: 40px 32px;
            text-align: center;
            animation: modalSlideIn 0.5s ease-out;
            position: relative;
            overflow: hidden;
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .company-logo {
            display: flex;
            justify-content: center;
            margin-bottom: 24px;
        }

        .logo-circle {
            width: 80px;
            height: 80px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .modal-content h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-dark);
        }

        .modal-subtitle {
            font-size: 16px;
            color: var(--dark-gray);
            margin-bottom: 32px;
        }

        .registration-form {
            text-align: left;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-dark);
        }

        .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--medium-gray);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .required {
            color: var(--danger-red);
        }

        .primary-button {
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 16px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .primary-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 123, 255, 0.4);
        }

        .primary-button:active {
            transform: translateY(0);
        }

        /* Main App Layout */
        .app-container {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Enhanced Header */
        .app-header {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px 24px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .app-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .header-left h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .header-left p {
            color: var(--dark-gray);
            font-size: 14px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            font-size: 16px;
        }

        .user-email {
            font-size: 14px;
            color: var(--dark-gray);
        }

        .profile-actions {
            display: flex;
            gap: 12px;
        }

        .icon-button {
            background: var(--light-gray);
            border: none;
            border-radius: 8px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--dark-gray);
        }

        .icon-button:hover {
            background: var(--primary-blue);
            color: white;
            transform: translateY(-2px);
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        /* Enhanced Cards */
        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 24px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .card-description {
            font-size: 14px;
            color: var(--dark-gray);
        }

        .card-icon {
            font-size: 24px;
            color: var(--primary-blue);
            background: rgba(0, 123, 255, 0.1);
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Upload Section */
        .upload-options {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }

        .upload-button {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px 16px;
            border: 2px dashed var(--medium-gray);
            border-radius: 12px;
            background: var(--light-gray);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .upload-button:hover {
            border-color: var(--primary-blue);
            background: rgba(0, 123, 255, 0.05);
            transform: translateY(-2px);
        }

        .upload-icon {
            font-size: 32px;
            margin-bottom: 12px;
            color: var(--primary-blue);
        }

        .upload-text {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-dark);
        }

        .upload-subtext {
            font-size: 14px;
            color: var(--dark-gray);
            margin-top: 4px;
        }

        .dropzone {
            border: 2px dashed var(--medium-gray);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            background: var(--light-gray);
            transition: all 0.3s;
            margin-top: 16px;
        }

        .dropzone.active {
            border-color: var(--primary-blue);
            background: rgba(0, 123, 255, 0.05);
        }

        .dropzone-icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--dark-gray);
        }

        /* OCR Tips Section */
        .ocr-tips {
            background: var(--light-gray);
            border-radius: 12px;
            padding: 16px 20px;
            margin-top: 16px;
            border-left: 4px solid var(--primary-blue);
        }

        .ocr-tips h4 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ocr-tips h4 i {
            color: var(--primary-blue);
        }

        .ocr-tips ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .ocr-tips li {
            font-size: 14px;
            color: var(--dark-gray);
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }

        .ocr-tips li:before {
            content: "üì±";
            position: absolute;
            left: 0;
            top: 0;
        }

        .ocr-tips li:last-child {
            margin-bottom: 0;
        }

        /* OCR Preview Section */
        .ocr-preview-container {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .preview-image {
            flex: 1;
            min-width: 300px;
            background: var(--light-gray);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .preview-image img {
            width: 100%;
            height: auto;
            max-height: 400px;
            object-fit: contain;
            display: block;
        }

        .preview-placeholder {
            width: 100%;
            height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--dark-gray);
            background: var(--light-gray);
            border-radius: 12px;
        }

        .preview-placeholder i {
            font-size: 64px;
            margin-bottom: 16px;
            color: var(--medium-gray);
        }

        .ocr-results {
            flex: 2;
            min-width: 300px;
        }

        /* Field Mapping Section */
        .field-mapping-header {
            background: var(--gradient-primary);
            color: white;
            padding: 16px 20px;
            border-radius: 12px 12px 0 0;
            margin-bottom: 20px;
        }

        .field-mapping-header h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        /* Global loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1100;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-card {
            background: white;
            padding: 24px 32px;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            text-align: center;
            width: min(90%, 360px);
        }

        .loading-spinner {
            width: 64px;
            height: 64px;
            border: 6px solid var(--light-gray);
            border-top-color: var(--primary-blue);
            border-radius: 50%;
            margin: 0 auto 16px;
            animation: spin 1s linear infinite;
        }

        .loading-message {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .loading-subtext {
            font-size: 14px;
            color: var(--dark-gray);
        }

        .loading-steps {
            margin-top: 16px;
            text-align: left;
            font-size: 13px;
            color: var(--dark-gray);
        }

        .loading-steps li {
            margin-bottom: 6px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .field-mapping-header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .form-field {
            margin-bottom: 0;
        }

        .field-label {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .field-badge {
            display: inline-block;
            background: var(--primary-blue);
            color: white;
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            margin-right: 8px;
            min-width: 24px;
            text-align: center;
        }

        .ai-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: var(--primary-blue);
            background: rgba(0, 123, 255, 0.1);
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
            font-weight: 500;
        }

        .ai-indicator i {
            font-size: 10px;
        }

        .form-field input, .form-field select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--medium-gray);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s;
            background: white;
        }

        .form-field input:focus, .form-field select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        /* Verification Status */
        .verification-status {
            background: var(--gradient-success);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 24px 0;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .verification-status.warning {
            background: var(--gradient-warning);
        }

        .status-icon {
            font-size: 24px;
        }

        .status-content {
            flex: 1;
        }

        .status-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .confidence-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }

        /* Additional Information */
        .additional-info {
            background: var(--light-gray);
            border-radius: 12px;
            padding: 20px;
            margin-top: 24px;
        }

        .additional-info h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-dark);
        }

        .save-result {
            margin-top: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            background: rgba(0, 123, 255, 0.08);
            color: var(--text-dark);
            font-size: 14px;
            display: none;
        }

        /* Form Actions */
        .form-actions {
            display: flex;
            gap: 16px;
            margin-top: 24px;
        }

        .secondary-button {
            background: white;
            color: var(--primary-blue);
            border: 2px solid var(--primary-blue);
            border-radius: 8px;
            padding: 14px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
        }

        .secondary-button:hover {
            background: rgba(0, 123, 255, 0.05);
            transform: translateY(-2px);
        }

        /* History Section */
        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--medium-gray);
            transition: background 0.2s;
            gap: 16px;
        }

        .history-item:hover {
            background: var(--light-gray);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }

        .history-details {
            flex: 1;
            min-width: 0;
        }

        .history-vendor {
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-meta {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: var(--dark-gray);
        }

        .history-amount {
            font-weight: 600;
            color: var(--text-dark);
        }

        .history-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-success {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success-green);
        }

        .status-pending {
            background: rgba(255, 193, 7, 0.1);
            color: var(--warning-orange);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--dark-gray);
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 16px;
            color: var(--medium-gray);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }

        .toast {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            animation: toastSlideIn 0.3s ease-out;
            border-left: 4px solid;
        }

        .toast-success { border-left-color: var(--success-green); }
        .toast-error { border-left-color: var(--danger-red); }
        .toast-warning { border-left-color: var(--warning-orange); }
        .toast-info { border-left-color: var(--primary-blue); }

        .toast-icon {
            margin-right: 12px;
            font-size: 20px;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            margin-left: 12px;
            color: var(--dark-gray);
        }

        @keyframes toastSlideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Profile Modal */
        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            padding: 20px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .upload-options {
                flex-direction: column;
            }
            
            .ocr-preview-container {
                flex-direction: column;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .app-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
            
            .user-profile {
                align-self: flex-end;
            }
            
            .toast-container {
                left: 10px;
                right: 10px;
                max-width: none;
            }
        }

        /* Mobile-responsive styles for editable table */
        @media (max-width: 768px) {
            .table-container {
                padding: 10px !important;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            #editableTable {
                font-size: 14px;
                min-width: 600px; /* Ensure table doesn't get too cramped */
            }

            #editableTable th,
            #editableTable td {
                padding: 8px 6px !important;
                white-space: nowrap;
            }

            #editableTable th:nth-child(1),
            #editableTable td:nth-child(1) {
                min-width: 120px;
                max-width: 150px;
            }

            #editableTable th:nth-child(2),
            #editableTable td:nth-child(2) {
                min-width: 150px;
            }

            #editableTable th:nth-child(3),
            #editableTable td:nth-child(3) {
                min-width: 80px;
                text-align: center;
            }

            .editable-field {
                font-size: 14px !important;
                padding: 6px !important;
            }

            .table-header {
                flex-direction: column !important;
                gap: 10px !important;
                align-items: stretch !important;
            }

            .table-header h3 {
                font-size: 16px !important;
                margin: 0 !important;
            }

            #saveAccumulationBtn {
                align-self: flex-start !important;
                padding: 10px 16px !important;
                font-size: 14px !important;
            }
        }

        @media (max-width: 480px) {
            #editableTable {
                font-size: 12px;
                min-width: 500px;
            }

            #editableTable th,
            #editableTable td {
                padding: 6px 4px !important;
            }

            .editable-field {
                font-size: 12px !important;
                padding: 4px !important;
            }

            .table-header h3 {
                font-size: 14px !important;
            }

            #saveAccumulationBtn {
                width: 100% !important;
                padding: 12px !important;
                font-size: 14px !important;
            }
        }
    </style>
</head>
<body>
    <!-- Welcome Modal -->
    <div id="welcomeModal" class="welcome-modal">
        <div class="modal-content">
            <div class="company-logo">
                <div class="logo-circle">
                    <i class="fas fa-industry"></i>
                </div>
            </div>
            <h1>Tashiro Ironworks Co., Ltd.</h1>
            <p class="modal-subtitle">Professional Receipt OCR Automation System</p>
            
            <form id="registrationForm" class="registration-form">
                <div class="form-group">
                    <label for="userName">Full Name <span class="required">*</span></label>
                    <input type="text" id="userName" placeholder="Enter your full name" required>
                </div>
                
                <div class="form-group">
                    <label for="userEmail">Email Address <span class="required">*</span></label>
                    <input type="email" id="userEmail" placeholder="your.email@company.com" required>
                </div>
                
                <div class="form-group">
                    <label for="employeeId">Employee ID (Optional)</label>
                    <input type="text" id="employeeId" placeholder="TY-2045">
                </div>
                
                <button type="submit" class="primary-button">
                    <i class="fas fa-rocket"></i> Launch OCR System
                </button>
            </form>
        </div>
    </div>

    <!-- Global Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" aria-live="polite">
        <div class="loading-card">
            <div class="loading-spinner" role="status" aria-label="Processing receipt"></div>
            <div class="loading-message" id="loadingMessage">Processing receipt‚Ä¶</div>
            <div class="loading-subtext" id="loadingSubtext">Running OCR engines‚Ä¶</div>
            <ul class="loading-steps">
                <li id="loadingStepUpload">1. Uploading image‚Ä¶</li>
                <li id="loadingStepQueue">2. Waiting for OCR engines‚Ä¶</li>
                <li id="loadingStepExtraction">3. Extracting fields‚Ä¶</li>
            </ul>
        </div>
    </div>

    <!-- Profile Update Modal -->
    <div id="profileModal" class="profile-modal">
        <div class="modal-content">
            <div class="company-logo">
                <div class="logo-circle">
                    <i class="fas fa-user-edit"></i>
                </div>
            </div>
            <h1>Update Profile</h1>
            <p class="modal-subtitle">Keep your information up to date</p>
            
            <form id="profileForm" class="registration-form">
                <div class="form-group">
                    <label for="updateUserName">Full Name <span class="required">*</span></label>
                    <input type="text" id="updateUserName" placeholder="Enter your full name" required>
                </div>
                
                <div class="form-group">
                    <label for="updateUserEmail">Email Address <span class="required">*</span></label>
                    <input type="email" id="updateUserEmail" placeholder="your.email@company.com" required>
                </div>
                
                <div class="form-group">
                    <label for="updateEmployeeId">Employee ID</label>
                    <input type="text" id="updateEmployeeId" placeholder="TY-2045">
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="primary-button">
                        <i class="fas fa-save"></i> Update Profile
                    </button>
                    <button type="button" class="secondary-button" id="cancelProfileUpdate">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="profile-modal">
        <div class="modal-content">
            <div class="company-logo">
                <div class="logo-circle">
                    <i class="fas fa-cog"></i>
                </div>
            </div>
            <h1>App Settings</h1>
            <p class="modal-subtitle">Customize your experience</p>
            
            <div class="registration-form">
                <div class="form-group">
                    <label for="themeToggle">Theme</label>
                    <select id="themeToggle">
                        <option value="light">Light Mode</option>
                        <option value="dark">Dark Mode</option>
                        <option value="auto">Auto (System)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="languageSelect">Language</label>
                    <select id="languageSelect">
                        <option value="en">English</option>
                        <option value="ja">Êó•Êú¨Ë™û (Japanese)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="notificationToggle">Notifications</label>
                    <select id="notificationToggle">
                        <option value="all">All Notifications</option>
                        <option value="important">Important Only</option>
                        <option value="none">Disabled</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="autoSaveToggle">Auto-save Forms</label>
                    <select id="autoSaveToggle">
                        <option value="enabled">Enabled</option>
                        <option value="disabled">Disabled</option>
                    </select>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="primary-button" id="saveSettings">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                    <button type="button" class="secondary-button" id="cancelSettings">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="appContainer" class="app-container">
        <!-- Enhanced Header -->
        <header class="app-header">
            <div class="header-left">
                <h1>Receipt OCR Automation System</h1>
                <p>Tashiro Ironworks Co., Ltd.</p>
            </div>
            
            <div class="user-profile">
                <div class="user-info">
                    <div class="user-name" id="displayUserName">Guest User</div>
                    <div class="user-email" id="displayUserEmail">guest@example.com</div>
                </div>
                <div class="profile-actions">
                    <button class="icon-button" id="profileButton" title="Update Profile">
                        <i class="fas fa-user-edit"></i>
                    </button>
                    <button class="icon-button" id="settingsButton" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
                <div class="user-avatar" id="userAvatar">GU</div>
            </div>
        </header>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Capture Card -->
            <div class="card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">Capture Receipt</h2>
                        <p class="card-description">Take a photo or upload an existing receipt image</p>
                    </div>
                    <div class="card-icon">
                        <i class="fas fa-camera"></i>
                    </div>
                </div>
                
                <div class="upload-options">
                    <div class="upload-button" id="cameraButton">
                        <i class="fas fa-camera upload-icon"></i>
                        <div class="upload-text">Take Photo</div>
                        <div class="upload-subtext">Use device camera</div>
                    </div>
                    
                    <div class="upload-button" id="uploadButton">
                        <i class="fas fa-file-upload upload-icon"></i>
                        <div class="upload-text">Upload File</div>
                        <div class="upload-subtext">JPG, PNG, or PDF</div>
                    </div>
                </div>
                
                <div class="dropzone" id="dropzone">
                    <i class="fas fa-cloud-upload-alt dropzone-icon"></i>
                    <p>Drag & drop receipt image here</p>
                    <p class="upload-subtext">or use the options above</p>
                </div>
                
                <!-- OCR Tips Section -->
                <div class="ocr-tips" id="ocrTips">
                    <h4><i class="fas fa-lightbulb"></i> üì∏ Quick Tips for Better OCR</h4>
                    <ul>
                        <li>Ensure good lighting and avoid shadows</li>
                        <li>Hold camera steady and keep receipt flat</li>
                        <li>Include all receipt edges in the photo</li>
                        <li>Avoid blurry or distorted images</li>
                        <li>Supported formats: JPG, PNG (max 5MB)</li>
                    </ul>
                </div>
                
                <input type="file" id="fileInput" accept="image/*" capture="environment" style="display: none;">
            </div>

            <!-- OCR Review Card -->
            <div class="card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">OCR Review & Verification</h2>
                        <p class="card-description">Verify extracted data and submit to HQ</p>
                    </div>
                    <div class="card-icon">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
                
                <!-- OCR Preview Section -->
                <div class="ocr-preview-container">
                    <div class="preview-image">
                        <div class="preview-placeholder" id="imagePlaceholder">
                            <i class="fas fa-receipt"></i>
                            <p>No receipt image</p>
                            <p>Upload a receipt to see preview</p>
                        </div>
                        <img id="receiptImage" src="" style="display: none;">
                    </div>
                    
                    <div class="ocr-results">
                        <!-- Field Mapping Header -->
                        <div class="field-mapping-header">
                            <h3>üìã Receipt Field Mapping (A-F)</h3>
                            <p>Verify extracted data matches receipt content</p>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-field">
                                <div class="field-label">
                                    <span class="field-badge">A</span>
                                    <span class="field-text">Date (Êó•‰ªò)</span>
                                </div>
                                <input type="text" id="fieldDate" placeholder="YYYY-MM-DD">
                            </div>
                            
                            <div class="form-field">
                                <div class="field-label">
                                    <span class="field-badge">B</span>
                                    <span class="field-text">Store Name (Â∫óÂêç)</span>
                                </div>
                                <input type="text" id="fieldVendor" placeholder="Store name">
                            </div>
                            
                            <div class="form-field">
                                <div class="field-label">
                                    <span class="field-badge">C</span>
                                    <span class="field-text">Total Amount (ÈáëÈ°ç)</span>
                                </div>
                                <input type="text" id="fieldTotal" placeholder="0.00">
                            </div>
                            
                            <div class="form-field">
                                <div class="field-label">
                                    <span class="field-badge">D</span>
                                    <span class="field-text">Invoice Number („Ç§„É≥„Éú„Ç§„ÇπÁï™Âè∑)</span>
                                </div>
                                <input type="text" id="fieldInvoiceNumber" placeholder="Invoice/Receipt No.">
                            </div>
                            
                            <div class="form-field">
                                <div class="field-label">
                                    <span class="field-badge">E</span>
                                    <span class="field-text">Tax Category (Á®éÂå∫ÂàÜ)</span>
                                </div>
                                <select id="fieldTaxCategory">
                                    <option value="">Select tax category</option>
                                    <option value="ËªΩÊ∏õÁ®éÁéá">ËªΩÊ∏õÁ®éÁéá (Reduced Tax Rate 8%)</option>
                                    <option value="Ê®ôÊ∫ñÁ®éÁéá">Ê®ôÊ∫ñÁ®éÁéá (Standard Tax Rate 10%)</option>
                                    <option value="ÈùûË™≤Á®é">ÈùûË™≤Á®é (Non-taxable)</option>
                                </select>
                            </div>
                            
                            <div class="form-field">
                                <div class="field-label">
                                    <span class="field-badge">F</span>
                                    <span class="field-text">Account Title (ÂãòÂÆöÁßëÁõÆ)</span>
                                    <span id="aiConfidenceIndicator" class="ai-indicator" style="display: none;">
                                        <i class="fas fa-robot"></i> AI Selected
                                    </span>
                                </div>
                                <select id="fieldAccountTitle">
                                    <option value="">Select account title</option>
                                    <option value="È£üË≤ª">üçΩÔ∏è È£üË≤ª (Meals)</option>
                                    <option value="‰∫§ÈÄöË≤ª">üöó ‰∫§ÈÄöË≤ª (Transportation)</option>
                                    <option value="ÈÄö‰ø°Ë≤ª">üì± ÈÄö‰ø°Ë≤ª (Communication)</option>
                                    <option value="ÂÆøÊ≥äË≤ª">üè® ÂÆøÊ≥äË≤ª (Accommodation)</option>
                                    <option value="Êé•ÂæÖ‰∫§ÈöõË≤ª">üéâ Êé•ÂæÖ‰∫§ÈöõË≤ª (Entertainment)</option>
                                    <option value="Ê∂àËÄóÂìÅË≤ª">üìé Ê∂àËÄóÂìÅË≤ª (Office Supplies)</option>
                                    <option value="‰ºöË≠∞Ë≤ª">üè¢ ‰ºöË≠∞Ë≤ª (Meeting Expenses)</option>
                                    <option value="Á†î‰øÆË≤ª">üìö Á†î‰øÆË≤ª (Training)</option>
                                    <option value="Á¶èÂà©ÂéöÁîüË≤ª">üéÅ Á¶èÂà©ÂéöÁîüË≤ª (Welfare)</option>
                                    <option value="Â∫ÉÂëäÂÆ£‰ºùË≤ª">üì¢ Â∫ÉÂëäÂÆ£‰ºùË≤ª (Advertising)</option>
                                    <option value="Ëªä‰∏°Ë≤ª">üöõ Ëªä‰∏°Ë≤ª (Vehicle)</option>
                                    <option value="‰øùÈô∫Êñô">üõ°Ô∏è ‰øùÈô∫Êñô (Insurance)</option>
                                    <option value="ÁßüÁ®éÂÖ¨Ë™≤">üíº ÁßüÁ®éÂÖ¨Ë™≤ (Taxes & Dues)</option>
                                    <option value="„Åù„ÅÆ‰ªñ">üìã „Åù„ÅÆ‰ªñ (Other)</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Verification Status -->
                        <div class="verification-status" id="verificationStatus" style="display: none;">
                            <div class="status-icon">‚úÖ</div>
                            <div class="status-content">
                                <div class="status-title">All fields verified successfully!</div>
                                <div class="confidence-badge">High Confidence</div>
                            </div>
                        </div>
                        
                        <!-- Additional Information -->
                        <div class="additional-info">
                            <h4>Additional Information</h4>
                            <div class="form-grid">
                                <div class="form-field">
                                    <label>Subtotal (ÂèÇËÄÉ)</label>
                                    <input type="text" id="fieldSubtotal" placeholder="0.00">
                                </div>
                                <div class="form-field">
                                    <label>Tax Amount (ÂèÇËÄÉ)</label>
                                    <input type="text" id="fieldTax" placeholder="0.00">
                                </div>
                                <div class="form-field">
                                    <label>Currency</label>
                                    <input type="text" id="fieldCurrency" placeholder="JPY" value="JPY">
                                </div>
                                <div class="form-field">
                                    <label for="businessLocationSelect">Business Location <span class="required">*</span></label>
                                    <select id="businessLocationSelect">
                                        <option value="">Select location</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button class="primary-button" id="reviewDataBtn" disabled>
                                <i class="fas fa-edit"></i> Review Data
                            </button>
                            <button class="secondary-button" id="resetButton">
                                <i class="fas fa-redo"></i> Start Over
                            </button>
                        </div>

                        <div class="additional-info" id="ocrDebugPanel" style="display: none; margin-top: 16px;">
                            <h4>Latest OCR Payload (Debug)</h4>
                            <pre id="ocrDebugContent" style="white-space: pre-wrap; background: white; padding: 12px; border-radius: 8px; border: 1px solid var(--medium-gray); max-height: 240px; overflow: auto;"></pre>
                        </div>

                        <!-- Editable Data Table Container -->
                        <div id="dataTableContainer" style="display: none; margin-top: 20px;">
                            <div class="table-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0; color: var(--text-dark);">Review & Edit Extracted Data</h3>
                                <div style="display: flex; gap: 10px;">
                                    <button class="secondary-button" id="saveChangesBtn" style="padding: 8px 16px; font-size: 14px;">
                                        <i class="fas fa-save"></i> Save Changes
                                    </button>
                                    <button class="primary-button" id="saveAccumulationBtn" style="padding: 8px 16px; font-size: 14px;">
                                        <i class="fas fa-database"></i> Save to HQ Ledger
                                    </button>
                                </div>
                            </div>
                            <div class="table-container" style="overflow-x: auto; background: var(--light-gray); border-radius: 8px; padding: 15px;">
                                <table id="editableTable" style="width: 100%; border-collapse: collapse; background: white; border-radius: 6px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <thead>
                                        <tr style="background: var(--primary-blue); color: white;">
                                            <th style="padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid var(--medium-gray);">Field</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid var(--medium-gray);">Value</th>
                                            <th style="padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid var(--medium-gray);">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableBody">
                                        <!-- Table rows will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="saveResultMessage" class="save-result"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Card -->
        <div class="card">
            <div class="card-header">
                <div>
                    <h2 class="card-title">Submission History</h2>
                    <p class="card-description">Recent receipts and their status</p>
                </div>
                <div class="card-icon">
                    <i class="fas fa-history"></i>
                </div>
            </div>
            
            <div class="history-list" id="historyList">
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <p>No submissions yet</p>
                    <p>Start scanning receipts to see them here</p>
                </div>
            </div>
        </div>

        <!-- Developer Credit -->
        <div class="developer-credit" style="text-align: center; margin: 20px 0; padding: 10px; color: var(--dark-gray); font-size: 12px; border-top: 1px solid var(--light-gray);">
            by: Eshwar Potnuru ‚Äì Machine Learning Engineer, AIM Co. Pvt.
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <script>
        // Language translations
        const translations = {
            en: {
                // Welcome Modal
                welcomeTitle: "Tashiro Ironworks Co., Ltd.",
                welcomeSubtitle: "Professional Receipt OCR Automation System",
                fullName: "Full Name",
                emailAddress: "Email Address",
                employeeId: "Employee ID (Optional)",
                launchSystem: "Launch OCR System",
                enterFullName: "Enter your full name",
                enterEmail: "your.email@company.com",
                enterEmployeeId: "TY-2045",

                // Profile Modal
                updateProfile: "Update Profile",
                keepInfoUpdated: "Keep your information up to date",
                updateProfileBtn: "Update Profile",
                cancel: "Cancel",

                // Settings Modal
                appSettings: "App Settings",
                customizeExperience: "Customize your experience",
                theme: "Theme",
                language: "Language",
                notifications: "Notifications",
                autoSave: "Auto-save Forms",
                lightMode: "Light Mode",
                darkMode: "Dark Mode",
                autoSystem: "Auto (System)",
                english: "English",
                japanese: "Êó•Êú¨Ë™û (Japanese)",
                allNotifications: "All Notifications",
                importantOnly: "Important Only",
                disabled: "Disabled",
                enabled: "Enabled",
                saveSettings: "Save Settings",

                // Main App
                ocrSystem: "Receipt OCR Automation System",
                tashiroIronworks: "Tashiro Ironworks Co., Ltd.",
                guestUser: "Guest User",
                guestEmail: "guest@example.com",

                // Page title
                pageTitle: "Tashiro Ironworks - Professional OCR System",

                // Cards
                captureReceipt: "Capture Receipt",
                takePhotoOrUpload: "Take a photo or upload an existing receipt image",
                takePhoto: "Take Photo",
                useDeviceCamera: "Use device camera",
                uploadFile: "Upload File",
                jpgPngOrPdf: "JPG, PNG, or PDF",
                dragDropHere: "Drag & drop receipt image here",
                orUseOptionsAbove: "or use the options above",

                ocrReview: "OCR Review & Verification",
                verifyExtractedData: "Verify extracted data and submit to HQ",
                receiptFieldMapping: "Receipt Field Mapping (A-F)",
                verifyDataMatches: "Verify extracted data matches receipt content",

                // Field Labels
                dateLabel: "Date (Êó•‰ªò)",
                storeNameLabel: "Store Name (Â∫óÂêç)",
                totalAmountLabel: "Total Amount (ÈáëÈ°ç)",
                invoiceNumberLabel: "Invoice Number („Ç§„É≥„Éú„Ç§„ÇπÁï™Âè∑)",
                taxCategoryLabel: "Tax Category (Á®éÂå∫ÂàÜ)",
                accountTitleLabel: "Account Title (ÂãòÂÆöÁßëÁõÆ)",
                selectTaxCategory: "Select tax category",
                selectAccountTitle: "Select account title",

                // Account Titles
                meals: "È£üË≤ª (Meals)",
                transportation: "‰∫§ÈÄöË≤ª (Transportation)",
                communication: "ÈÄö‰ø°Ë≤ª (Communication)",
                accommodation: "ÂÆøÊ≥äË≤ª (Accommodation)",
                entertainment: "Êé•ÂæÖ‰∫§ÈöõË≤ª (Entertainment)",
                officeSupplies: "Ê∂àËÄóÂìÅË≤ª (Office Supplies)",
                meetingExpenses: "‰ºöË≠∞Ë≤ª (Meeting Expenses)",
                training: "Á†î‰øÆË≤ª (Training)",
                welfare: "Á¶èÂà©ÂéöÁîüË≤ª (Welfare)",
                advertising: "Â∫ÉÂëäÂÆ£‰ºùË≤ª (Advertising)",
                vehicle: "Ëªä‰∏°Ë≤ª (Vehicle)",
                insurance: "‰øùÈô∫Êñô (Insurance)",
                taxesDues: "ÁßüÁ®éÂÖ¨Ë™≤ (Taxes & Dues)",
                other: "„Åù„ÅÆ‰ªñ (Other)",

                // Additional Info
                additionalInformation: "Additional Information",
                subtotalRef: "Subtotal (ÂèÇËÄÉ)",
                taxAmountRef: "Tax Amount (ÂèÇËÄÉ)",
                currency: "Currency",

                // Buttons
                submitToHq: "Submit to HQ",
                reviewData: "Review Data",
                startOver: "Start Over",

                // Verification
                allFieldsVerified: "All fields verified successfully!",
                highConfidence: "High Confidence",

                // History
                submissionHistory: "Submission History",
                recentReceipts: "Recent receipts and their status",
                noSubmissionsYet: "No submissions yet",
                startScanning: "Start scanning receipts to see them here",
                submitted: "Submitted",

                // Placeholders
                yyyyMmDd: "YYYY-MM-DD",
                storeName: "Store name",
                zeroZero: "0.00",
                invoiceReceiptNo: "Invoice/Receipt No.",
                jpy: "JPY",

                // Image placeholder
                noReceiptImage: "No receipt image",
                uploadReceiptToSeePreview: "Upload a receipt to see preview",

                // Developer credit
                developerCredit: "by: Eshwar Potnuru ‚Äì Machine Learning Engineer, AIM Co. Pvt.",

                // Toast Messages
                welcomeMessage: "Welcome, {name}! Ready to process receipts.",
                processingReceipt: "Processing receipt image...",
                receiptAnalyzed: "Receipt analyzed successfully! All fields extracted.",
                failedToAnalyze: "Failed to analyze receipt. Please try again.",
                formReset: "Form reset. Ready for new receipt.",
                noReceiptData: "No receipt data to submit. Please upload a receipt first.",
                receiptSubmitted: "Receipt submitted to HQ successfully!",
                failedToSubmit: "Failed to submit receipt. Please try again.",
                preparingDownload: "Preparing Excel download...",
                excelDownloaded: "Excel downloaded successfully!",
                failedDownload: "Failed to download Excel. Please try again.",
                settingsSaved: "Settings saved successfully!",
                profileUpdated: "Profile updated successfully!",
                aiDetected: "AI Detected {confidence}% confident",

                // OCR Tips
                ocrTipsTitle: "Quick Tips for Better OCR",
                ocrTipLighting: "Ensure good lighting and avoid shadows",
                ocrTipSteady: "Hold camera steady and keep receipt flat",
                ocrTipEdges: "Include all receipt edges in the photo",
                ocrTipBlur: "Avoid blurry or distorted images",
                ocrTipFormats: "Supported formats: JPG, PNG (max 5MB)",

                // AI Indicator
                aiSelected: "AI Selected",

                // Editable Table
                reviewEditExtractedData: "Review & Edit Extracted Data",
                saveChanges: "Save Changes",
                exportToExcel: "Export to Excel",
                field: "Field",
                value: "Value",
                status: "Status",
                ready: "‚úì Ready",
                changesSaved: "Changes saved locally.",
                saveToHQ: "Save to HQ Ledger",
                saveReceiptToLocation: "Save Receipt to {location}",
                businessLocationLabel: "Business Location",
                selectLocation: "Select location",
                readyForHqSave: "Ready for HQ save",
                locationRequired: "Select a business location before saving.",
                operatorMissing: "Operator details missing. Please complete your profile.",
                savingReceipt: "Saving receipt to HQ...",
                duplicateWarning: "Potential duplicate detected.",
                forceSavePrompt: "Duplicate found. Force save anyway?",
                savedReceipt: "Receipt saved to HQ ledger!",
                downloadWorkbook: "Download workbook",
                savedToPath: "Saved to {path}."
            },
            ja: {
                // Welcome Modal
                welcomeTitle: "Ê†™Âºè‰ºöÁ§æ„Çø„Ç∑„É≠ÈâÑÂ∑•ÊâÄ",
                welcomeSubtitle: "„Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´È†òÂèéÊõ∏OCRËá™ÂãïÂåñ„Ç∑„Çπ„ÉÜ„É†",
                fullName: "Ê∞èÂêç",
                emailAddress: "„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ",
                employeeId: "Á§æÂì°IDÔºà‰ªªÊÑèÔºâ",
                launchSystem: "OCR„Ç∑„Çπ„ÉÜ„É†„ÇíËµ∑Âãï",
                enterFullName: "Ê∞èÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ",
                enterEmail: "your.email@company.com",
                enterEmployeeId: "TY-2045",

                // Profile Modal
                updateProfile: "„Éó„É≠„Éï„Ç£„Éº„É´„ÇíÊõ¥Êñ∞",
                keepInfoUpdated: "ÊÉÖÂ†±„ÇíÊúÄÊñ∞„Å´‰øù„Å§",
                updateProfileBtn: "„Éó„É≠„Éï„Ç£„Éº„É´„ÇíÊõ¥Êñ∞",
                cancel: "„Ç≠„É£„É≥„Çª„É´",

                // Settings Modal
                appSettings: "„Ç¢„Éó„É™Ë®≠ÂÆö",
                customizeExperience: "‰ΩìÈ®ì„Çí„Ç´„Çπ„Çø„Éû„Ç§„Ç∫",
                theme: "„ÉÜ„Éº„Éû",
                language: "Ë®ÄË™û",
                notifications: "ÈÄöÁü•",
                autoSave: "„Éï„Ç©„Éº„É†„ÅÆËá™Âãï‰øùÂ≠ò",
                lightMode: "„É©„Ç§„Éà„É¢„Éº„Éâ",
                darkMode: "„ÉÄ„Éº„ÇØ„É¢„Éº„Éâ",
                autoSystem: "Ëá™ÂãïÔºà„Ç∑„Çπ„ÉÜ„É†Ôºâ",
                english: "English",
                japanese: "Êó•Êú¨Ë™û",
                allNotifications: "„Åô„Åπ„Å¶„ÅÆÈÄöÁü•",
                importantOnly: "ÈáçË¶Å„Å™„ÇÇ„ÅÆ„ÅÆ„Åø",
                disabled: "ÁÑ°Âäπ",
                enabled: "ÊúâÂäπ",
                saveSettings: "Ë®≠ÂÆö„Çí‰øùÂ≠ò",

                // Main App
                ocrSystem: "È†òÂèéÊõ∏OCRËá™ÂãïÂåñ„Ç∑„Çπ„ÉÜ„É†",
                tashiroIronworks: "Ê†™Âºè‰ºöÁ§æ„Çø„Ç∑„É≠ÈâÑÂ∑•ÊâÄ",
                guestUser: "„Ç≤„Çπ„Éà„É¶„Éº„Ç∂„Éº",
                guestEmail: "guest@example.com",

                // Page title
                pageTitle: "Ê†™Âºè‰ºöÁ§æ„Çø„Ç∑„É≠ÈâÑÂ∑•ÊâÄ - „Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´OCR„Ç∑„Çπ„ÉÜ„É†",

                // Cards
                captureReceipt: "È†òÂèéÊõ∏„Çí„Ç≠„É£„Éó„ÉÅ„É£",
                takePhotoOrUpload: "ÂÜôÁúü„ÇíÊíÆ„Çã„ÅãÊó¢Â≠ò„ÅÆÈ†òÂèéÊõ∏ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ",
                takePhoto: "ÂÜôÁúü„ÇíÊíÆ„Çã",
                useDeviceCamera: "„Éá„Éê„Ç§„Çπ„ÅÆ„Ç´„É°„É©„Çí‰ΩøÁî®",
                uploadFile: "„Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ",
                jpgPngOrPdf: "JPG„ÄÅPNG„ÄÅ„Åæ„Åü„ÅØPDF",
                dragDropHere: "È†òÂèéÊõ∏ÁîªÂÉè„Çí„Åì„Åì„Å´„Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó",
                orUseOptionsAbove: "„Åæ„Åü„ÅØ‰∏äË®ò„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥„Çí‰ΩøÁî®",

                ocrReview: "OCRÁ¢∫Ë™ç„Å®Ê§úË®º",
                verifyExtractedData: "ÊäΩÂá∫„Åï„Çå„Åü„Éá„Éº„Çø„ÇíÁ¢∫Ë™ç„ÅóÊú¨Á§æ„Å´ÊèêÂá∫",
                receiptFieldMapping: "È†òÂèéÊõ∏„Éï„Ç£„Éº„É´„Éâ„Éû„ÉÉ„Éî„É≥„Ç∞ÔºàA-FÔºâ",
                verifyDataMatches: "ÊäΩÂá∫„Åï„Çå„Åü„Éá„Éº„Çø„ÅåÈ†òÂèéÊõ∏„ÅÆÂÜÖÂÆπ„Å®‰∏ÄËá¥„Åô„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç",

                // Field Labels
                dateLabel: "Êó•‰ªò",
                storeNameLabel: "Â∫óÂêç",
                totalAmountLabel: "ÈáëÈ°ç",
                invoiceNumberLabel: "„Ç§„É≥„Éú„Ç§„ÇπÁï™Âè∑",
                taxCategoryLabel: "Á®éÂå∫ÂàÜ",
                accountTitleLabel: "ÂãòÂÆöÁßëÁõÆ",
                selectTaxCategory: "Á®éÂå∫ÂàÜ„ÇíÈÅ∏Êäû",
                selectAccountTitle: "ÂãòÂÆöÁßëÁõÆ„ÇíÈÅ∏Êäû",

                // Account Titles
                meals: "È£üË≤ª",
                transportation: "‰∫§ÈÄöË≤ª",
                communication: "ÈÄö‰ø°Ë≤ª",
                accommodation: "ÂÆøÊ≥äË≤ª",
                entertainment: "Êé•ÂæÖ‰∫§ÈöõË≤ª",
                officeSupplies: "Ê∂àËÄóÂìÅË≤ª",
                meetingExpenses: "‰ºöË≠∞Ë≤ª",
                training: "Á†î‰øÆË≤ª",
                welfare: "Á¶èÂà©ÂéöÁîüË≤ª",
                advertising: "Â∫ÉÂëäÂÆ£‰ºùË≤ª",
                vehicle: "Ëªä‰∏°Ë≤ª",
                insurance: "‰øùÈô∫Êñô",
                taxesDues: "ÁßüÁ®éÂÖ¨Ë™≤",
                other: "„Åù„ÅÆ‰ªñ",

                // Additional Info
                additionalInformation: "ËøΩÂä†ÊÉÖÂ†±",
                subtotalRef: "Â∞èË®àÔºàÂèÇËÄÉÔºâ",
                taxAmountRef: "Á®éÈ°çÔºàÂèÇËÄÉÔºâ",
                currency: "ÈÄöË≤®",

                // Buttons
                submitToHq: "Êú¨Á§æ„Å´ÊèêÂá∫",
                reviewData: "„Éá„Éº„Çø„ÇíÁ¢∫Ë™ç",
                startOver: "ÊúÄÂàù„Åã„Çâ„ÇÑ„ÇäÁõ¥„Åô",

                // Verification
                allFieldsVerified: "„Åô„Åπ„Å¶„ÅÆ„Éï„Ç£„Éº„É´„Éâ„ÅåÊ≠£Â∏∏„Å´Ê§úË®º„Åï„Çå„Åæ„Åó„ÅüÔºÅ",
                highConfidence: "È´ò‰ø°È†ºÊÄß",

                // History
                submissionHistory: "ÊèêÂá∫Â±•Ê≠¥",
                recentReceipts: "ÊúÄËøë„ÅÆÈ†òÂèéÊõ∏„Å®„Åù„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ",
                noSubmissionsYet: "„Åæ„Å†ÊèêÂá∫„Åå„ÅÇ„Çä„Åæ„Åõ„Çì",
                startScanning: "È†òÂèéÊõ∏„Çí„Çπ„Ç≠„É£„É≥„Åó„Å¶„Åì„Åì„Å´Ë°®Á§∫",
                submitted: "ÊèêÂá∫Ê∏à„Åø",

                // Placeholders
                yyyyMmDd: "YYYY-MM-DD",
                storeName: "Â∫óÂêç",
                zeroZero: "0.00",
                invoiceReceiptNo: "„Ç§„É≥„Éú„Ç§„Çπ/È†òÂèéÊõ∏Áï™Âè∑",
                jpy: "JPY",

                // Image placeholder
                noReceiptImage: "È†òÂèéÊõ∏ÁîªÂÉè„Åå„ÅÇ„Çä„Åæ„Åõ„Çì",
                uploadReceiptToSeePreview: "È†òÂèéÊõ∏„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Éó„É¨„Éì„É•„Éº„ÇíË°®Á§∫",

                // Developer credit
                developerCredit: "by: Eshwar Potnuru ‚Äì Ê©üÊ¢∞Â≠¶Áøí„Ç®„É≥„Ç∏„Éã„Ç¢„ÄÅAIM Co. Pvt.",

                // Toast Messages
                welcomeMessage: "{name}„Åï„Çì„ÄÅ„Çà„ÅÜ„Åì„ÅùÔºÅÈ†òÂèéÊõ∏„ÅÆÂá¶ÁêÜ„ÇíÈñãÂßã„Åß„Åç„Åæ„Åô„ÄÇ",
                processingReceipt: "È†òÂèéÊõ∏ÁîªÂÉè„ÇíÂá¶ÁêÜ‰∏≠...",
                receiptAnalyzed: "È†òÂèéÊõ∏„ÅÆÂàÜÊûê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ„Åô„Åπ„Å¶„ÅÆ„Éï„Ç£„Éº„É´„Éâ„ÅåÊäΩÂá∫„Åï„Çå„Åæ„Åó„Åü„ÄÇ",
                failedToAnalyze: "È†òÂèéÊõ∏„ÅÆÂàÜÊûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ",
                formReset: "„Éï„Ç©„Éº„É†„Åå„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åó„Åü„ÄÇÊñ∞Ë¶èÈ†òÂèéÊõ∏„ÅÆÊ∫ñÂÇô„Åå„Åß„Åç„Åæ„Åó„Åü„ÄÇ",
                noReceiptData: "ÊèêÂá∫„Åô„ÇãÈ†òÂèéÊõ∏„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Åæ„ÅöÈ†òÂèéÊõ∏„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                receiptSubmitted: "È†òÂèéÊõ∏„ÅåÊú¨Á§æ„Å´Ê≠£Â∏∏„Å´ÊèêÂá∫„Åï„Çå„Åæ„Åó„ÅüÔºÅ",
                failedToSubmit: "È†òÂèéÊõ∏„ÅÆÊèêÂá∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ",
                preparingDownload: "Excel„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„ÇíÊ∫ñÂÇô‰∏≠...",
                excelDownloaded: "Excel„ÅåÊ≠£Â∏∏„Å´„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åï„Çå„Åæ„Åó„ÅüÔºÅ",
                failedDownload: "Excel„ÅÆ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ",
                settingsSaved: "Ë®≠ÂÆö„ÅåÊ≠£Â∏∏„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åó„ÅüÔºÅ",
                profileUpdated: "„Éó„É≠„Éï„Ç£„Éº„É´„ÅåÊ≠£Â∏∏„Å´Êõ¥Êñ∞„Åï„Çå„Åæ„Åó„ÅüÔºÅ",
                aiDetected: "AIÊ§úÂá∫ {confidence}% ‰ø°È†ºÊÄß",

                // OCR Tips
                ocrTipsTitle: "OCRÁ≤æÂ∫¶Âêë‰∏ä„ÅÆ„Åü„ÇÅ„ÅÆ„ÇØ„Ç§„ÉÉ„ÇØTips",
                ocrTipLighting: "ÂçÅÂàÜ„Å™ÁÖßÊòé„ÇíÁ¢∫‰øù„Åó„ÄÅÂΩ±„ÇíÈÅø„Åë„Çã",
                ocrTipSteady: "„Ç´„É°„É©„ÇíÂÆâÂÆö„Åï„Åõ„ÄÅÈ†òÂèéÊõ∏„ÇíÂπ≥„Çâ„Å´‰øù„Å§",
                ocrTipEdges: "ÂÜôÁúü„Å´È†òÂèéÊõ∏„ÅÆ„Åô„Åπ„Å¶„ÅÆÁ´Ø„ÇíÂê´„ÇÅ„Çã",
                ocrTipBlur: "„Åº„ÇÑ„Åë„ÇÑÊ≠™„Åø„ÇíÈÅø„Åë„Çã",
                ocrTipFormats: "ÂØæÂøú„Éï„Ç©„Éº„Éû„ÉÉ„Éà: JPG, PNG (ÊúÄÂ§ß5MB)",

                // AI Indicator
                aiSelected: "AIÊ§úÂá∫",

                // Editable Table
                reviewEditExtractedData: "ÊäΩÂá∫„Éá„Éº„Çø„ÅÆÁ¢∫Ë™ç„Å®Á∑®ÈõÜ",
                saveChanges: "Â§âÊõ¥„Çí‰øùÂ≠ò",
                exportToExcel: "Excel„Å´„Ç®„ÇØ„Çπ„Éù„Éº„Éà",
                field: "„Éï„Ç£„Éº„É´„Éâ",
                value: "ÂÄ§",
                status: "„Çπ„ÉÜ„Éº„Çø„Çπ",
                ready: "‚úì Ê∫ñÂÇôÂÆå‰∫Ü",
                changesSaved: "Â§âÊõ¥„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ",
                saveToHQ: "HQÂè∞Â∏≥„Å´‰øùÂ≠ò",
                saveReceiptToLocation: "{location} „Å´‰øùÂ≠ò",
                businessLocationLabel: "‰∫ãÊ•≠ÊâÄ",
                selectLocation: "‰∫ãÊ•≠ÊâÄ„ÇíÈÅ∏Êäû",
                readyForHqSave: "HQ‰øùÂ≠ò„ÅÆÊ∫ñÂÇôÂÆå‰∫Ü",
                locationRequired: "‰øùÂ≠òÂâç„Å´‰∫ãÊ•≠ÊâÄ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                operatorMissing: "„Ç™„Éö„É¨„Éº„Çø„ÉºÊÉÖÂ†±„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Éó„É≠„Éï„Ç£„Éº„É´„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                savingReceipt: "HQ„Å∏‰øùÂ≠ò‰∏≠...",
                duplicateWarning: "ÈáçË§á„ÅÆÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ",
                forceSavePrompt: "ÈáçË§á„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åó„Åü„ÄÇÂº∑Âà∂‰øùÂ≠ò„Åó„Åæ„Åô„ÅãÔºü",
                savedReceipt: "HQÂè∞Â∏≥„Å´‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ",
                downloadWorkbook: "Âè∞Â∏≥„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ",
                savedToPath: "{path} „Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åó„Åü„ÄÇ"
            }
        };

        // Current language
        let currentLanguage = 'en';

        // Translation function
        function t(key, params = {}) {
            let text = translations[currentLanguage][key] || translations['en'][key] || key;

            // Replace parameters
            Object.keys(params).forEach(param => {
                text = text.replace(`{${param}}`, params[param]);
            });

            return text;
        }

// Update field labels based on extracted data
function updateFieldLabels() {
    const fieldTexts = document.querySelectorAll('.field-text');
    if (fieldTexts.length >= 6) {
        const dateValue = document.getElementById('fieldDate').value;
        const vendorValue = document.getElementById('fieldVendor').value;
        const totalValue = document.getElementById('fieldTotal').value;
        const invoiceValue = document.getElementById('fieldInvoiceNumber').value;
        const taxValue = document.getElementById('fieldTaxCategory').value;
        const accountValue = document.getElementById('fieldAccountTitle').value;
        
        fieldTexts[0].textContent = dateValue ? `${t('dateLabel')}: ${dateValue}` : t('dateLabel');
        fieldTexts[1].textContent = vendorValue ? `${t('storeNameLabel')}: ${vendorValue}` : t('storeNameLabel');
        fieldTexts[2].textContent = totalValue ? `${t('totalAmountLabel')}: ${totalValue}` : t('totalAmountLabel');
        fieldTexts[3].textContent = invoiceValue ? `${t('invoiceNumberLabel')}: ${invoiceValue}` : t('invoiceNumberLabel');
        fieldTexts[4].textContent = taxValue ? `${t('taxCategoryLabel')}: ${taxValue}` : t('taxCategoryLabel');
        fieldTexts[5].textContent = accountValue ? `${t('accountTitleLabel')}: ${accountValue}` : t('accountTitleLabel');
    }
}        // Apply translations to the page
        let languageUpdateScheduled = false;

        function applyLanguage(language) {
            currentLanguage = language;
            document.documentElement.lang = language;
            document.title = t('pageTitle');

            if (languageUpdateScheduled) {
                return;
            }

            languageUpdateScheduled = true;
            requestAnimationFrame(() => {
                languageUpdateScheduled = false;
                refreshLocalizedContent();
            });
        }

        function refreshLocalizedContent() {
            // Welcome Modal
            document.querySelector('#welcomeModal h1').textContent = t('welcomeTitle');
            document.querySelector('#welcomeModal .modal-subtitle').textContent = t('welcomeSubtitle');
            document.querySelector('label[for="userName"]').innerHTML = `${t('fullName')} <span class="required">*</span>`;
            document.querySelector('label[for="userEmail"]').innerHTML = `${t('emailAddress')} <span class="required">*</span>`;
            document.querySelector('label[for="employeeId"]').textContent = t('employeeId');
            document.querySelector('#registrationForm button[type="submit"]').innerHTML = `<i class="fas fa-rocket"></i> ${t('launchSystem')}`;
            document.getElementById('userName').placeholder = t('enterFullName');
            document.getElementById('userEmail').placeholder = t('enterEmail');
            document.getElementById('employeeId').placeholder = t('enterEmployeeId');

            // Profile Modal
            document.querySelector('#profileModal h1').textContent = t('updateProfile');
            document.querySelector('#profileModal .modal-subtitle').textContent = t('keepInfoUpdated');
            document.querySelector('label[for="updateUserName"]').innerHTML = `${t('fullName')} <span class="required">*</span>`;
            document.querySelector('label[for="updateUserEmail"]').innerHTML = `${t('emailAddress')} <span class="required">*</span>`;
            document.querySelector('label[for="updateEmployeeId"]').textContent = t('employeeId');
            document.querySelector('#profileForm button[type="submit"]').innerHTML = `<i class="fas fa-save"></i> ${t('updateProfileBtn')}`;
            document.getElementById('cancelProfileUpdate').textContent = t('cancel');
            document.getElementById('updateUserName').placeholder = t('enterFullName');
            document.getElementById('updateUserEmail').placeholder = t('enterEmail');
            document.getElementById('updateEmployeeId').placeholder = t('enterEmployeeId');

            // Settings Modal
            document.querySelector('#settingsModal h1').textContent = t('appSettings');
            document.querySelector('#settingsModal .modal-subtitle').textContent = t('customizeExperience');
            document.querySelector('label[for="themeToggle"]').textContent = t('theme');
            document.querySelector('label[for="languageSelect"]').textContent = t('language');
            document.querySelector('label[for="notificationToggle"]').textContent = t('notifications');
            document.querySelector('label[for="autoSaveToggle"]').textContent = t('autoSave');
            document.getElementById('saveSettings').innerHTML = `<i class="fas fa-save"></i> ${t('saveSettings')}`;
            document.getElementById('cancelSettings').textContent = t('cancel');

            // Update select options
            const themeSelect = document.getElementById('themeToggle');
            themeSelect.querySelector('option[value="light"]').textContent = t('lightMode');
            themeSelect.querySelector('option[value="dark"]').textContent = t('darkMode');
            themeSelect.querySelector('option[value="auto"]').textContent = t('autoSystem');

            const languageSelect = document.getElementById('languageSelect');
            languageSelect.querySelector('option[value="en"]').textContent = t('english');
            languageSelect.querySelector('option[value="ja"]').textContent = t('japanese');

            const notificationSelect = document.getElementById('notificationToggle');
            notificationSelect.querySelector('option[value="all"]').textContent = t('allNotifications');
            notificationSelect.querySelector('option[value="important"]').textContent = t('importantOnly');
            notificationSelect.querySelector('option[value="none"]').textContent = t('disabled');

            const autoSaveSelect = document.getElementById('autoSaveToggle');
            autoSaveSelect.querySelector('option[value="enabled"]').textContent = t('enabled');
            autoSaveSelect.querySelector('option[value="disabled"]').textContent = t('disabled');

            // Main App Header
            document.querySelector('.header-left h1').textContent = t('ocrSystem');
            document.querySelector('.header-left p').textContent = t('tashiroIronworks');

            // Cards - Update each card specifically
            const cards = document.querySelectorAll('.card');
            if (cards.length >= 3) {
                // First card: Capture Receipt
                const captureCard = cards[0];
                captureCard.querySelector('.card-title').textContent = t('captureReceipt');
                captureCard.querySelector('.card-description').textContent = t('takePhotoOrUpload');

                // Second card: OCR Review & Verification
                const ocrCard = cards[1];
                ocrCard.querySelector('.card-title').textContent = t('ocrReview');
                ocrCard.querySelector('.card-description').textContent = t('verifyExtractedData');

                // Third card: Submission History
                const historyCard = cards[2];
                historyCard.querySelector('.card-title').textContent = t('submissionHistory');
                historyCard.querySelector('.card-description').textContent = t('recentReceipts');
            }

            // Upload buttons and text
            const uploadButtons = document.querySelectorAll('.upload-button');
            if (uploadButtons.length >= 2) {
                uploadButtons[0].querySelector('.upload-text').textContent = t('takePhoto');
                uploadButtons[0].querySelector('.upload-subtext').textContent = t('useDeviceCamera');
                uploadButtons[1].querySelector('.upload-text').textContent = t('uploadFile');
                uploadButtons[1].querySelector('.upload-subtext').textContent = t('jpgPngOrPdf');
            }

            // Dropzone text
            const dropzone = document.getElementById('dropzone');
            if (dropzone) {
                const dropzoneParagraphs = dropzone.querySelectorAll('p');
                if (dropzoneParagraphs.length >= 2) {
                    dropzoneParagraphs[0].textContent = t('dragDropHere');
                    dropzoneParagraphs[1].textContent = t('orUseOptionsAbove');
                }
            }

            // Field placeholders
            document.getElementById('fieldDate').placeholder = t('yyyyMmDd');
            document.getElementById('fieldVendor').placeholder = t('storeName');
            document.getElementById('fieldTotal').placeholder = t('zeroZero');
            document.getElementById('fieldInvoiceNumber').placeholder = t('invoiceReceiptNo');
            document.getElementById('fieldCurrency').placeholder = t('jpy');

            // Image placeholder text
            const imagePlaceholder = document.getElementById('imagePlaceholder');
            if (imagePlaceholder) {
                const placeholderTexts = imagePlaceholder.querySelectorAll('p');
                if (placeholderTexts.length >= 2) {
                    placeholderTexts[0].textContent = t('noReceiptImage');
                    placeholderTexts[1].textContent = t('uploadReceiptToSeePreview');
                }
            }

            // Field mapping header and labels
            const fieldMappingHeader = document.querySelector('.field-mapping-header');
            if (fieldMappingHeader) {
                const headerElements = fieldMappingHeader.querySelectorAll('h3, p');
                if (headerElements.length >= 2) {
                    headerElements[0].textContent = t('receiptFieldMapping');
                    headerElements[1].textContent = t('verifyDataMatches');
                }
            }

            // Field labels
            const fieldLabels = document.querySelectorAll('.field-label');
            if (fieldLabels.length >= 6) {
                fieldLabels[0].querySelector('span:not(.field-badge)').textContent = t('dateLabel');
                fieldLabels[1].querySelector('span:not(.field-badge)').textContent = t('storeNameLabel');
                fieldLabels[2].querySelector('span:not(.field-badge)').textContent = t('totalAmountLabel');
                fieldLabels[3].querySelector('span:not(.field-badge)').textContent = t('invoiceNumberLabel');
                fieldLabels[4].querySelector('span:not(.field-badge)').textContent = t('taxCategoryLabel');
                fieldLabels[5].querySelector('span:not(.field-badge)').textContent = t('accountTitleLabel');
            }

            // Select options
            const taxCategorySelect = document.getElementById('fieldTaxCategory');
            if (taxCategorySelect) {
                const taxOptions = taxCategorySelect.querySelectorAll('option');
                if (taxOptions.length >= 4) {
                    taxOptions[0].textContent = t('selectTaxCategory');
                    // Keep the actual tax category values as they are in Japanese
                }
            }

            const accountTitleSelect = document.getElementById('fieldAccountTitle');
            if (accountTitleSelect) {
                const accountOptions = accountTitleSelect.querySelectorAll('option');
                if (accountOptions.length >= 15) {
                    accountOptions[0].textContent = t('selectAccountTitle');
                    accountOptions[1].textContent = t('meals');
                    accountOptions[2].textContent = t('transportation');
                    accountOptions[3].textContent = t('communication');
                    accountOptions[4].textContent = t('accommodation');
                    accountOptions[5].textContent = t('entertainment');
                    accountOptions[6].textContent = t('officeSupplies');
                    accountOptions[7].textContent = t('meetingExpenses');
                    accountOptions[8].textContent = t('training');
                    accountOptions[9].textContent = t('welfare');
                    accountOptions[10].textContent = t('advertising');
                    accountOptions[11].textContent = t('vehicle');
                    accountOptions[12].textContent = t('insurance');
                    accountOptions[13].textContent = t('taxesDues');
                    accountOptions[14].textContent = t('other');
                }
            }

            // Additional information header
            const additionalInfo = document.querySelector('.additional-info h4');
            if (additionalInfo) {
                additionalInfo.textContent = t('additionalInformation');
            }

            // Additional info field labels
            const additionalLabels = document.querySelectorAll('.additional-info label');
            console.log('Additional labels found (regular update):', additionalLabels.length);
            if (additionalLabels.length >= 3) {
                additionalLabels[0].textContent = t('subtotalRef');
                additionalLabels[1].textContent = t('taxAmountRef');
                additionalLabels[2].textContent = t('currency');
                console.log('Additional labels updated (regular):', additionalLabels[2].textContent);
            }

            if (businessLocationLabel) {
                businessLocationLabel.innerHTML = `${t('businessLocationLabel')} <span class="required">*</span>`;
            }
            if (businessLocationSelect) {
                populateLocationSelect();
            }

            // Form action buttons
            const submitBtn = document.getElementById('submitButton');
            const reviewBtn = document.getElementById('reviewDataBtn');
            const resetBtn = document.getElementById('resetButton');
            console.log('Updating buttons (regular):', submitBtn, reviewBtn, resetBtn);
            if (submitBtn) {
                submitBtn.innerHTML = `<i class="fas fa-paper-plane"></i> ${t('submitToHq')}`;
                console.log('Submit button updated to (regular):', submitBtn.innerHTML);
            }
            if (reviewBtn) {
                reviewBtn.innerHTML = `<i class="fas fa-edit"></i> ${t('reviewData')}`;
                console.log('Review button updated to (regular):', reviewBtn.innerHTML);
            }
            if (resetBtn) {
                resetBtn.innerHTML = `<i class="fas fa-redo"></i> ${t('startOver')}`;
                console.log('Reset button updated to (regular):', resetBtn.innerHTML);
            }

            // Verification status
            const verificationStatusElement = document.getElementById('verificationStatus');
            if (verificationStatusElement) {
                const statusElements = verificationStatusElement.querySelectorAll('.status-title, .confidence-badge');
                if (statusElements.length >= 2) {
                    statusElements[0].textContent = t('allFieldsVerified');
                    statusElements[1].textContent = t('highConfidence');
                }
            }

            // Developer credit
            const developerCredit = document.querySelector('.developer-credit');
            console.log('Developer credit element (regular):', developerCredit);
            if (developerCredit) {
                developerCredit.textContent = t('developerCredit');
                console.log('Developer credit updated to (regular):', developerCredit.textContent);
            }

            // Update history display if it exists
            console.log('Calling updateHistoryDisplay');
            updateHistoryDisplay();

            // Update OCR tips
            const ocrTipsElement = document.getElementById('ocrTips');
            if (ocrTipsElement) {
                const ocrTipsTitle = ocrTipsElement.querySelector('h4');
                const ocrTipsList = ocrTipsElement.querySelectorAll('li');
                
                if (ocrTipsTitle) {
                    ocrTipsTitle.innerHTML = `<i class="fas fa-lightbulb"></i> ${t('ocrTipsTitle')}`;
                }
                
                if (ocrTipsList.length >= 5) {
                    ocrTipsList[0].textContent = t('ocrTipLighting');
                    ocrTipsList[1].textContent = t('ocrTipSteady');
                    ocrTipsList[2].textContent = t('ocrTipEdges');
                    ocrTipsList[3].textContent = t('ocrTipBlur');
                    ocrTipsList[4].textContent = t('ocrTipFormats');
                }
            }

            // Update AI indicator text if visible
            const aiIndicator = document.getElementById('aiConfidenceIndicator');
            if (aiIndicator) {
                aiIndicator.innerHTML = '<i class="fas fa-robot"></i> ' + t('aiSelected');
            }

            // Update editable table elements
            const tableHeader = document.querySelector('.table-header h3');
            if (tableHeader) {
                tableHeader.textContent = t('reviewEditExtractedData');
            }

            const saveChangesBtn = document.getElementById('saveChangesBtn');
            if (saveChangesBtn) {
                saveChangesBtn.innerHTML = `<i class="fas fa-save"></i> ${t('saveChanges')}`;
            }

            const saveAccumulationBtn = document.getElementById('saveAccumulationBtn');
            if (saveAccumulationBtn) {
                updateSaveButtonLabel();
            }

            // Update table headers
            const tableHeaders = document.querySelectorAll('#editableTable th');
            if (tableHeaders.length >= 3) {
                tableHeaders[0].textContent = t('field');
                tableHeaders[1].textContent = t('value');
                tableHeaders[2].textContent = t('status');
            }

            // Update existing table rows if table is visible
            const dataTableContainer = document.getElementById('dataTableContainer');
            if (dataTableContainer && dataTableContainer.style.display !== 'none') {
                // Re-populate the table to update all translated content
                populateEditableTable();
            }

            // Update field labels based on current form values
            updateFieldLabels();

        }

        // DOM Elements
        const welcomeModal = document.getElementById('welcomeModal');
        const profileModal = document.getElementById('profileModal');
        const appContainer = document.getElementById('appContainer');
        const registrationForm = document.getElementById('registrationForm');
        const profileForm = document.getElementById('profileForm');
        const userNameInput = document.getElementById('userName');
        const userEmailInput = document.getElementById('userEmail');
        const employeeIdInput = document.getElementById('employeeId');
        const updateUserNameInput = document.getElementById('updateUserName');
        const updateUserEmailInput = document.getElementById('updateUserEmail');
        const updateEmployeeIdInput = document.getElementById('updateEmployeeId');
        const displayUserName = document.getElementById('displayUserName');
        const displayUserEmail = document.getElementById('displayUserEmail');
        const userAvatar = document.getElementById('userAvatar');
        const profileButton = document.getElementById('profileButton');
        const cancelProfileUpdate = document.getElementById('cancelProfileUpdate');
        const cameraButton = document.getElementById('cameraButton');
        const uploadButton = document.getElementById('uploadButton');
        const fileInput = document.getElementById('fileInput');
        const dropzone = document.getElementById('dropzone');
        const imagePlaceholder = document.getElementById('imagePlaceholder');
        const receiptImage = document.getElementById('receiptImage');
        const verificationStatus = document.getElementById('verificationStatus');
        const reviewDataBtn = document.getElementById('reviewDataBtn');
        const resetButton = document.getElementById('resetButton');
        const historyList = document.getElementById('historyList');
        const toastContainer = document.getElementById('toastContainer');
        const settingsButton = document.getElementById('settingsButton');
        const settingsModal = document.getElementById('settingsModal');
        const saveSettings = document.getElementById('saveSettings');
        const cancelSettings = document.getElementById('cancelSettings');
        const ocrDebugPanel = document.getElementById('ocrDebugPanel');
        const ocrDebugContent = document.getElementById('ocrDebugContent');
        const businessLocationSelect = document.getElementById('businessLocationSelect');
        const businessLocationLabel = document.querySelector('label[for="businessLocationSelect"]');
        const saveAccumulationBtn = document.getElementById('saveAccumulationBtn');
        const saveResultMessage = document.getElementById('saveResultMessage');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingMessage = document.getElementById('loadingMessage');
        const loadingSubtext = document.getElementById('loadingSubtext');
        const loadingStepUpload = document.getElementById('loadingStepUpload');
        const loadingStepQueue = document.getElementById('loadingStepQueue');
        const loadingStepExtraction = document.getElementById('loadingStepExtraction');

        if (businessLocationSelect) {
            businessLocationSelect.addEventListener('change', updateSaveButtonLabel);
        }

        // Global variables
        let currentQueueId = null;
        let accountClassifications = []; // Store loaded account classifications
        const LATEST_ANALYSIS_KEY = 'tashiro_latest_analysis_v1';
        let pollTimeoutHandle = null;
        const POLL_INTERVAL_MS = 3000;
        const MAX_POLL_ATTEMPTS = 40;
        let availableLocations = [];
        let locationSynonymMap = {};

        // Check if user is already registered
        function checkUserRegistration() {
            const userData = localStorage.getItem('tashiro_user');
            if (userData) {
                const user = JSON.parse(userData);
                displayUserInfo(user);
                welcomeModal.style.display = 'none';
                appContainer.style.display = 'block';
                return true;
            }
            return false;
        }

        // Display user information in the header
        function displayUserInfo(user) {
            displayUserName.textContent = user.name;
            displayUserEmail.textContent = user.email;
            userAvatar.textContent = user.name.substring(0, 2).toUpperCase();
            
            // Set values in profile update form
            updateUserNameInput.value = user.name;
            updateUserEmailInput.value = user.email;
            updateEmployeeIdInput.value = user.employeeId || '';
        }

        // Handle registration form submission
        registrationForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const userData = {
                name: userNameInput.value,
                email: userEmailInput.value,
                employeeId: employeeIdInput.value || null
            };
            
            // Save user data to localStorage
            localStorage.setItem('tashiro_user', JSON.stringify(userData));
            
            // Update UI with user info
            displayUserInfo(userData);
            
            // Hide modal and show app
            welcomeModal.style.display = 'none';
            appContainer.style.display = 'block';
            
            // Show welcome toast
            showToast(t('welcomeMessage', {name: userData.name}), 'success');
        });

        function saveLatestAnalysis(queueId, fields) {
            try {
                const fieldWhitelist = ['date','vendor','total','invoice_number','tax_category','account_title','subtotal','tax','currency'];
                const sanitized = {};
                fieldWhitelist.forEach(key => sanitized[key] = fields[key] || '');
                localStorage.setItem(LATEST_ANALYSIS_KEY, JSON.stringify({
                    queue_id: queueId,
                    fields: sanitized,
                    timestamp: new Date().toISOString()
                }));
            } catch (err) {
                console.warn('Failed to persist latest analysis', err);
            }
        }

        function restoreLatestAnalysis() {
            try {
                const cached = localStorage.getItem(LATEST_ANALYSIS_KEY);
                if (!cached) {
                    return;
                }
                const parsed = JSON.parse(cached);
                if (!parsed.fields) {
                    return;
                }
                currentQueueId = parsed.queue_id || null;
                applyOcrResultsToForm(parsed.fields);
                reviewDataBtn.disabled = false;
                showResultsTable();
                renderOcrDebugPanel(parsed.fields, parsed.queue_id);
                showToast('Restored latest analysis', 'info');
            } catch (err) {
                console.warn('Failed to restore cached analysis', err);
            }
        }

        function loadLocationsFromServer() {
            fetch('/api/locations')
                .then(resp => resp.json())
                .then(data => {
                    availableLocations = data.locations || [];
                    locationSynonymMap = data.synonyms || {};
                    populateLocationSelect();
                })
                .catch(err => {
                    console.warn('Failed to load locations', err);
                });
        }

        function populateLocationSelect(locations = availableLocations, selectedValue = null) {
            if (!businessLocationSelect) {
                return;
            }
            const normalizedLocations = Array.isArray(locations) ? locations : [];
            const desiredValue = selectedValue ?? businessLocationSelect.value;
            businessLocationSelect.innerHTML = `<option value="">${t('selectLocation')}</option>`;
            normalizedLocations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                businessLocationSelect.appendChild(option);
            });
            if (desiredValue && normalizedLocations.includes(desiredValue)) {
                businessLocationSelect.value = desiredValue;
            }
            updateSaveButtonLabel();
        }

        function updateSaveButtonLabel() {
            if (!saveAccumulationBtn) {
                return;
            }
            let label = t('saveToHQ');
            if (businessLocationSelect && businessLocationSelect.value) {
                const index = businessLocationSelect.selectedIndex;
                const readable = businessLocationSelect.options[index]?.textContent || businessLocationSelect.value;
                label = t('saveReceiptToLocation', { location: readable });
            }
            saveAccumulationBtn.innerHTML = `<i class="fas fa-database"></i> ${label}`;
        }

        function guessLocationFromFields(fields) {
            if (!fields) {
                return null;
            }
            const possibleSources = [fields.business_office, fields.location, fields.vendor, fields.store_name];
            const candidates = possibleSources.filter(Boolean).map(text => text.toString().toLowerCase());
            if (!candidates.length) {
                return null;
            }
            for (const candidate of candidates) {
                for (const loc of availableLocations) {
                    if (candidate.includes(loc.toLowerCase())) {
                        return loc;
                    }
                }
                for (const [synonym, canonical] of Object.entries(locationSynonymMap)) {
                    if (candidate.includes(synonym.toLowerCase())) {
                        return canonical;
                    }
                }
            }
            return null;
        }

        // Handle profile update
        profileButton.addEventListener('click', function() {
            profileModal.style.display = 'flex';
        });

        cancelProfileUpdate.addEventListener('click', function() {
            profileModal.style.display = 'none';
        });

        // Handle settings
        settingsButton.addEventListener('click', function() {
            loadSettings();
            settingsModal.style.display = 'flex';
        });

        cancelSettings.addEventListener('click', function() {
            settingsModal.style.display = 'none';
        });

        saveSettings.addEventListener('click', function() {
            // Close modal immediately
            settingsModal.style.display = 'none';
            
            // Save settings and apply them
            saveSettingsToStorage();
            
            // Show success toast
            showToast(t('settingsSaved'), 'success');
        });

        function updateLoadingSteps(activeStep) {
            const steps = [loadingStepUpload, loadingStepQueue, loadingStepExtraction];
            steps.forEach((step, index) => {
                if (!step) return;
                if (index <= activeStep) {
                    step.style.fontWeight = '700';
                    step.style.color = 'var(--primary-blue)';
                } else {
                    step.style.fontWeight = '400';
                    step.style.color = 'var(--dark-gray)';
                }
            });
        }

        function showLoadingOverlay({ message, subtext, stepIndex }) {
            if (!loadingOverlay) {
                return;
            }
            loadingOverlay.classList.add('active');
            if (loadingMessage && message) {
                loadingMessage.textContent = message;
            }
            if (loadingSubtext && subtext) {
                loadingSubtext.textContent = subtext;
            }
            updateLoadingSteps(stepIndex ?? 0);
        }

        function hideLoadingOverlay() {
            if (loadingOverlay) {
                loadingOverlay.classList.remove('active');
            }
        }

        profileForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const userData = {
                name: updateUserNameInput.value,
                email: updateUserEmailInput.value,
                employeeId: updateEmployeeIdInput.value || null
            };
            
            // Save updated user data
            localStorage.setItem('tashiro_user', JSON.stringify(userData));
            
            // Update UI with new user info
            displayUserInfo(userData);
            
            // Hide modal
            profileModal.style.display = 'none';
            
            // Show success toast
            showToast(t('profileUpdated'), 'success');
        });

        // Handle camera button click
        cameraButton.addEventListener('click', function() {
            // Trigger the file input with camera capture
            fileInput.setAttribute('capture', 'environment');
            fileInput.click();
        });

        // Handle upload button click
        uploadButton.addEventListener('click', function() {
            // Remove camera capture attribute for file upload
            fileInput.removeAttribute('capture');
            fileInput.click();
        });

        // Handle file selection
        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });

        // Handle drag and drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropzone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropzone.classList.add('active');
        }

        function unhighlight() {
            dropzone.classList.remove('active');
        }

        dropzone.addEventListener('drop', function(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });

        function resetPollingTimer() {
            if (pollTimeoutHandle) {
                clearTimeout(pollTimeoutHandle);
                pollTimeoutHandle = null;
            }
        }

        function handleQueuedAnalysis(queueId) {
            currentQueueId = queueId;
            showToast('Receipt added to OCR queue. Monitoring progress‚Ä¶', 'info');
            showLoadingOverlay({
                message: 'OCR in progress‚Ä¶',
                subtext: 'Both Google Vision and OpenAI engines are working.',
                stepIndex: 1
            });
            pollAnalysisStatus(queueId, 0);
        }

        function pollAnalysisStatus(queueId, attempt = 0) {
            if (!queueId) {
                return;
            }
            if (attempt > MAX_POLL_ATTEMPTS) {
                resetPollingTimer();
                showToast('OCR analysis timed out. Please try again.', 'error');
                return;
            }

            const fetchStatus = () => {
                fetch(`/api/mobile/analyze/status/${queueId}`)
                    .then(resp => {
                        if (!resp.ok) {
                            throw new Error('Status endpoint failed');
                        }
                        return resp.json();
                    })
                    .then(statusPayload => {
                        const status = statusPayload.status;
                        if (status === 'completed' && statusPayload.fields) {
                            resetPollingTimer();
                            applyOcrResultsToForm(statusPayload.fields);
                            reviewDataBtn.disabled = false;
                            showResultsTable();
                            showToast(t('receiptAnalyzed'), 'success');
                            showLoadingOverlay({
                                message: 'Extracting fields‚Ä¶',
                                subtext: 'Applying enhanced field extractor.',
                                stepIndex: 2
                            });
                            hideLoadingOverlay();
                        } else if (status === 'failed') {
                            resetPollingTimer();
                            showToast('OCR job failed. Please retry.', 'error');
                            hideLoadingOverlay();
                        } else {
                            pollAnalysisStatus(queueId, attempt + 1);
                        }
                    })
                    .catch(err => {
                        console.warn('Status polling error', err);
                        pollAnalysisStatus(queueId, attempt + 1);
                    });
            };

            if (attempt === 0) {
                fetchStatus();
            } else {
                pollTimeoutHandle = setTimeout(fetchStatus, POLL_INTERVAL_MS);
            }
        }

        // Handle file upload
        function handleFileUpload(file) {
            resetPollingTimer();
            // Debug file information
            console.log('File upload debug:', {
                name: file.name,
                size: file.size,
                type: file.type,
                lastModified: file.lastModified
            });
            
            // Validate file
            if (!file || file.size === 0) {
                showToast('Error: No file selected or file is empty', 'error');
                return;
            }
            
            if (file.size < 100) {
                showToast('Error: File too small (' + file.size + ' bytes). Please select a valid image.', 'error');
                return;
            }
            
            showToast(t('processingReceipt'), 'info');
            showLoadingOverlay({
                message: t('processingReceipt') || 'Processing receipt‚Ä¶',
                subtext: 'Optimizing image and preparing upload‚Ä¶',
                stepIndex: 0
            });
            
            // Create a preview of the image
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePlaceholder.style.display = 'none';
                receiptImage.src = e.target.result;
                receiptImage.style.display = 'block';
            };
            reader.readAsDataURL(file);
            
            // Prepare form data for API call
            const formData = new FormData();
            formData.append('file', file);
            formData.append('processing_mode', 'async');
            
            // Call OCR API
            fetch('/api/mobile/analyze', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('OCR API response:', data);
                if (data.status === 'queued') {
                    showLoadingOverlay({
                        message: 'Running OCR engines‚Ä¶',
                        subtext: 'We will notify you when it is ready.',
                        stepIndex: 1
                    });
                    handleQueuedAnalysis(data.queue_id);
                    return;
                }
                if (data.status === 'completed' && data.fields) {
                    currentQueueId = data.queue_id;
                    applyOcrResultsToForm(data.fields);
                    reviewDataBtn.disabled = false;
                    showResultsTable();
                    showToast(t('receiptAnalyzed'), 'success');
                    hideLoadingOverlay();
                    return;
                }
                if (data.fields) {
                    currentQueueId = data.queue_id;
                    applyOcrResultsToForm(data.fields);
                    reviewDataBtn.disabled = false;
                    showResultsTable();
                    showToast(t('receiptAnalyzed'), 'success');
                    hideLoadingOverlay();
                    return;
                }
                throw new Error('No fields extracted');
            })
            .catch(error => {
                console.error('OCR Error:', error);
                showToast(t('failedToAnalyze'), 'error');
                hideLoadingOverlay();
                
                // Fallback to sample data for testing
                document.getElementById('fieldDate').value = '2025-07-02';
                document.getElementById('fieldVendor').value = 'Sample Store';
                document.getElementById('fieldTotal').value = '1000';
                document.getElementById('fieldInvoiceNumber').value = '12345';
                document.getElementById('fieldTaxCategory').value = 'Ê®ôÊ∫ñÁ®éÁéá';
                document.getElementById('fieldAccountTitle').value = '‰∫§ÈÄöË≤ª';
                document.getElementById('fieldSubtotal').value = '909';
                document.getElementById('fieldTax').value = '91';
                document.getElementById('fieldCurrency').value = 'JPY';
                
                verificationStatus.style.display = 'flex';
                renderOcrDebugPanel({
                    date: '2025-07-02',
                    vendor: 'Sample Store',
                    total: '1000',
                    invoice_number: '12345',
                    tax_category: 'Ê®ôÊ∫ñÁ®éÁéá',
                    account_title: '‰∫§ÈÄöË≤ª',
                    subtotal: '909',
                    tax: '91',
                    currency: 'JPY'
                });
            });
        }

        function applyOcrResultsToForm(fields) {
            document.getElementById('fieldDate').value = fields.date || '';
            document.getElementById('fieldVendor').value = fields.vendor || '';
            document.getElementById('fieldTotal').value = fields.total || '';
            document.getElementById('fieldInvoiceNumber').value = fields.invoice_number || '';

            let taxCategoryValue = fields.tax_category || '';
            if (taxCategoryValue === 'Ë™≤Á®é') {
                taxCategoryValue = 'Ê®ôÊ∫ñÁ®éÁéá';
            }
            document.getElementById('fieldTaxCategory').value = taxCategoryValue;

            document.getElementById('fieldAccountTitle').value = fields.account_title || '';

            const aiIndicator = document.getElementById('aiConfidenceIndicator');
            if (aiIndicator) {
                if (fields.account_title) {
                    aiIndicator.innerHTML = '<i class="fas fa-robot"></i> ' + t('aiSelected');
                    aiIndicator.style.display = 'inline-flex';
                } else {
                    aiIndicator.style.display = 'none';
                }
            }

            document.getElementById('fieldSubtotal').value = fields.subtotal || '';
            document.getElementById('fieldTax').value = fields.tax || '';
            document.getElementById('fieldCurrency').value = fields.currency || 'JPY';

            updateFieldLabels();
            verificationStatus.style.display = 'flex';
            renderOcrDebugPanel(fields, currentQueueId);
            saveLatestAnalysis(currentQueueId, fields);

            if (businessLocationSelect) {
                const inferredLocation = guessLocationFromFields(fields);
                if (inferredLocation) {
                    businessLocationSelect.value = inferredLocation;
                }
            }
        }

        function renderOcrDebugPanel(fields, queueId) {
            if (!ocrDebugPanel || !ocrDebugContent) {
                return;
            }
            const payload = {
                queue_id: queueId || currentQueueId,
                ...fields
            };
            ocrDebugContent.textContent = JSON.stringify(payload, null, 2);
            ocrDebugPanel.style.display = 'block';
        }

        function showResultsTable() {
            populateEditableTable();
            const tableContainer = document.getElementById('dataTableContainer');
            tableContainer.style.display = 'block';
            reviewDataBtn.style.display = 'none';
            if (saveAccumulationBtn) {
                saveAccumulationBtn.disabled = false;
            }
        }

        // Handle review data button
        reviewDataBtn.addEventListener('click', showResultsTable);

        // Populate editable table with OCR data
        function populateEditableTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            // Get current form values
            const fields = {
                date: { value: document.getElementById('fieldDate').value, label: t('dateLabel'), type: 'text' },
                vendor: { value: document.getElementById('fieldVendor').value, label: t('storeNameLabel'), type: 'text' },
                total: { value: document.getElementById('fieldTotal').value, label: t('totalAmountLabel'), type: 'number' },
                invoice_number: { value: document.getElementById('fieldInvoiceNumber').value, label: t('invoiceNumberLabel'), type: 'text' },
                tax_category: { value: document.getElementById('fieldTaxCategory').value, label: t('taxCategoryLabel'), type: 'select' },
                account_title: { value: document.getElementById('fieldAccountTitle').value, label: t('accountTitleLabel'), type: 'select' },
                subtotal: { value: document.getElementById('fieldSubtotal').value, label: t('subtotalRef'), type: 'number' },
                tax: { value: document.getElementById('fieldTax').value, label: t('taxAmountRef'), type: 'number' },
                currency: { value: document.getElementById('fieldCurrency').value, label: t('currency'), type: 'text' }
            };

            // Create table rows
            Object.keys(fields).forEach(fieldKey => {
                const field = fields[fieldKey];
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid var(--medium-gray)';

                // Field name cell
                const fieldCell = document.createElement('td');
                fieldCell.style.padding = '12px';
                fieldCell.style.fontWeight = '600';
                fieldCell.style.color = 'var(--text-dark)';
                fieldCell.textContent = field.label;
                row.appendChild(fieldCell);

                // Value cell
                const valueCell = document.createElement('td');
                valueCell.style.padding = '12px';

                if (field.type === 'select' && fieldKey === 'tax_category') {
                    // Tax category dropdown
                    const select = document.createElement('select');
                    select.className = 'editable-field';
                    select.dataset.field = fieldKey;
                    select.style.width = '100%';
                    select.style.padding = '8px';
                    select.style.border = '1px solid var(--medium-gray)';
                    select.style.borderRadius = '4px';
                    select.style.background = 'white';

                    const taxOptions = [
                        { value: '', text: t('selectTaxCategory') },
                        { value: 'Ê®ôÊ∫ñÁ®éÁéá', text: 'Ê®ôÊ∫ñÁ®éÁéá (Standard Rate)' },
                        { value: 'ËªΩÊ∏õÁ®éÁéá', text: 'ËªΩÊ∏õÁ®éÁéá (Reduced Rate)' },
                        { value: 'ÈùûË™≤Á®é', text: 'ÈùûË™≤Á®é (Tax Exempt)' }
                    ];

                    taxOptions.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option.value;
                        optionElement.textContent = option.text;
                        if (option.value === field.value) {
                            optionElement.selected = true;
                        }
                        select.appendChild(optionElement);
                    });

                    valueCell.appendChild(select);
                } else if (field.type === 'select' && fieldKey === 'account_title') {
                    // Account title dropdown using official classifications
                    const select = document.createElement('select');
                    select.className = 'editable-field';
                    select.dataset.field = fieldKey;
                    select.style.width = '100%';
                    select.style.padding = '8px';
                    select.style.border = '1px solid var(--medium-gray)';
                    select.style.borderRadius = '4px';
                    select.style.background = 'white';

                    // Add default option
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = t('selectAccountTitle');
                    select.appendChild(defaultOption);

                    // Add options from loaded classifications
                    if (accountClassifications.length > 0) {
                        // Add each category as a direct option
                        accountClassifications.forEach(item => {
                            const optionElement = document.createElement('option');
                            optionElement.value = item.category;
                            optionElement.textContent = `${item.category} (${item.description})`;
                            if (item.category === field.value) {
                                optionElement.selected = true;
                            }
                            select.appendChild(optionElement);
                        });
                    } else {
                        // Fallback to basic options if classifications not loaded
                        const accountOptions = [
                            { value: 'ÊóÖË≤ª‰∫§ÈÄöË≤ª', text: 'ÊóÖË≤ª‰∫§ÈÄöË≤ª (Travel & Transportation)' },
                            { value: '‰ªïÂÖ•ÊùêÊñô', text: '‰ªïÂÖ•ÊùêÊñô (Purchased Materials)' },
                            { value: 'ÁèæÂ†¥Èñ¢‰øÇË≤ª', text: 'ÁèæÂ†¥Èñ¢‰øÇË≤ª (Site Related Expenses)' },
                            { value: '‰∫§ÈöõË≤ª', text: '‰∫§ÈöõË≤ª (Entertainment)' },
                            { value: 'ÂéöÁîüË≤ª', text: 'ÂéöÁîüË≤ª (Welfare)' },
                            { value: 'Ê∞¥ÈÅìÂÖâÁÜ±Ë≤ª', text: 'Ê∞¥ÈÅìÂÖâÁÜ±Ë≤ª (Utilities)' },
                            { value: 'ÈÄö‰ø°Ë≤ª', text: 'ÈÄö‰ø°Ë≤ª (Communication)' },
                            { value: 'ÁßüÁ®éÂÖ¨Ë™≤', text: 'ÁßüÁ®éÂÖ¨Ë™≤ (Taxes & Dues)' },
                            { value: '‰∫ãÂãôÊ∂àËÄóÂìÅË≤ª', text: '‰∫ãÂãôÊ∂àËÄóÂìÅË≤ª (Office Supplies)' },
                            { value: 'ÈÅãË≥É', text: 'ÈÅãË≥É (Freight)' },
                            { value: 'Ê∂àËÄóÂìÅ', text: 'Ê∂àËÄóÂìÅ (Consumables)' },
                            { value: 'Ë´∏‰ºöË≤ª', text: 'Ë´∏‰ºöË≤ª (Membership Fees)' },
                            { value: 'Ë´∏ÈõëË≤ª', text: 'Ë´∏ÈõëË≤ª (Miscellaneous)' }
                        ];

                        accountOptions.forEach(option => {
                            const optionElement = document.createElement('option');
                            optionElement.value = option.value;
                            optionElement.textContent = option.text;
                            if (option.value === field.value) {
                                optionElement.selected = true;
                            }
                            select.appendChild(optionElement);
                        });
                    }

                    valueCell.appendChild(select);
                } else {
                    // Regular text input
                    const input = document.createElement('input');
                    input.type = field.type;
                    input.className = 'editable-field';
                    input.dataset.field = fieldKey;
                    input.value = field.value;
                    input.style.width = '100%';
                    input.style.padding = '8px';
                    input.style.border = '1px solid var(--medium-gray)';
                    input.style.borderRadius = '4px';
                    input.style.background = 'white';
                    valueCell.appendChild(input);
                }

                row.appendChild(valueCell);

                // Status cell
                const statusCell = document.createElement('td');
                statusCell.style.padding = '12px';
                statusCell.innerHTML = `<span style="color: var(--primary-blue); font-weight: 500;">${t('ready')}</span>`;
                row.appendChild(statusCell);

                tableBody.appendChild(row);
            });
        }

        // Handle save to HQ button
        document.getElementById('saveAccumulationBtn').addEventListener('click', function() {
            saveToHeadquarters();
        });

        // Handle save changes button
        document.getElementById('saveChangesBtn').addEventListener('click', function() {
            saveChanges();
        });

        // Handle reset button
        resetButton.addEventListener('click', function() {
            resetForm();
        });

        function collectEditableFields() {
            const editableFields = document.querySelectorAll('.editable-field');
            const correctedData = {};
            editableFields.forEach(field => {
                const fieldName = field.dataset.field;
                correctedData[fieldName] = field.value;
            });
            return correctedData;
        }

        function saveToHeadquarters(forceSave = false) {
            if (!currentQueueId) {
                showToast(t('noReceiptData'), 'error');
                return;
            }
            if (!businessLocationSelect || !businessLocationSelect.value) {
                showToast(t('locationRequired'), 'warning');
                businessLocationSelect.focus();
                return;
            }

            const operator = JSON.parse(localStorage.getItem('tashiro_user') || '{}');
            if (!operator.name || !operator.email) {
                showToast(t('operatorMissing'), 'error');
                return;
            }
            const operatorPayload = {
                full_name: operator.name,
                name: operator.name,
                email: operator.email,
                employee_id: operator.employeeId || operator.employee_id || ''
            };

            const correctedData = collectEditableFields();
            Object.keys(correctedData).forEach(fieldName => {
                const elementId = 'field' + fieldName.charAt(0).toUpperCase() + fieldName.slice(1);
                const element = document.getElementById(elementId);
                if (element) {
                    element.value = correctedData[fieldName];
                }
            });

            const locationValue = businessLocationSelect.value;
            const receiptData = {
                ...correctedData,
                business_location: locationValue
            };

            const payload = {
                queue_id: currentQueueId,
                receipt_data: receiptData,
                fields: receiptData,
                business_location: locationValue,
                location: locationValue,
                operator: operatorPayload,
                force: forceSave
            };

            showToast(t('savingReceipt'), 'info');
            fetch('/api/accumulate_receipt', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(async response => {
                const data = await response.json();
                if (response.status === 409 && data.status === 'duplicate') {
                    handleDuplicateResponse(data);
                    throw new Error('duplicate');
                }
                if (!response.ok) {
                    throw new Error(data.detail || 'Save failed');
                }
                handleSuccessfulSave(data, correctedData);
            })
            .catch(error => {
                if (error.message !== 'duplicate') {
                    console.error('Save error:', error);
                    showToast(error.message || t('failedToSubmit'), 'error');
                }
            });
        }

        function handleDuplicateResponse(duplicatePayload) {
            showToast(t('duplicateWarning'), 'warning');
            const userConfirmed = confirm(t('forceSavePrompt'));
            if (userConfirmed) {
                saveToHeadquarters(true);
            }
        }

        function handleSuccessfulSave(apiResult, correctedData) {
            showToast(t('savedReceipt'), 'success');
            if (saveResultMessage) {
                const linkPart = apiResult.download_url ? `<a href="${apiResult.download_url}" target="_blank">${t('downloadWorkbook')}</a>` : '';
                saveResultMessage.innerHTML = `${t('savedToPath', {path: apiResult.filepath || ''})} ${linkPart}`;
                saveResultMessage.style.display = 'block';
            }

            saveToHistory({
                ...correctedData,
                id: currentQueueId,
                timestamp: new Date().toISOString(),
                business_location: businessLocationSelect ? businessLocationSelect.value : ''
            });
        }

        // Save changes from editable table back to form fields
        function saveChanges() {
            const correctedData = collectEditableFields();

            // Update the original form fields with corrected data
            Object.keys(correctedData).forEach(fieldName => {
                const elementId = 'field' + fieldName.charAt(0).toUpperCase() + fieldName.slice(1);
                const element = document.getElementById(elementId);
                if (element) {
                    element.value = correctedData[fieldName];
                }
            });

            // Show success message
            showToast(t('changesSaved'), 'success');

            // Update verification status to show changes were saved
            const verificationStatus = document.getElementById('verificationStatus');
            if (verificationStatus) {
                verificationStatus.innerHTML = `
                    <div class="status-icon">üíæ</div>
                    <div class="status-content">
                        <div class="status-title">${t('changesSaved')}</div>
                        <div class="confidence-badge">${t('readyForHqSave')}</div>
                    </div>
                `;
            }
        }

        // Reset the form
        function resetForm() {
            document.getElementById('fieldDate').value = '';
            document.getElementById('fieldVendor').value = '';
            document.getElementById('fieldTotal').value = '';
            document.getElementById('fieldInvoiceNumber').value = '';
            document.getElementById('fieldTaxCategory').value = '';
            document.getElementById('fieldAccountTitle').value = '';
            document.getElementById('fieldSubtotal').value = '';
            document.getElementById('fieldTax').value = '';
            document.getElementById('fieldCurrency').value = 'JPY';
            
            imagePlaceholder.style.display = 'flex';
            receiptImage.style.display = 'none';
            verificationStatus.style.display = 'none';
            if (ocrDebugPanel) {
                ocrDebugPanel.style.display = 'none';
            }
            if (ocrDebugContent) {
                ocrDebugContent.textContent = '';
            }
            localStorage.removeItem(LATEST_ANALYSIS_KEY);
            
            // Hide AI confidence indicator
            const aiIndicator = document.getElementById('aiConfidenceIndicator');
            if (aiIndicator) {
                aiIndicator.style.display = 'none';
            }
            
            // Disable review data button
            reviewDataBtn.disabled = true;
            
            // Hide table and show review button
            document.getElementById('dataTableContainer').style.display = 'none';
            reviewDataBtn.style.display = 'inline-block';
            if (businessLocationSelect) {
                businessLocationSelect.value = '';
            }
            if (saveResultMessage) {
                saveResultMessage.style.display = 'none';
                saveResultMessage.textContent = '';
            }
            if (saveAccumulationBtn) {
                saveAccumulationBtn.disabled = true;
            }
            updateSaveButtonLabel();
        }

        // Save receipt to history
        function saveToHistory(receiptData) {
            // Get existing history or initialize empty array
            let history = JSON.parse(localStorage.getItem('tashiro_history') || '[]');
            
            // Add new receipt with ID and status
            const receipt = {
                id: receiptData.id || Date.now(),
                ...receiptData,
                status: 'submitted'
            };
            
            // Add to beginning of array
            history.unshift(receipt);
            
            // Keep only last 10 items
            if (history.length > 10) {
                history = history.slice(0, 10);
            }
            
            // Save back to localStorage
            localStorage.setItem('tashiro_history', JSON.stringify(history));
            
            // Update history display
            updateHistoryDisplay();
        }

        // Update history display
        function updateHistoryDisplay() {
            const history = JSON.parse(localStorage.getItem('tashiro_history') || '[]');
            console.log('History items:', history.length, 'Language:', currentLanguage);
            
            if (history.length === 0) {
                const noSubmissionsText = t('noSubmissionsYet');
                const startScanningText = t('startScanning');
                console.log('Empty history texts:', noSubmissionsText, startScanningText);
                historyList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>${noSubmissionsText}</p>
                        <p>${startScanningText}</p>
                    </div>
                `;
                return;
            }
            
            let historyHTML = '';
            
            history.forEach(item => {
                historyHTML += `
                    <div class="history-item">
                        <div class="history-icon">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <div class="history-details">
                            <div class="history-vendor">${item.vendor}</div>
                            <div class="history-meta">
                                <span class="history-date">${formatDate(item.date || item.timestamp)}</span>
                                <span class="history-amount">${item.currency || 'JPY'} ${item.total}</span>
                            </div>
                        </div>
                        <div class="history-actions">
                            <button class="icon-button history-download" onclick="downloadExcel('${item.id}')" title="Download Excel">
                                <i class="fas fa-download"></i>
                            </button>
                            <div class="history-status status-success">${t('submitted')}</div>
                        </div>
                    </div>
                `;
            });
            
            historyList.innerHTML = historyHTML;
        }

        // Format date for display
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('en-US', options);
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            toast.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        // Download Excel function
        function downloadExcel(queueId) {
            showToast(t('preparingDownload'), 'info');
            
            // Find the history item with this queue ID
            const history = JSON.parse(localStorage.getItem('tashiro_history') || '[]');
            const item = history.find(h => h.id == queueId);
            
            if (item && item.excel_url) {
                // Create a temporary link to download the file
                const link = document.createElement('a');
                link.href = item.excel_url;
                link.download = `receipt_${queueId}.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast(t('excelDownloaded'), 'success');
            } else {
                // Fallback: try to regenerate Excel
                fetch('/api/mobile/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        queue_id: queueId,
                        fields: item || {},
                        user: JSON.parse(localStorage.getItem('tashiro_user') || '{}')
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.excel_url) {
                        const link = document.createElement('a');
                        link.href = data.excel_url;
                        link.download = `receipt_${queueId}.xlsx`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        showToast(t('excelDownloaded'), 'success');
                    } else {
                        throw new Error('No Excel URL received');
                    }
                })
                .catch(error => {
                    console.error('Download Error:', error);
                    showToast(t('failedDownload'), 'error');
                });
            }
        }

        // Load settings from localStorage
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('tashiro_settings') || '{}');
            document.getElementById('themeToggle').value = settings.theme || 'light';
            document.getElementById('languageSelect').value = settings.language || 'en';
            document.getElementById('notificationToggle').value = settings.notifications || 'all';
            document.getElementById('autoSaveToggle').value = settings.autoSave || 'enabled';
        }

        // Save settings to localStorage
        function saveSettingsToStorage() {
            const settings = {
                theme: document.getElementById('themeToggle').value,
                language: document.getElementById('languageSelect').value,
                notifications: document.getElementById('notificationToggle').value,
                autoSave: document.getElementById('autoSaveToggle').value
            };
            
            localStorage.setItem('tashiro_settings', JSON.stringify(settings));
            
            // Apply theme and language immediately
            applyTheme(settings.theme);
            applyLanguage(settings.language);
        }

        // Apply theme
        function applyTheme(theme) {
            const root = document.documentElement;
            if (theme === 'dark') {
                root.style.setProperty('--primary-blue', '#4A90E2');
                root.style.setProperty('--text-dark', '#E0E0E0');
                root.style.setProperty('--light-gray', '#2A2A2A');
                root.style.setProperty('--medium-gray', '#404040');
                root.style.setProperty('--dark-gray', '#B0B0B0');
                document.body.style.background = 'linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%)';
            } else {
                // Reset to light theme
                root.style.setProperty('--primary-blue', '#007BFF');
                root.style.setProperty('--text-dark', '#343A40');
                root.style.setProperty('--light-gray', '#F8F9FA');
                root.style.setProperty('--medium-gray', '#E9ECEF');
                root.style.setProperty('--dark-gray', '#6C757D');
                document.body.style.background = 'linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%)';
            }
        }

        // Load account classifications from CSV
        function loadAccountClassifications() {
            fetch('/static/classification_list.csv')
                .then(response => response.text())
                .then(csvText => {
                    const lines = csvText.trim().split('\n');
                    
                    // Skip header lines (first 3 lines are headers)
                    const dataLines = lines.slice(3);
                    
                    accountClassifications = dataLines.map(line => {
                        const parts = line.split(',');
                        if (parts.length >= 2) {
                            return {
                                category: parts[0]?.trim(),
                                subcategory: parts[0]?.trim(), // Use category as subcategory for dropdown
                                description: parts[1]?.trim()
                            };
                        }
                        return null;
                    }).filter(item => item && item.category); // Remove null entries
                    
                    console.log('Loaded', accountClassifications.length, 'account classifications from actual data');
                    console.log('Sample classifications:', accountClassifications.slice(0, 3));
                })
                .catch(error => {
                    console.error('Failed to load account classifications:', error);
                    // Fallback to default classifications if CSV fails to load
                    accountClassifications = [
                        { category: 'ÊóÖË≤ª‰∫§ÈÄöË≤ª', subcategory: 'ÊóÖË≤ª‰∫§ÈÄöË≤ª', description: '„Ç¨„ÇΩ„É™„É≥‰ª£„ÄÅETC‰ª£„ÄÅ‰∫§ÈÄöË≤ª„ÄÅÈßêËªäÊñôÈáë„ÄÅÈ£ü‰∫ã‰ª£ÔºàÂá∫ÂºµÊôÇÔºâ„ÄÅÂÆøÊ≥äË≤ª' },
                        { category: '‰ªïÂÖ•ÊùêÊñô', subcategory: '‰ªïÂÖ•ÊùêÊñô', description: 'Â∑•‰∫ãÂéüÊùêÊñô' },
                        { category: 'ÁèæÂ†¥Èñ¢‰øÇË≤ª', subcategory: 'ÁèæÂ†¥Èñ¢‰øÇË≤ª', description: 'Â∑•ÂÖ∑„ÄÅÁèæÂ†¥ÊïôËÇ≤Á≠â„Å´Èñ¢„Åô„ÇãÁ†î‰øÆ‰ª£„Éª„Éù„Çπ„Çø„ÉºÁ≠â' },
                        { category: '‰∫§ÈöõË≤ª', subcategory: '‰∫§ÈöõË≤ª', description: 'ÂÆ¢ÂÖà„Å®„ÅÆÈ£≤„Åø‰ºö„ÉªÊé•ÂæÖ„Éª„Ç¥„É´„ÉïÁ≠â' },
                        { category: 'ÂéöÁîüË≤ª', subcategory: 'ÂéöÁîüË≤ª', description: 'ÂÅ•Â∫∑Ë®∫Êñ≠Êñô„ÄÅ„Ç§„É≥„Éï„É´„Ç®„É≥„Ç∂„ÉØ„ÇØ„ÉÅ„É≥Êé•Á®Æ„ÄÅÂåªËñ¨ÂìÅË≥ºÂÖ•„ÄÅPCRÊ§úÊüª' },
                        { category: 'Ê∞¥ÈÅìÂÖâÁÜ±Ë≤ª', subcategory: 'Ê∞¥ÈÅìÂÖâÁÜ±Ë≤ª', description: 'ÈõªÊ∞ó‰ª£„ÄÅÊ∞¥ÈÅì‰ª£„ÄÅ„Ç¨„Çπ‰ª£„ÄÅ„Éó„É≠„Éë„É≥‰ª£' },
                        { category: 'ÈÄö‰ø°Ë≤ª', subcategory: 'ÈÄö‰ø°Ë≤ª', description: 'ÈÉµÈÄÅÊñô„ÄÅÂàáÊâã‰ª£' },
                        { category: 'ÁßüÁ®éÂÖ¨Ë™≤', subcategory: 'ÁßüÁ®éÂÖ¨Ë™≤', description: 'Á®éÈáë„ÄÅÂç∞Á¥ô„ÄÅË®ºÁ¥ô' },
                        { category: '‰∫ãÂãôÊ∂àËÄóÂìÅË≤ª', subcategory: '‰∫ãÂãôÊ∂àËÄóÂìÅË≤ª', description: 'ÊñáÊàøÂÖ∑„ÄÅ„Ç≥„Éî„ÉºÁî®Á¥ô„ÄÅPCÈÉ®ÂìÅ„ÉªÂë®Ëæ∫Ê©üÂô®Á≠â' },
                        { category: 'ÈÅãË≥É', subcategory: 'ÈÅãË≥É', description: 'ÂÆÖÈÖç‰æøÁ≠âÈÅãÈÄÅÊñô' },
                        { category: 'Ê∂àËÄóÂìÅ', subcategory: 'Ê∂àËÄóÂìÅ', description: '‰ªïÂÖ•ÊùêÊñô‰ª•Â§ñ„ÅÆÊ∂àËÄóÂìÅ' },
                        { category: 'Ë´∏‰ºöË≤ª', subcategory: 'Ë´∏‰ºöË≤ª', description: '‰ºöË≤ª' },
                        { category: 'Ë´∏ÈõëË≤ª', subcategory: 'Ë´∏ÈõëË≤ª', description: '‰∏äË®ò‰ª•Â§ñÊîØÂá∫„ÄÅÈ£ü‰∫ã‰ª£ÔºàÂá∫Âºµ‰ª•Â§ñÔºâ„ÄÅ„ÅäÊ¶ä‰ª£„ÄÅÊñ∞ËÅû‰ª£' }
                    ];
                });
        }

        // Initialize the application
        function init() {
            if (!checkUserRegistration()) {
                welcomeModal.style.display = 'flex';
            } else {
                appContainer.style.display = 'block';
            }
            
            // Load account classifications
            loadAccountClassifications();
            loadLocationsFromServer();
            
            // Load and apply saved settings
            loadSettings();
            const settings = JSON.parse(localStorage.getItem('tashiro_settings') || '{}');
            applyTheme(settings.theme || 'light');
            applyLanguage(settings.language || 'en');
            
            updateHistoryDisplay();
            restoreLatestAnalysis();

            // Force reapply language after DOM is fully loaded
            setTimeout(() => {
                const currentSettings = JSON.parse(localStorage.getItem('tashiro_settings') || '{}');
                applyLanguage(currentSettings.language || 'en');
            }, 500);

            // Additional delayed update for OCR tips and dynamic elements
            setTimeout(() => {
                const currentSettings = JSON.parse(localStorage.getItem('tashiro_settings') || '{}');
                applyLanguage(currentSettings.language || 'en');
                console.log('Final language update applied for language:', currentSettings.language || 'en');
            }, 1500);
        }

        // Start the application
        init();
    </script>
</body>
</html>