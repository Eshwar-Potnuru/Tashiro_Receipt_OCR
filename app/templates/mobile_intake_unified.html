<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Receipt OCR System - Tashiro Ironworks Co., Ltd.</title>
    <meta name="description" content="Professional receipt OCR automation system for Tashiro Ironworks field operations" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/mobile_intake.css" />
    <style>
        /* Enhanced responsive design overrides */
        @media (max-width: 1024px) {
            .app-shell {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100% !important;
                height: auto !important;
                position: relative !important;
                transform: none !important;
                border-radius: 0 !important;
                margin-bottom: 20px;
            }
            
            .main-panel {
                margin-left: 0 !important;
                padding: 16px;
            }
            
            .workspace-grid {
                grid-template-columns: 1fr !important;
                gap: 16px;
            }
            
            .topbar-actions {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .topbar-actions button,
            .topbar-actions .upload-button {
                min-height: 48px;
                font-size: 16px;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: sticky !important;
                top: 0;
                z-index: 100;
                backdrop-filter: blur(20px);
                border-radius: 0 0 16px 16px;
            }
            
            .sidebar .brand h1 {
                font-size: 18px;
            }
            
            .sidebar .step-list {
                display: none; /* Hide detailed steps on mobile */
            }
            
            .form-row {
                flex-direction: column;
                gap: 12px;
            }
            
            .verification-form input,
            .verification-form select {
                min-height: 48px;
                font-size: 16px;
            }
            
            .history-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
            
            .camera-stage {
                margin: 16px 0;
            }
            
            .video-wrapper {
                border-radius: 12px;
            }
        }
        
        /* Mobile-first touch improvements */
        .mobile-optimized {
            touch-action: manipulation;
        }
        
        .primary-button,
        .secondary-button,
        .upload-button {
            min-height: 48px;
            touch-action: manipulation;
        }
        
        /* Improved mobile dropzone */
        @media (max-width: 768px) {
            .dropzone {
                min-height: 120px;
                padding: 20px;
                border-width: 3px;
            }
        }
        
        /* Better mobile form styling */
        @media (max-width: 768px) {
            .verification-form {
                padding: 16px;
            }
            
            .form-row label {
                margin-bottom: 12px;
            }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }

        .toast {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 12px 16px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            animation: toastSlideIn 0.3s ease-out;
            border-left: 4px solid;
        }

        .toast-success { border-left-color: #10b981; }
        .toast-error { border-left-color: #ef4444; }
        .toast-warning { border-left-color: #f59e0b; }
        .toast-info { border-left-color: #3b82f6; }

        .toast-icon {
            margin-right: 8px;
            font-size: 16px;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            margin-left: 8px;
            color: #6b7280;
        }

        .toast-close:hover {
            color: #374151;
        }

        @keyframes toastSlideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .toast-container {
                left: 10px;
                right: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <!-- Registration Modal -->
    <div id="registrationModal" class="modal">
        <div class="modal-body">
            <h2>Welcome to Tashiro Ironworks</h2>
            <p class="modal-subtitle">Professional Receipt OCR Automation System</p>
            <p class="modal-description">Advanced receipt capture, verification, and submission system for field operations. Register your details to begin processing receipts with AI-powered OCR technology.</p>
            <form id="registrationForm" class="modal-form">
                <label class="modal-field">
                    <span>Name <span class="required">*</span></span>
                    <input id="regName" name="name" type="text" placeholder="Jane Operator" required />
                </label>
                <label class="modal-field">
                    <span>Email <span class="required">*</span></span>
                    <input id="regEmail" name="email" type="email" placeholder="jane@tashiro.co.jp" required />
                </label>
                <label class="modal-field">
                    <span>Employee ID (optional)</span>
                    <input id="regId" name="id" type="text" placeholder="TY-2045" />
                </label>
                <button type="submit" class="primary-button full-width mobile-optimized">Start Capturing</button>
            </form>
        </div>
    </div>

    <!-- Main App Shell -->
    <div class="app-shell">
        <!-- Sidebar with Company Info and Workflow -->
        <aside class="sidebar">
            <div>
                <div class="brand">
                    <span class="brand-mark">TI</span>
                    <div>
                        <h1>Tashiro Ironworks Co., Ltd.</h1>
                        <p>Receipt OCR Automation System</p>
                    </div>
                </div>

                <section class="sidebar-section">
                    <h2>Processing Workflow</h2>
                    <ol class="step-list">
                        <li>üì∏ Take photo using device camera or upload image file</li>
                        <li>ü§ñ AI-powered OCR extracts vendor, amounts, and dates</li>
                        <li>‚úÖ Review and verify extracted data fields</li>
                        <li>üìä Automatic expense categorization and classification</li>
                        <li>üöÄ Submit to HQ approval workflow system</li>
                        <li>üìã Track submission status in history panel</li>
                    </ol>
                </section>

                <section class="sidebar-section sidebar-user">
                    <h2>Current Operator</h2>
                    <div class="user-card">
                        <span id="userInitials" class="avatar">--</span>
                        <div>
                            <p id="sidebarUserName" class="user-name">Guest</p>
                            <p id="sidebarUserEmail" class="muted">‚Äî</p>
                            <p id="sidebarUserId" class="muted">ID: ‚Äî</p>
                        </div>
                    </div>
                    <button id="editProfileButton" type="button" class="ghost-button mobile-optimized" aria-label="Edit profile">Update profile</button>
                </section>
            </div>

            <footer class="sidebar-footer">
                <p><strong>Developed by Eshwar Potnuru</strong></p>
                <p>Tashiro Ironworks Co., Ltd. ¬© 2025</p>
            </footer>
        </aside>

        <!-- Main Content Panel -->
        <div class="main-panel">
            <!-- Top Action Bar -->
            <header class="topbar">
                <div>
                    <h2>Professional OCR Workspace</h2>
                    <p class="topbar-subtitle">AI-powered receipt processing with real-time field extraction and verification</p>
                </div>
                <div class="topbar-actions">
                    <label class="upload-button">
                        <input id="cameraInput" type="file" accept="image/*" capture="environment" style="display: none;" />
                        <span class="primary-button mobile-optimized">üì∏ Take Photo</span>
                    </label>
                    <label class="upload-button">
                        <input id="fileInput" type="file" accept="image/*" />
                        <span class="secondary-button mobile-optimized">üìÅ Upload File</span>
                    </label>
                </div>
            </header>

            <!-- Main Workspace Grid -->
            <section class="workspace-grid">
                <!-- Capture & Upload Section -->
                <article class="card">
                    <header>
                        <h3>Capture Stage</h3>
                        <p>Take a photo with your camera or upload a receipt image file.</p>
                    </header>

                    <div id="dropzone" class="dropzone mobile-optimized" aria-label="Receipt upload area">
                        <span class="dropzone-icon">ÔøΩ</span>
                        <p>Drag &amp; drop a receipt image here</p>
                        <p class="muted">or use the camera/upload buttons above.</p>
                    </div>
                </article>

                <!-- OCR Analysis & Verification Section -->
                <article class="card">
                    <header>
                        <h3>OCR Review</h3>
                        <p>Check the detected fields, make corrections, then submit.</p>
                    </header>

                    <div class="analysis-view">
                        <div class="analysis-canvas">
                            <div id="analysisPlaceholder" class="analysis-placeholder">
                                <p>No receipt analyzed yet.</p>
                                <p class="muted">Capture or upload a receipt to see real-time overlays.</p>
                            </div>
                            <canvas id="analysisCanvas"></canvas>
                            <div id="analysisLoader" class="analysis-loader hidden">
                                <span class="spinner"></span>
                                <p>Analyzing receipt‚Ä¶</p>
                            </div>
                        </div>

                        <form id="verificationForm" class="verification-form">
                            <!-- A-F Field Mapping Header -->
                            <div class="field-mapping-header">
                                <h4>üìã Receipt Field Mapping (A-F)</h4>
                                <p>Verify extracted data matches receipt content</p>
                            </div>
                            
                            <div class="form-row">
                                <label>
                                    <span>A - Date (Êó•‰ªò)</span>
                                    <input id="fieldDate" name="date" type="text" placeholder="YYYY-MM-DD" class="mobile-optimized" />
                                </label>
                                <label>
                                    <span>B - Store Name (Â∫óÂêç)</span>
                                    <input id="fieldVendor" name="vendor" type="text" placeholder="Store name" class="mobile-optimized" />
                                </label>
                            </div>
                            <div class="form-row">
                                <label>
                                    <span>C - Total Amount (ÈáëÈ°ç)</span>
                                    <input id="fieldTotal" name="total" type="text" placeholder="0.00" class="mobile-optimized" />
                                </label>
                                <label>
                                    <span>D - Invoice Number („Ç§„É≥„Éú„Ç§„ÇπÁï™Âè∑)</span>
                                    <input id="fieldInvoiceNumber" name="invoice_number" type="text" placeholder="Invoice/Receipt No." class="mobile-optimized" />
                                </label>
                            </div>
                            <div class="form-row">
                                <label>
                                    <span>E - Tax Category (Á®éÂå∫ÂàÜ)</span>
                                    <select id="fieldTaxCategory" name="tax_category" class="mobile-optimized">
                                        <option value="">Select tax category</option>
                                        <option value="Ë™≤Á®é">Ë™≤Á®é (Taxable)</option>
                                        <option value="ËªΩÊ∏õÁ®éÁéá">ËªΩÊ∏õÁ®éÁéá (Reduced Tax Rate 8%)</option>
                                        <option value="Ê®ôÊ∫ñÁ®éÁéá">Ê®ôÊ∫ñÁ®éÁéá (Standard Tax Rate 10%)</option>
                                        <option value="ÈùûË™≤Á®é">ÈùûË™≤Á®é (Non-taxable)</option>
                                    </select>
                                </label>
                                <label>
                                    <span>F - Account Title (ÂãòÂÆöÁßëÁõÆ)</span>
                                    <select id="fieldAccountTitle" name="account_title" class="mobile-optimized">
                                        <option value="">Select account title</option>
                                        <option value="È£üË≤ª">üçΩÔ∏è È£üË≤ª (Meals)</option>
                                        <option value="‰∫§ÈÄöË≤ª">üöó ‰∫§ÈÄöË≤ª (Transportation)</option>
                                        <option value="ÈÄö‰ø°Ë≤ª">üì± ÈÄö‰ø°Ë≤ª (Communication)</option>
                                        <option value="ÂÆøÊ≥äË≤ª">üè® ÂÆøÊ≥äË≤ª (Accommodation)</option>
                                        <option value="Êé•ÂæÖ‰∫§ÈöõË≤ª">üéâ Êé•ÂæÖ‰∫§ÈöõË≤ª (Entertainment)</option>
                                        <option value="Ê∂àËÄóÂìÅË≤ª">üìé Ê∂àËÄóÂìÅË≤ª (Supplies)</option>
                                        <option value="Ê∞¥ÈÅìÂÖâÁÜ±Ë≤ª">üí° Ê∞¥ÈÅìÂÖâÁÜ±Ë≤ª (Utilities)</option>
                                        <option value="Âú∞‰ª£ÂÆ∂Ë≥É">üè¢ Âú∞‰ª£ÂÆ∂Ë≥É (Rent)</option>
                                        <option value="ÁßüÁ®éÂÖ¨Ë™≤">üèõÔ∏è ÁßüÁ®éÂÖ¨Ë™≤ (Taxes)</option>
                                        <option value="ÊóÖË≤ª‰∫§ÈÄöË≤ª">‚úàÔ∏è ÊóÖË≤ª‰∫§ÈÄöË≤ª (Travel)</option>
                                        <option value="ÂÇôÂìÅË≤ª">üíª ÂÇôÂìÅË≤ª (Equipment)</option>
                                        <option value="‰øÆÁπïË≤ª">üîß ‰øÆÁπïË≤ª (Maintenance)</option>
                                        <option value="Ëªä‰∏°Ë≤ª">‚õΩ Ëªä‰∏°Ë≤ª (Vehicle/Fuel)</option>
                                        <option value="‰øùÈô∫Êñô">üõ°Ô∏è ‰øùÈô∫Êñô (Insurance)</option>
                                        <option value="Á†î‰øÆË≤ª">üìö Á†î‰øÆË≤ª (Education)</option>
                                        <option value="„Åù„ÅÆ‰ªñ">üìã „Åù„ÅÆ‰ªñ (Other)</option>
                                    </select>
                                </label>
                            </div>
                            
                            <!-- Additional Fields for Reference -->
                            <div class="additional-fields" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                                <h5>Additional Information</h5>
                                <div class="form-row">
                                    <label>
                                        <span>Subtotal (ÂèÇËÄÉ)</span>
                                        <input id="fieldSubtotal" name="subtotal" type="text" placeholder="0.00" class="mobile-optimized" />
                                    </label>
                                    <label>
                                        <span>Tax Amount (ÂèÇËÄÉ)</span>
                                        <input id="fieldTax" name="tax" type="text" placeholder="0.00" class="mobile-optimized" />
                                    </label>
                                </div>
                                <label>
                                    <span>Currency</span>
                                    <input id="fieldCurrency" name="currency" type="text" placeholder="JPY" value="JPY" class="mobile-optimized" />
                                </label>
                            </div>

                            <!-- Tashiro Categorization Results -->
                            <div id="categorizationResults" class="categorization-panel" style="display: none;">
                                <h4>ü§ñ AI Categorization Analysis</h4>
                                <div id="primaryCategoryDisplay" class="primary-category-card">
                                    <!-- Primary category will be displayed here -->
                                </div>
                                <div id="taxClassificationDisplay" class="tax-classification">
                                    <!-- Tax classification will be displayed here -->
                                </div>
                                <div id="workflowDataDisplay" class="workflow-data">
                                    <!-- Workflow data will be displayed here -->
                                </div>
                                <details class="alternative-categories">
                                    <summary>Alternative Categories</summary>
                                    <div id="alternativeCategoriesDisplay" class="alternative-list">
                                        <!-- Alternative categories will be displayed here -->
                                    </div>
                                </details>
                            </div>

                            <p id="verificationStatus" class="verification-status"></p>

                            <div class="form-actions">
                                <button id="submitButton" type="submit" class="primary-button mobile-optimized" disabled>Submit to HQ</button>
                                <button id="resetButton" type="button" class="ghost-button mobile-optimized">Start Over</button>
                            </div>
                        </form>
                    </div>
                </article>
            </section>

            <!-- History & Tracking Section -->
            <section class="history-card card">
                <div class="history-header">
                    <div>
                        <h3>Submission History</h3>
                        <p>Keep track of recent uploads, verification status, and exports.</p>
                    </div>
                    <div class="history-actions">
                        <label class="muted" for="historyLimit">Show</label>
                        <select id="historyLimit" class="mobile-optimized">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50" selected>50</option>
                        </select>
                        <button id="refreshHistoryButton" type="button" class="secondary-button mobile-optimized">Refresh</button>
                    </div>
                </div>
                <div id="historyEmpty" class="history-empty">No receipts submitted yet.</div>
                <div id="historyList" class="history-list"></div>
            </section>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <script>
        console.log("Unified Mobile/Desktop interface starting...");
        
        document.addEventListener("DOMContentLoaded", function() {
            console.log("DOM loaded!");
            
            // Handle registration form
            const registrationForm = document.getElementById("registrationForm");
            const registrationModal = document.getElementById("registrationModal");
            
            if (registrationForm) {
                registrationForm.addEventListener("submit", function(e) {
                    e.preventDefault();
                    console.log("Registration form submitted!");
                    
                    const name = document.getElementById("regName").value;
                    const email = document.getElementById("regEmail").value;
                    
                    if (name && email) {
                        // Store user data
                        const userData = {
                            name: name,
                            email: email,
                            id: document.getElementById("regId").value || null
                        };
                        
                        try {
                            localStorage.setItem("tashiro_user_v2", JSON.stringify(userData));
                        } catch (e) {
                            console.warn("LocalStorage not available");
                        }
                        
                        // Update UI
                        document.getElementById("sidebarUserName").textContent = name;
                        document.getElementById("sidebarUserEmail").textContent = email;
                        document.getElementById("userInitials").textContent = name.substring(0, 2).toUpperCase();
                        
                        // Hide modal
                        if (registrationModal) {
                            registrationModal.classList.add("hidden");
                        }
                        
                        alert("Registration successful! You can now use the camera and upload features.");
                    } else {
                        alert("Please fill in name and email.");
                    }
                });
            }
            
            // Handle camera input (native camera app)
            const cameraInput = document.getElementById("cameraInput");
            if (cameraInput) {
                cameraInput.addEventListener("change", function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        handleFileUpload(file, 'camera-capture.jpg');
                    }
                });
            }
            
            // Handle file upload
            const fileInput = document.getElementById("fileInput");
            if (fileInput) {
                fileInput.addEventListener("change", function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        handleFileUpload(file, file.name);
                    }
                });
            }
            
            // Handle drag and drop
            const dropzone = document.getElementById("dropzone");
            if (dropzone) {
                ["dragenter", "dragover"].forEach((eventName) => {
                    dropzone.addEventListener(eventName, (event) => {
                        event.preventDefault();
                        dropzone.classList.add("dragover");
                    });
                });
                ["dragleave", "drop"].forEach((eventName) => {
                    dropzone.addEventListener(eventName, (event) => {
                        event.preventDefault();
                        dropzone.classList.remove("dragover");
                    });
                });
                dropzone.addEventListener("drop", async (event) => {
                    event.preventDefault();
                    const file = event.dataTransfer?.files?.[0];
                    if (file) {
                        handleFileUpload(file, file.name);
                    }
                });
            }
            
            // OCR Analysis Function
            async function handleFileUpload(file, filename) {
                console.log("Processing file:", filename);

                // Detect camera images (from camera input vs file input)
                const isCameraImage = filename.includes('camera-capture') || filename.toLowerCase().includes('camera');
                const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);

                // Show loading with camera-specific message
                const analysisLoader = document.getElementById("analysisLoader");
                const analysisPlaceholder = document.getElementById("analysisPlaceholder");

                if (analysisLoader) {
                    analysisLoader.classList.remove("hidden");
                    // Update loader text for camera images
                    const loaderText = analysisLoader.querySelector('p');
                    if (loaderText) {
                        if (isCameraImage) {
                            loaderText.textContent = 'Enhancing camera image and analyzing receipt‚Ä¶';
                        } else {
                            loaderText.textContent = 'Analyzing receipt‚Ä¶';
                        }
                    }
                }
                if (analysisPlaceholder) {
                    analysisPlaceholder.style.display = 'none';
                }

                try {
                    // Get user data
                    let userData = { name: 'Guest', email: 'guest@example.com' };
                    try {
                        const stored = localStorage.getItem("tashiro_user_v2");
                        if (stored) {
                            userData = JSON.parse(stored);
                        }
                    } catch (e) {
                        console.warn("Could not load user data");
                    }

                    // Prepare form data
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('metadata', JSON.stringify({ user: userData }));

                    // Call OCR API with timeout
                    console.log(`üì§ Sending ${isCameraImage ? 'camera' : 'uploaded'} file to OCR analysis:`, filename, "Size:", fileSizeMB, "MB");

                    // Create new AbortController for this request
                    window.currentAnalysisRequest = new AbortController();

                    const response = await fetch('/api/mobile/analyze', {
                        method: 'POST',
                        body: formData,
                        signal: AbortSignal.timeout(60000) // 60 second timeout
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Server error (${response.status}): ${errorText}`);
                    }

                    const result = await response.json();
                    console.log("üì• OCR Analysis Complete:", result);

                    // Check for backend errors
                    if (result.fields && result.fields.error) {
                        console.warn("Backend reported error:", result.fields.error);
                        // Show warning but continue with any extracted data
                        showToast(`‚ö†Ô∏è OCR partially failed: ${result.fields.error}`, 'warning');
                    }

                    // Check for debug info
                    if (result.fields && result.fields.debug_info) {
                        console.log("üîç Debug info:", result.fields.debug_info);
                        if (result.fields.debug_info.error_type) {
                            showToast(`üîç Debug: ${result.fields.debug_info.error_type}`, 'info');
                        }
                    }

                    // Store queue_id for later submission
                    if (result.queue_id) {
                        window.currentQueueId = result.queue_id;
                        console.log("üîó Stored queue ID:", result.queue_id);
                    }

                    // Hide loading
                    if (analysisLoader) {
                        analysisLoader.classList.add("hidden");
                    }

                    // Display results
                    displayOCRResults(result);

                } catch (error) {
                    console.error("OCR Analysis failed:", error);

                    // Hide loading
                    if (analysisLoader) {
                        analysisLoader.classList.add("hidden");
                    }

                    // Show detailed error message
                    let errorMessage = "Analysis failed: " + error.message;
                    let suggestions = [];

                    if (isCameraImage) {
                        suggestions.push("‚Ä¢ Try taking the photo in better lighting");
                        suggestions.push("‚Ä¢ Hold the camera steadier");
                        suggestions.push("‚Ä¢ Ensure the receipt fills the frame");
                        suggestions.push("‚Ä¢ Try the file upload option instead");
                    } else {
                        suggestions.push("‚Ä¢ Check that the image is clear and well-lit");
                        suggestions.push("‚Ä¢ Ensure the receipt text is readable");
                        suggestions.push("‚Ä¢ Try a different image format");
                    }

                    if (error.message.includes('timeout')) {
                        suggestions.push("‚Ä¢ Image may be too large - try a smaller file");
                    }

                    if (analysisPlaceholder) {
                        analysisPlaceholder.style.display = 'block';
                        analysisPlaceholder.innerHTML = `
                            <div style="text-align: center; color: #dc2626;">
                                <p><strong>‚ùå ${errorMessage}</strong></p>
                                <p style="font-size: 14px; margin-top: 10px;">Suggestions:</p>
                                <ul style="text-align: left; display: inline-block; font-size: 14px;">
                                    ${suggestions.map(s => `<li>${s}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }

                    // Show toast notification
                    showToast(`‚ùå ${errorMessage}`, 'error');

                    // Don't show alert for camera images (too intrusive)
                    if (!isCameraImage) {
                        alert(errorMessage);
                    }
                }
            }
            
            // Display OCR Results
            function displayOCRResults(result) {
                console.log("üîç Displaying OCR results:", result);
                
                // Update form fields (A-F specification)
                if (result.fields) {
                    const fields = result.fields;
                    console.log("üìã Fields to populate:", fields);
                    
                    try {
                        // A - Date
                        const dateValue = fields.date || '';
                        document.getElementById("fieldDate").value = dateValue;
                        console.log("A - Date:", dateValue);
                        
                        // B - Store Name/Vendor
                        const vendorValue = fields.vendor || '';
                        document.getElementById("fieldVendor").value = vendorValue;
                        console.log("B - Store Name:", vendorValue);
                        
                        // C - Total Amount
                        let totalValue = fields.total || '';
                        if (typeof totalValue === 'number') {
                            totalValue = totalValue.toString();
                        }
                        document.getElementById("fieldTotal").value = totalValue;
                        console.log("C - Total Amount:", totalValue);
                        
                        // D - Invoice Number
                        const invoiceValue = fields.invoice_number || '';
                        document.getElementById("fieldInvoiceNumber").value = invoiceValue;
                        console.log("D - Invoice Number:", invoiceValue);
                        
                        // E - Tax Category
                        const taxCategoryValue = fields.tax_category || '';
                        document.getElementById("fieldTaxCategory").value = taxCategoryValue;
                        console.log("E - Tax Category:", taxCategoryValue);
                        
                        // F - Account Title
                        const accountTitleValue = fields.account_title || fields.accounting_items || '';
                        document.getElementById("fieldAccountTitle").value = accountTitleValue;
                        console.log("F - Account Title:", accountTitleValue);
                        
                        // Additional fields
                        const subtotalValue = fields.subtotal || '';
                        document.getElementById("fieldSubtotal").value = subtotalValue;
                        
                        const taxValue = fields.tax || '';
                        document.getElementById("fieldTax").value = taxValue;
                        
                        const currencyValue = fields.currency || 'JPY';
                        document.getElementById("fieldCurrency").value = currencyValue;
                        
                    } catch (error) {
                        console.error("‚ùå Error populating form fields:", error);
                    }
                } else {
                    console.warn("‚ö†Ô∏è No fields object in result:", result);
                }
                
                // Show verification status
                const verificationStatus = document.getElementById("verificationStatus");
                if (verificationStatus && result.verification) {
                    if (result.verification.verified) {
                        verificationStatus.innerHTML = `
                            <div class="status-success">
                                <span class="status-icon">‚úÖ</span>
                                <span>All fields verified successfully!</span>
                                <span class="confidence-badge">High Confidence</span>
                            </div>
                        `;
                        verificationStatus.className = "verification-status success";
                    } else {
                        const issues = result.verification.issues || [];
                        verificationStatus.innerHTML = `
                            <div class="status-warning">
                                <span class="status-icon">‚ö†Ô∏è</span>
                                <span>Issues detected: ${issues.join(", ")}</span>
                                <span class="confidence-badge">Review Required</span>
                            </div>
                        `;
                        verificationStatus.className = "verification-status warning";
                    }
                }
                
                // Enable submit button
                const submitButton = document.getElementById("submitButton");
                if (submitButton) {
                    submitButton.disabled = false;
                }
                
                // Enhanced image display
                if (result.fields && result.fields.source_image) {
                    const analysisCanvas = document.getElementById("analysisCanvas");
                    const analysisPlaceholder = document.getElementById("analysisPlaceholder");
                    
                    if (analysisCanvas && analysisPlaceholder) {
                        const img = new Image();
                        img.onload = function() {
                            const ctx = analysisCanvas.getContext('2d');
                            analysisCanvas.width = img.width;
                            analysisCanvas.height = img.height;
                            
                            // Draw the image
                            ctx.drawImage(img, 0, 0);
                            
                            analysisCanvas.style.display = 'block';
                            analysisPlaceholder.style.display = 'none';
                        };
                        img.src = 'data:image/jpeg;base64,' + result.fields.source_image;
                    }
                }
            }
            
            // Handle other buttons
            const resetButton = document.getElementById("resetButton");
            if (resetButton) {
                resetButton.addEventListener("click", function() {
                    console.log("Start Over button clicked - resetting workspace...");
                    
                    // Clear all form fields
                    try {
                        document.getElementById("fieldDate").value = '';
                        document.getElementById("fieldVendor").value = '';
                        document.getElementById("fieldTotal").value = '';
                        document.getElementById("fieldInvoiceNumber").value = '';
                        document.getElementById("fieldTaxCategory").value = '';
                        document.getElementById("fieldAccountTitle").value = '';
                        document.getElementById("fieldSubtotal").value = '';
                        document.getElementById("fieldTax").value = '';
                        document.getElementById("fieldCurrency").value = 'JPY';
                    } catch (error) {
                        console.error("Error resetting form fields:", error);
                    }
                    
                    // Clear queue ID
                    window.currentQueueId = null;
                    
                    // Reset verification status
                    const verificationStatus = document.getElementById("verificationStatus");
                    if (verificationStatus) {
                        verificationStatus.textContent = '';
                        verificationStatus.className = 'verification-status';
                    }
                    
                    // Reset analysis display
                    const analysisLoader = document.getElementById("analysisLoader");
                    const analysisCanvas = document.getElementById("analysisCanvas");
                    const analysisPlaceholder = document.getElementById("analysisPlaceholder");
                    
                    if (analysisLoader) {
                        analysisLoader.classList.add("hidden");
                    }
                    if (analysisCanvas) {
                        analysisCanvas.style.display = 'none';
                    }
                    if (analysisPlaceholder) {
                        analysisPlaceholder.style.display = 'block';
                        analysisPlaceholder.innerHTML = '<p>No receipt analyzed yet.</p><p class="muted">Capture or upload a receipt to see real-time overlays.</p>';
                    }
                    
                    // Disable submit button
                    const submitButton = document.getElementById("submitButton");
                    if (submitButton) {
                        submitButton.disabled = true;
                    }
                    
                    console.log("‚úÖ Workspace reset complete!");
                });
            }
            
            // Handle verification form submission
            const verificationForm = document.getElementById("verificationForm");
            if (verificationForm) {
                verificationForm.addEventListener("submit", async function(e) {
                    e.preventDefault();
                    console.log("Submitting to HQ...");
                    
                    // Get form data
                    const formData = {
                        date: document.getElementById("fieldDate").value,
                        vendor: document.getElementById("fieldVendor").value,
                        total: parseFloat(document.getElementById("fieldTotal").value) || 0,
                        invoice_number: document.getElementById("fieldInvoiceNumber").value,
                        tax_category: document.getElementById("fieldTaxCategory").value,
                        account_title: document.getElementById("fieldAccountTitle").value,
                        subtotal: parseFloat(document.getElementById("fieldSubtotal").value) || 0,
                        tax: parseFloat(document.getElementById("fieldTax").value) || 0,
                        currency: document.getElementById("fieldCurrency").value
                    };
                    
                    // Get user data
                    let userData = { name: 'Guest', email: 'guest@example.com' };
                    try {
                        const stored = localStorage.getItem("tashiro_user_v2");
                        if (stored) {
                            userData = JSON.parse(stored);
                        }
                    } catch (e) {
                        console.warn("Could not load user data");
                    }
                    
                    try {
                        // Get the current queue_id
                        let queueId = null;
                        if (window.currentQueueId) {
                            queueId = window.currentQueueId;
                        } else {
                            throw new Error("No queue ID available. Please upload and analyze a receipt first.");
                        }
                        
                        const response = await fetch('/api/mobile/submit', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                queue_id: queueId,
                                fields: formData,
                                user: userData
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const result = await response.json();
                        console.log("Submission result:", result);
                        
                        alert("‚úÖ Receipt submitted successfully to HQ!");
                        
                        // Reset the form
                        resetButton.click();
                        
                        // Refresh history
                        refreshHistory();
                        
                    } catch (error) {
                        console.error("Submission failed:", error);
                        alert("‚ùå Submission failed: " + error.message);
                    }
                });
            }
            
            // History functionality
            const refreshHistoryButton = document.getElementById("refreshHistoryButton");
            if (refreshHistoryButton) {
                refreshHistoryButton.addEventListener("click", function() {
                    refreshHistory();
                });
            }
            
            // History refresh function
            async function refreshHistory() {
                console.log("Refreshing history...");
                
                const historyList = document.getElementById("historyList");
                const historyEmpty = document.getElementById("historyEmpty");
                const historyLimit = document.getElementById("historyLimit");
                
                try {
                    const limit = historyLimit ? historyLimit.value : 50;
                    const response = await fetch(`/api/history?limit=${limit}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const history = await response.json();
                    console.log("History data:", history);
                    
                    if (historyList) {
                        historyList.innerHTML = '';
                    }
                    
                    if (!history || history.length === 0) {
                        if (historyEmpty) {
                            historyEmpty.style.display = 'block';
                        }
                        if (historyList) {
                            historyList.style.display = 'none';
                        }
                    } else {
                        if (historyEmpty) {
                            historyEmpty.style.display = 'none';
                        }
                        if (historyList) {
                            historyList.style.display = 'block';
                            
                            history.forEach(entry => {
                                const item = document.createElement("div");
                                item.className = "history-item";
                                
                                item.innerHTML = `
                                    <div class="history-thumbnail">
                                        ${entry.thumbnail_url ? 
                                            `<img src="${entry.thumbnail_url}" alt="Receipt thumbnail" />` : 
                                            '<div class="thumbnail-placeholder">üìÑ</div>'
                                        }
                                    </div>
                                    <div class="history-meta">
                                        <div class="history-title">${entry.vendor || 'Unknown Vendor'}</div>
                                        <div class="history-details">
                                            <span class="amount">${entry.currency || ''} ${entry.total || '0'}</span>
                                            <span class="date">${entry.date || 'No date'}</span>
                                        </div>
                                        <div class="history-status ${entry.verified ? 'success' : 'neutral'}">
                                            ${entry.verified ? 'Verified' : 'Pending'}
                                        </div>
                                        ${entry.excel_url ? 
                                            `<a href="${entry.excel_url}" target="_blank">Download Excel</a>` : 
                                            ''
                                        }
                                    </div>
                                `;
                                
                                historyList.appendChild(item);
                            });
                        }
                    }
                    
                } catch (error) {
                    console.error("Failed to refresh history:", error);
                    if (historyEmpty) {
                        historyEmpty.style.display = 'block';
                        historyEmpty.textContent = 'Failed to load history: ' + error.message;
                    }
                }
            }
            
            // Load history on page load
            refreshHistory();
            
            console.log("All event handlers bound!");
        });

        // Toast notification function
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) return;

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            const icon = type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';

            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;

            toastContainer.appendChild(toast);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>