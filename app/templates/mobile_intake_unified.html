<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Receipt OCR System - Tashiro Ironworks Co., Ltd.</title>
    <meta name="description" content="Professional receipt OCR automation system for Tashiro Ironworks field operations" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/mobile_intake.css" />
    <style>
        /* Reset and base styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            line-height: 1.5;
            color: #6C757D;
            background-color: #F8F9FA;
            min-height: 100vh;
        }

        /* Main container - vertical 5-tile layout */
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 100vh;
        }

        /* Tile base styles */
        .tile {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 16px;
            transition: all 0.3s ease;
        }

        .tile:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }

        /* Specific tile heights */
        .profile-tile { flex: 0 0 15vh; min-height: 120px; }
        .upload-tile { flex: 0 0 20vh; min-height: 160px; }
        .capture-tile { flex: 0 0 10vh; min-height: 80px; }
        .ocr-tile { flex: 0 0 40vh; min-height: 320px; }
        .history-tile { flex: 0 0 25vh; min-height: 200px; }

        /* Button styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 48px;
            touch-action: manipulation;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background-color: #007BFF;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-secondary {
            background-color: transparent;
            color: #007BFF;
            border: 2px solid #007BFF;
        }

        .btn-secondary:hover {
            background-color: #007BFF;
            color: white;
        }

        .btn-success {
            background-color: #28A745;
            color: white;
        }

        .btn-success:hover {
            background-color: #1e7e34;
        }

        .btn-ghost {
            background-color: transparent;
            color: #6C757D;
            border: 1px solid #E9ECEF;
        }

        .btn-ghost:hover {
            background-color: #F8F9FA;
        }

        /* Profile Tile */
        .profile-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 100%;
        }

        .company-info {
            flex: 1;
        }

        .company-info h1 {
            font-size: 24px;
            font-weight: 700;
            color: #212529;
            margin-bottom: 4px;
        }

        .company-info p {
            font-size: 16px;
            color: #6C757D;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: #007BFF;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 18px;
            margin-left: 16px;
        }

        .profile-actions {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .profile-actions .btn {
            font-size: 14px;
            padding: 8px 16px;
            min-height: 36px;
        }

        /* Upload Tile */
        .upload-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
        }

        .upload-buttons {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .upload-helper {
            color: #6C757D;
            font-size: 14px;
        }

        /* Capture Tile */
        .capture-content {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .capture-placeholder {
            text-align: center;
            color: #6C757D;
        }

        .capture-loading {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #F3F4F6;
            border-top: 3px solid #007BFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* OCR Review Tile */
        .ocr-content {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .ocr-header {
            margin-bottom: 16px;
        }

        .ocr-header h3 {
            font-size: 20px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 4px;
        }

        .ocr-header p {
            color: #6C757D;
            font-size: 14px;
        }

        .ocr-fields {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .field-group {
            display: flex;
            flex-direction: column;
        }

        .field-group label {
            font-size: 14px;
            font-weight: 500;
            color: #212529;
            margin-bottom: 4px;
        }

        .field-group input,
        .field-group select {
            padding: 8px 12px;
            border: 1px solid #E9ECEF;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.2s ease;
        }

        .field-group input:focus,
        .field-group select:focus {
            outline: none;
            border-color: #007BFF;
        }

        .ocr-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .ocr-status {
            margin-top: 12px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ocr-status.success {
            background-color: #D4EDDA;
            color: #155724;
            border: 1px solid #C3E6CB;
        }

        .ocr-status.warning {
            background-color: #FFF3CD;
            color: #856404;
            border: 1px solid #FFEAA7;
        }

        /* History Tile */
        .history-content {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .history-header h3 {
            font-size: 20px;
            font-weight: 600;
            color: #212529;
        }

        .history-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .history-controls select {
            padding: 4px 8px;
            border: 1px solid #E9ECEF;
            border-radius: 4px;
            font-size: 14px;
        }

        .history-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            overflow-y: auto;
        }

        .history-item {
            background: #F8F9FA;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .history-thumbnail {
            width: 100%;
            height: 80px;
            background: #E9ECEF;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #6C757D;
        }

        .history-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }

        .history-meta {
            flex: 1;
        }

        .history-title {
            font-weight: 600;
            color: #212529;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .history-details {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #6C757D;
            margin-bottom: 4px;
        }

        .history-status {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 500;
        }

        .history-status.success {
            background-color: #D4EDDA;
            color: #155724;
        }

        .history-status.neutral {
            background-color: #E9ECEF;
            color: #6C757D;
        }

        .history-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6C757D;
            text-align: center;
        }

        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.hidden {
            display: none;
        }

        .modal-body {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .modal h2 {
            font-size: 24px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 8px;
        }

        .modal-subtitle {
            color: #6C757D;
            margin-bottom: 20px;
        }

        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .modal-field label {
            font-weight: 500;
            color: #212529;
            margin-bottom: 4px;
            display: block;
        }

        .modal-field input {
            width: 100%;
            padding: 12px;
            border: 1px solid #E9ECEF;
            border-radius: 6px;
            font-size: 16px;
        }

        .modal-field input:focus {
            outline: none;
            border-color: #007BFF;
        }

        .required {
            color: #DC3545;
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }

        .toast {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 12px 16px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            animation: toastSlideIn 0.3s ease-out;
            border-left: 4px solid;
        }

        .toast-success { border-left-color: #28A745; }
        .toast-error { border-left-color: #DC3545; }
        .toast-warning { border-left-color: #FFC107; }
        .toast-info { border-left-color: #007BFF; }

        .toast-icon {
            margin-right: 8px;
            font-size: 16px;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            margin-left: 8px;
            color: #6b7280;
        }

        .toast-close:hover {
            color: #374151;
        }

        @keyframes toastSlideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .app-container {
                padding: 8px;
                gap: 8px;
            }

            .tile {
                padding: 12px;
            }

            .profile-content {
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }

            .user-avatar {
                margin-left: 0;
            }

            .upload-buttons {
                flex-direction: column;
                width: 100%;
            }

            .upload-buttons .btn {
                width: 100%;
            }

            .ocr-fields {
                grid-template-columns: 1fr;
            }

            .history-grid {
                grid-template-columns: 1fr;
            }

            .history-header {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
        }

        @media (max-width: 480px) {
            .ocr-actions {
                flex-direction: column;
            }

            .ocr-actions .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Profile Update Modal -->
    <div id="profileModal" class="modal hidden">
        <div class="modal-body">
            <h2>Update Profile</h2>
            <p class="modal-subtitle">Update your profile information</p>
            <form id="profileForm" class="modal-form">
                <label class="modal-field">
                    <span>Name <span class="required">*</span></span>
                    <input id="profileName" name="name" type="text" placeholder="Jane Operator" required />
                </label>
                <label class="modal-field">
                    <span>Email <span class="required">*</span></span>
                    <input id="profileEmail" name="email" type="email" placeholder="jane@tashiro.co.jp" required />
                </label>
                <label class="modal-field">
                    <span>Employee ID</span>
                    <input id="profileId" name="id" type="text" placeholder="TY-2045" />
                </label>
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button type="button" id="cancelProfile" class="btn btn-ghost" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Update Profile</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App Container -->
    <div class="app-container">
        <!-- 1. Profile Tile -->
        <div class="tile profile-tile">
            <div class="profile-content">
                <div class="company-info">
                    <h1>Tashiro Ironworks Co., Ltd.</h1>
                    <p>Receipt OCR Automation System</p>
                </div>
                <div class="profile-actions">
                    <div id="userAvatar" class="user-avatar">--</div>
                    <button id="updateProfileBtn" class="btn btn-ghost">Update Profile</button>
                </div>
            </div>
        </div>

        <!-- 2. Upload Tile -->
        <div class="tile upload-tile">
            <div class="upload-content">
                <div class="upload-buttons">
                    <label>
                        <input id="cameraInput" type="file" accept="image/*" capture="environment" style="display: none;" />
                        <span class="btn btn-primary">üì∏ Take Photo</span>
                    </label>
                    <label>
                        <input id="fileInput" type="file" accept="image/*" />
                        <span class="btn btn-secondary">üìÅ Upload File</span>
                    </label>
                </div>
                <p class="upload-helper">Scan your receipt quickly and accurately.</p>
            </div>
        </div>

        <!-- 3. Capture Stage Tile -->
        <div class="tile capture-tile">
            <div class="capture-content">
                <div id="capturePlaceholder" class="capture-placeholder">
                    <p>No active capture</p>
                </div>
                <div id="captureLoading" class="capture-loading hidden">
                    <div class="spinner"></div>
                    <p>Capturing‚Ä¶</p>
                </div>
            </div>
        </div>

        <!-- 4. OCR Review Tile -->
        <div class="tile ocr-tile">
            <div class="ocr-content">
                <div class="ocr-header">
                    <h3>OCR Review</h3>
                    <p>Verify extracted data and make corrections</p>
                </div>

                <form id="verificationForm" class="ocr-fields">
                    <div class="field-group">
                        <label>Store Name (Â∫óÂêç)</label>
                        <input id="fieldVendor" name="vendor" type="text" placeholder="Store name" />
                    </div>
                    <div class="field-group">
                        <label>Date (Êó•‰ªò)</label>
                        <input id="fieldDate" name="date" type="text" placeholder="YYYY-MM-DD" />
                    </div>
                    <div class="field-group">
                        <label>Total Amount (ÈáëÈ°ç)</label>
                        <input id="fieldTotal" name="total" type="text" placeholder="0.00" />
                    </div>
                    <div class="field-group">
                        <label>Invoice Number („Ç§„É≥„Éú„Ç§„ÇπÁï™Âè∑)</label>
                        <input id="fieldInvoiceNumber" name="invoice_number" type="text" placeholder="Invoice/Receipt No." />
                    </div>
                    <div class="field-group">
                        <label>Tax Category (Á®éÂå∫ÂàÜ)</label>
                        <select id="fieldTaxCategory" name="tax_category">
                            <option value="">Select tax category</option>
                            <option value="Ë™≤Á®é">Ë™≤Á®é (Taxable)</option>
                            <option value="ËªΩÊ∏õÁ®éÁéá">ËªΩÊ∏õÁ®éÁéá (Reduced Tax Rate 8%)</option>
                            <option value="Ê®ôÊ∫ñÁ®éÁéá">Ê®ôÊ∫ñÁ®éÁéá (Standard Tax Rate 10%)</option>
                            <option value="ÈùûË™≤Á®é">ÈùûË™≤Á®é (Non-taxable)</option>
                        </select>
                    </div>
                    <div class="field-group">
                        <label>Account Title (ÂãòÂÆöÁßëÁõÆ)</label>
                        <select id="fieldAccountTitle" name="account_title">
                            <option value="">Select account title</option>
                            <option value="È£üË≤ª">üçΩÔ∏è È£üË≤ª (Meals)</option>
                            <option value="‰∫§ÈÄöË≤ª">üöó ‰∫§ÈÄöË≤ª (Transportation)</option>
                            <option value="ÈÄö‰ø°Ë≤ª">üì± ÈÄö‰ø°Ë≤ª (Communication)</option>
                            <option value="ÂÆøÊ≥äË≤ª">üè® ÂÆøÊ≥äË≤ª (Accommodation)</option>
                            <option value="Êé•ÂæÖ‰∫§ÈöõË≤ª">üéâ Êé•ÂæÖ‰∫§ÈöõË≤ª (Entertainment)</option>
                            <option value="Ê∂àËÄóÂìÅË≤ª">üìé Ê∂àËÄóÂìÅË≤ª (Supplies)</option>
                            <option value="Ê∞¥ÈÅìÂÖâÁÜ±Ë≤ª">üí° Ê∞¥ÈÅìÂÖâÁÜ±Ë≤ª (Utilities)</option>
                            <option value="Âú∞‰ª£ÂÆ∂Ë≥É">üè¢ Âú∞‰ª£ÂÆ∂Ë≥É (Rent)</option>
                            <option value="ÁßüÁ®éÂÖ¨Ë™≤">üèõÔ∏è ÁßüÁ®éÂÖ¨Ë™≤ (Taxes)</option>
                            <option value="ÊóÖË≤ª‰∫§ÈÄöË≤ª">‚úàÔ∏è ÊóÖË≤ª‰∫§ÈÄöË≤ª (Travel)</option>
                            <option value="ÂÇôÂìÅË≤ª">üíª ÂÇôÂìÅË≤ª (Equipment)</option>
                            <option value="‰øÆÁπïË≤ª">üîß ‰øÆÁπïË≤ª (Maintenance)</option>
                            <option value="Ëªä‰∏°Ë≤ª">‚õΩ Ëªä‰∏°Ë≤ª (Vehicle/Fuel)</option>
                            <option value="‰øùÈô∫Êñô">üõ°Ô∏è ‰øùÈô∫Êñô (Insurance)</option>
                            <option value="Á†î‰øÆË≤ª">üìö Á†î‰øÆË≤ª (Education)</option>
                            <option value="„Åù„ÅÆ‰ªñ">üìã „Åù„ÅÆ‰ªñ (Other)</option>
                        </select>
                    </div>
                </form>

                <div class="ocr-actions">
                    <button id="reviewEditBtn" class="btn btn-success" disabled>Review & Edit</button>
                    <button id="processAgainBtn" class="btn btn-secondary">Process OCR Again</button>
                    <button id="submitBtn" class="btn btn-primary" disabled>Submit to HQ</button>
                </div>

                <div id="ocrStatus" class="ocr-status hidden">
                    <span id="statusIcon">‚è≥</span>
                    <span id="statusText">Processing receipt...</span>
                </div>
            </div>
        </div>

        <!-- 5. Submission History Tile -->
        <div class="tile history-tile">
            <div class="history-content">
                <div class="history-header">
                    <div>
                        <h3>Submission History</h3>
                        <p>Track your recent submissions</p>
                    </div>
                    <div class="history-controls">
                        <label style="font-size: 14px; color: #6C757D;">Show</label>
                        <select id="historyLimit">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50" selected>50</option>
                        </select>
                        <button id="refreshHistoryBtn" class="btn btn-secondary" style="font-size: 14px; padding: 6px 12px; min-height: 32px;">Refresh</button>
                    </div>
                </div>

                <div id="historyEmpty" class="history-empty">
                    No submissions yet ‚Äî start scanning!
                </div>

                <div id="historyGrid" class="history-grid hidden">
                    <!-- History items will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <script>
        console.log("Professional 5-tile interface starting...");

        document.addEventListener("DOMContentLoaded", function() {
            console.log("DOM loaded!");

            // Load user data on startup
            loadUserData();

            // Profile modal functionality
            const profileModal = document.getElementById("profileModal");
            const updateProfileBtn = document.getElementById("updateProfileBtn");
            const cancelProfileBtn = document.getElementById("cancelProfile");
            const profileForm = document.getElementById("profileForm");

            if (updateProfileBtn) {
                updateProfileBtn.addEventListener("click", function() {
                    // Load current user data into form
                    const stored = localStorage.getItem("tashiro_user_v2");
                    if (stored) {
                        const userData = JSON.parse(stored);
                        document.getElementById("profileName").value = userData.name || '';
                        document.getElementById("profileEmail").value = userData.email || '';
                        document.getElementById("profileId").value = userData.id || '';
                    }
                    profileModal.classList.remove("hidden");
                });
            }

            if (cancelProfileBtn) {
                cancelProfileBtn.addEventListener("click", function() {
                    profileModal.classList.add("hidden");
                });
            }

            if (profileForm) {
                profileForm.addEventListener("submit", function(e) {
                    e.preventDefault();

                    const name = document.getElementById("profileName").value;
                    const email = document.getElementById("profileEmail").value;
                    const id = document.getElementById("profileId").value;

                    if (name && email) {
                        const userData = { name, email, id: id || null };

                        try {
                            localStorage.setItem("tashiro_user_v2", JSON.stringify(userData));
                            updateUserDisplay(userData);
                            profileModal.classList.add("hidden");
                            showToast("Profile updated successfully!", "success");
                        } catch (error) {
                            console.error("Failed to save profile:", error);
                            showToast("Failed to update profile", "error");
                        }
                    } else {
                        showToast("Name and email are required", "warning");
                    }
                });
            }

            // File upload functionality
            const cameraInput = document.getElementById("cameraInput");
            const fileInput = document.getElementById("fileInput");

            if (cameraInput) {
                cameraInput.addEventListener("change", function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        handleFileUpload(file, 'camera-capture.jpg');
                    }
                });
            }

            if (fileInput) {
                fileInput.addEventListener("change", function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        handleFileUpload(file, file.name);
                    }
                });
            }

            // OCR processing function
            async function handleFileUpload(file, filename) {
                console.log("Processing file:", filename);

                // Show capture loading
                showCaptureLoading(true);

                // Detect camera images
                const isCameraImage = filename.includes('camera-capture') || filename.toLowerCase().includes('camera');

                try {
                    // Get user data
                    let userData = { name: 'Guest', email: 'guest@example.com' };
                    try {
                        const stored = localStorage.getItem("tashiro_user_v2");
                        if (stored) {
                            userData = JSON.parse(stored);
                        }
                    } catch (e) {
                        console.warn("Could not load user data");
                    }

                    // Prepare form data
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('metadata', JSON.stringify({ user: userData }));

                    // Update OCR status
                    updateOcrStatus("Analyzing receipt‚Ä¶", "‚è≥");

                    // Call OCR API
                    console.log(`Sending ${isCameraImage ? 'camera' : 'uploaded'} file to OCR analysis:`, filename);

                    const response = await fetch('/api/mobile/analyze', {
                        method: 'POST',
                        body: formData,
                        signal: AbortSignal.timeout(60000)
                    });

                    if (!response.ok) {
                        throw new Error(`Server error (${response.status}): ${await response.text()}`);
                    }

                    const result = await response.json();
                    console.log("OCR Analysis Complete:", result);

                    // Check for errors
                    if (result.fields && result.fields.error) {
                        console.warn("Backend reported error:", result.fields.error);
                        showToast(`‚ö†Ô∏è OCR partially failed: ${result.fields.error}`, 'warning');
                    }

                    // Store queue_id
                    if (result.queue_id) {
                        window.currentQueueId = result.queue_id;
                        console.log("Stored queue ID:", result.queue_id);
                    }

                    // Hide capture loading
                    showCaptureLoading(false);

                    // Display results
                    displayOcrResults(result);

                } catch (error) {
                    console.error("OCR Analysis failed:", error);
                    showCaptureLoading(false);
                    updateOcrStatus("Analysis failed", "‚ùå");
                    showToast(`‚ùå ${error.message}`, 'error');
                }
            }

            // Display OCR results
            function displayOcrResults(result) {
                console.log("Displaying OCR results:", result);

                if (result.fields) {
                    const fields = result.fields;

                    // Populate form fields
                    document.getElementById("fieldVendor").value = fields.vendor || '';
                    document.getElementById("fieldDate").value = fields.date || '';
                    document.getElementById("fieldTotal").value = fields.total || '';
                    document.getElementById("fieldInvoiceNumber").value = fields.invoice_number || '';
                    document.getElementById("fieldTaxCategory").value = fields.tax_category || '';
                    document.getElementById("fieldAccountTitle").value = fields.account_title || '';

                    // Update status
                    updateOcrStatus("OCR completed successfully ‚úì", "‚úÖ", "success");

                    // Enable buttons
                    document.getElementById("reviewEditBtn").disabled = false;
                    document.getElementById("submitBtn").disabled = false;
                }
            }

            // OCR status updates
            function updateOcrStatus(text, icon, type = "") {
                const statusDiv = document.getElementById("ocrStatus");
                const statusIcon = document.getElementById("statusIcon");
                const statusText = document.getElementById("statusText");

                statusIcon.textContent = icon;
                statusText.textContent = text;
                statusDiv.className = `ocr-status ${type}`;
                statusDiv.classList.remove("hidden");
            }

            // Capture loading state
            function showCaptureLoading(show) {
                const placeholder = document.getElementById("capturePlaceholder");
                const loading = document.getElementById("captureLoading");

                if (show) {
                    placeholder.classList.add("hidden");
                    loading.classList.remove("hidden");
                } else {
                    placeholder.classList.remove("hidden");
                    loading.classList.add("hidden");
                }
            }

            // Form submission
            const verificationForm = document.getElementById("verificationForm");
            const submitBtn = document.getElementById("submitBtn");

            if (verificationForm && submitBtn) {
                verificationForm.addEventListener("submit", async function(e) {
                    e.preventDefault();
                    console.log("Submitting to HQ...");

                    // Get form data
                    const formData = {
                        vendor: document.getElementById("fieldVendor").value,
                        date: document.getElementById("fieldDate").value,
                        total: parseFloat(document.getElementById("fieldTotal").value) || 0,
                        invoice_number: document.getElementById("fieldInvoiceNumber").value,
                        tax_category: document.getElementById("fieldTaxCategory").value,
                        account_title: document.getElementById("fieldAccountTitle").value,
                        currency: 'JPY'
                    };

                    // Get user data
                    let userData = { name: 'Guest', email: 'guest@example.com' };
                    try {
                        const stored = localStorage.getItem("tashiro_user_v2");
                        if (stored) {
                            userData = JSON.parse(stored);
                        }
                    } catch (e) {
                        console.warn("Could not load user data");
                    }

                    try {
                        let queueId = window.currentQueueId;
                        if (!queueId) {
                            throw new Error("No queue ID available. Please upload and analyze a receipt first.");
                        }

                        const response = await fetch('/api/mobile/submit', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                queue_id: queueId,
                                fields: formData,
                                user: userData
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const result = await response.json();
                        console.log("Submission result:", result);

                        showToast("‚úÖ Receipt submitted successfully to HQ!", "success");

                        // Reset form
                        resetForm();
                        refreshHistory();

                    } catch (error) {
                        console.error("Submission failed:", error);
                        showToast("‚ùå Submission failed: " + error.message, "error");
                    }
                });
            }

            // Reset form
            function resetForm() {
                document.getElementById("fieldVendor").value = '';
                document.getElementById("fieldDate").value = '';
                document.getElementById("fieldTotal").value = '';
                document.getElementById("fieldInvoiceNumber").value = '';
                document.getElementById("fieldTaxCategory").value = '';
                document.getElementById("fieldAccountTitle").value = '';

                document.getElementById("reviewEditBtn").disabled = true;
                document.getElementById("submitBtn").disabled = true;
                updateOcrStatus("", "", "hidden");

                window.currentQueueId = null;
            }

            // History functionality
            const refreshHistoryBtn = document.getElementById("refreshHistoryBtn");
            const historyLimit = document.getElementById("historyLimit");

            if (refreshHistoryBtn) {
                refreshHistoryBtn.addEventListener("click", refreshHistory);
            }

            async function refreshHistory() {
                console.log("Refreshing history...");

                const historyEmpty = document.getElementById("historyEmpty");
                const historyGrid = document.getElementById("historyGrid");
                const limit = historyLimit ? historyLimit.value : 50;

                try {
                    const response = await fetch(`/api/history?limit=${limit}`);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const history = await response.json();
                    console.log("History data:", history);

                    historyGrid.innerHTML = '';

                    if (!history || history.length === 0) {
                        historyEmpty.classList.remove("hidden");
                        historyGrid.classList.add("hidden");
                    } else {
                        historyEmpty.classList.add("hidden");
                        historyGrid.classList.remove("hidden");

                        history.forEach(entry => {
                            const item = document.createElement("div");
                            item.className = "history-item";

                            item.innerHTML = `
                                <div class="history-thumbnail">
                                    ${entry.thumbnail_url ?
                                        `<img src="${entry.thumbnail_url}" alt="Receipt thumbnail" />` :
                                        'üìÑ'
                                    }
                                </div>
                                <div class="history-meta">
                                    <div class="history-title">${entry.vendor || 'Unknown Vendor'}</div>
                                    <div class="history-details">
                                        <span>¬•${entry.total || '0'}</span>
                                        <span>${entry.date || 'No date'}</span>
                                    </div>
                                    <div class="history-status ${entry.verified ? 'success' : 'neutral'}">
                                        ${entry.verified ? 'Verified' : 'Pending'}
                                    </div>
                                </div>
                            `;

                            historyGrid.appendChild(item);
                        });
                    }

                } catch (error) {
                    console.error("Failed to refresh history:", error);
                    historyEmpty.textContent = 'Failed to load history: ' + error.message;
                    historyEmpty.classList.remove("hidden");
                    historyGrid.classList.add("hidden");
                }
            }

            // Load user data
            function loadUserData() {
                try {
                    const stored = localStorage.getItem("tashiro_user_v2");
                    if (stored) {
                        const userData = JSON.parse(stored);
                        updateUserDisplay(userData);
                    }
                } catch (e) {
                    console.warn("Could not load user data");
                }
            }

            // Update user display
            function updateUserDisplay(userData) {
                const avatar = document.getElementById("userAvatar");
                if (avatar && userData.name) {
                    avatar.textContent = userData.name.substring(0, 2).toUpperCase();
                }
            }

            // Initial history load
            refreshHistory();

            console.log("Professional interface initialized!");
        });

        // Toast notification function
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) return;

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            const icon = type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';

            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;

            toastContainer.appendChild(toast);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>